<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1" />
  <title>Exotix Trade | Professional Trading Platform</title>
  <link rel="icon" href="https://github.com/s42144/exotix-/blob/ce4cd9399ff673963389c393946138254a0edbe5/USDT-Ton-Wallet.png?raw=true" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Monetag SDK - Updated -->
  <script src='//libtl.com/sdk.js' data-zone='10116329' data-sdk='show_10116329'></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase v9 Modular -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root{
      /* New Colorful Professional Color Scheme */
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --dark-bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      --card-bg: rgba(255, 255, 255, 0.08);
      --card-border: rgba(255, 255, 255, 0.15);
      --text-primary: #FFFFFF; 
      --text-secondary: #B8C5D6;
      --accent-blue: #4facfe;
      --accent-green: #43e97b;
      --accent-yellow: #fee140;
      --accent-red: #fa709a;
      --accent-purple: #764ba2;
      --accent-pink: #f093fb;
      --shadow-md: 0 4px 16px rgba(0,0,0,0.3); 
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
      --glow: 0 0 20px rgba(118, 75, 162, 0.5);
      --exv-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --microtask-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      --microtask-highlight: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #fee140 100%);
    }
    html,body{width:100%;height:100%;font-family:'Inter',system-ui,Segoe UI,sans-serif;background:var(--dark-bg);color:var(--text-primary);overflow-x:hidden}
    #app{display:none;min-height:100vh;padding-bottom:80px;background:var(--dark-bg);background-attachment:fixed}
    #main-content{width:100%;max-width:480px;margin:0 auto;padding:0 16px}

    /* Lightning Flash Effect for Buttons */
    @keyframes lightning {
      0% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 30px rgba(118, 75, 162, 0.8); }
      100% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }
    }
    
    .btn-primary, .btn-claim, .nav-btn, .wallet-item, .task-btn, .modal-close, .microtask-btn, .promo-apply-btn, .exv-deposit-submit {
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary::before, .btn-claim::before, .nav-btn::before, .wallet-item::before, .task-btn::before, .modal-close::before, .microtask-btn::before, .promo-apply-btn::before, .exv-deposit-submit::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s;
    }
    
    .btn-primary:hover::before, .btn-claim:hover::before, .nav-btn:hover::before, .wallet-item:hover::before, .task-btn:hover::before, .modal-close:hover::before, .microtask-btn:hover::before, .promo-apply-btn:hover::before, .exv-deposit-submit:hover::before {
      left: 100%;
    }
    
    .btn-primary:hover, .btn-claim:hover, .nav-btn:hover, .wallet-item:hover, .task-btn:hover, .modal-close:hover, .microtask-btn:hover, .promo-apply-btn:hover, .exv-deposit-submit:hover {
      animation: lightning 1.5s infinite;
    }

    /* Loading Screen */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--dark-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .loading-logo {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      margin-bottom: 30px;
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    
    .loading-text {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
      background: var(--secondary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .loading-subtext {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 30px;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-progress {
      margin-top: 20px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    /* Referral Welcome Screen */
    #referral-welcome {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--dark-bg);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 20px;
    }
    
    .welcome-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px 30px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-lg);
      text-align: center;
      max-width: 400px;
      width: 100%;
      animation: slideUp 0.5s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .welcome-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .welcome-title {
      font-size: 28px;
      font-weight: 800;
      background: var(--secondary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 16px;
    }
    
    .welcome-message {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      line-height: 1.6;
    }
    
    .referrer-info {
      background: rgba(118, 75, 162, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(118, 75, 162, 0.2);
    }
    
    .referrer-label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 12px;
    }
    
    .referrer-details {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .referrer-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid var(--accent-purple);
    }
    
    .referrer-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .referrer-id {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .welcome-countdown {
      font-size: 14px;
      color: var(--accent-purple);
      font-weight: 600;
    }

    /* Daily Check In Modal - Enhanced Professional Design */
    #checkin-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      overflow-y: auto;
    }
    
    .checkin-content {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), var(--glow);
      animation: slideUp 0.3s ease;
    }
    
    .checkin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
    }
    
    .checkin-title {
      font-size: 32px;
      font-weight: 800;
      background: var(--secondary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      flex: 1;
    }
    
    .checkin-close {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .checkin-close:hover {
      background: rgba(255,255,255,0.2);
      transform: rotate(90deg);
    }
    
    .checkin-streak {
      text-align: center;
      margin-bottom: 30px;
      padding: 25px;
      background: rgba(118, 75, 162, 0.15);
      border-radius: 20px;
      border: 1px solid rgba(118, 75, 162, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .checkin-streak::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .checkin-streak-title {
      font-size: 18px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }
    
    .checkin-streak-value {
      font-size: 36px;
      font-weight: 800;
      background: var(--warning-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      z-index: 1;
    }
    
    .checkin-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .checkin-day {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px 10px;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      height: 160px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }
    
    .checkin-day.claimed {
      background: rgba(67, 233, 123, 0.15);
      border-color: var(--accent-green);
    }
    
    .checkin-day.available {
      background: rgba(118, 75, 162, 0.2);
      border-color: var(--accent-purple);
      animation: pulse 2s infinite;
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
    }
    
    .checkin-day.available:hover {
      transform: scale(1.08);
      box-shadow: 0 8px 25px rgba(118, 75, 162, 0.4);
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(118, 75, 162, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(118, 75, 162, 0); }
      100% { box-shadow: 0 0 0 0 rgba(118, 75, 162, 0); }
    }
    
    .checkin-day-number {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 5px;
      font-weight: 600;
    }
    
    .checkin-day-reward {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent-green);
      margin-bottom: 10px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    
    .checkin-day:hover .checkin-day-reward,
    .checkin-day.claimed .checkin-day-reward {
      opacity: 1;
      transform: translateY(0);
    }
    
    .checkin-day-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto;
      opacity: 0.7;
      transition: all 0.3s ease;
    }
    
    .checkin-day:hover .checkin-day-icon,
    .checkin-day.claimed .checkin-day-icon {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .checkin-day-status {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .checkin-day-status.claimed {
      background: var(--accent-green);
      color: white;
    }
    
    .checkin-day-status.available {
      background: var(--accent-purple);
      color: white;
    }
    
    .checkin-calendar {
      margin-top: 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid var(--card-border);
    }
    
    .checkin-calendar-title {
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-primary);
    }
    
    .checkin-calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
    }
    
    .calendar-day.checked-in {
      background: rgba(67, 233, 123, 0.2);
      color: var(--accent-green);
      border: 1px solid var(--accent-green);
    }
    
    .calendar-day.today {
      background: rgba(118, 75, 162, 0.2);
      color: var(--accent-purple);
      border: 1px solid var(--accent-purple);
    }

    /* USDT & EXV Balance */
    .balance-container {
      position: fixed;
      top: 12px;
      left: 12px;
      display: flex;
      gap: 8px;
      z-index: 1000;
    }
    
    .usdt-balance, .exv-balance {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 8px 12px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .usdt-icon, .exv-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
    }
    
    .usdt-amount, .exv-amount {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-green);
    }
    
    .exv-amount {
      color: var(--accent-yellow);
    }

    /* Sections */
    .section-header{text-align:center;padding:20px 0 16px}
    .section-title{font-size:24px;font-weight:800;background:var(--secondary-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .section-subtitle{font-size:13px;color:var(--text-secondary)}

    /* Cards */
    .card{background:var(--card-bg);backdrop-filter:blur(20px);border-radius:16px;padding:16px;border:1px solid var(--card-border);box-shadow:var(--shadow-md);margin-bottom:12px}

    /* Buttons with 3D effects */
    .btn-primary,.btn-claim{width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:700;color:#fff;cursor:pointer;transition:.2s;letter-spacing:.3px;position:relative;transform-style:preserve-3d;box-shadow:0 4px 0 rgba(0,0,0,0.2);margin-bottom:8px;}
    .btn-primary{background:var(--secondary-gradient);box-shadow:0 4px 0 rgba(240, 147, 251, 0.5);}
    .btn-primary:active{transform:translateY(4px);box-shadow:0 0 0 rgba(240, 147, 251, 0.5);}
    .btn-primary:disabled{background:rgba(255,255,255,.1);color:rgba(255,255,255,.4);cursor:not-allowed;box-shadow:0 4px 0 rgba(0,0,0,0.2);}
    .btn-claim{background:var(--warning-gradient);color:#fff;animation:glow 2s ease-in-out infinite;box-shadow:0 4px 0 rgba(67, 233, 123, 0.5);}
    .btn-claim:active{transform:translateY(4px);box-shadow:0 0 0 rgba(67, 233, 123, 0.5);}
    @keyframes glow{0%,100%{box-shadow:0 0 10px rgba(67, 233, 123, 0.5)}50%{box-shadow:0 0 20px rgba(67, 233, 123, 0.8)}}

    /* Trade plans */
    .live-prices{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .price-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:12px;text-align:center}
    .price-symbol{font-size:12px;color:var(--text-secondary);font-weight:600}
    .price-value{font-size:16px;font-weight:800;color:var(--accent-green)}
    .price-change{font-size:11px;font-weight:700;margin-top:4px}
    .price-change.positive{color:var(--accent-green)} .price-change.negative{color:var(--accent-red)}
    .plan{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:16px;margin-bottom:12px}
    .plan-h{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .plan-ic{width:48px;height:48px;border-radius:12px;background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:22px}
    .plan-ic img{width:32px;height:32px;border-radius:8px}
    .plan-tt{font-size:16px;font-weight:800}
    .plan-pr{font-size:13px;color:var(--accent-blue);font-weight:700}
    .plan-g{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
    .g-it{background:rgba(255,255,255,.05);border-radius:10px;padding:10px;text-align:center}
    .g-l{font-size:10px;color:var(--text-secondary);font-weight:700;text-transform:uppercase}
    .g-v{font-size:14px;font-weight:800}

    .prog{margin:8px 0}
    .progbar{height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden}
    .progfill{height:100%;background:var(--success-gradient);width:0%}
    .progtext{text-align:center;font-size:11px;color:var(--text-secondary);margin-top:6px}
    .countdown{text-align:center;font-size:12px;color:var(--accent-blue);font-weight:700;margin:8px 0}

    /* Chart Container */
    .chart-container{background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:12px;margin-bottom:12px}
    .chart-title{font-size:13px;font-weight:800;text-align:center;margin-bottom:10px;color:var(--accent-blue)}

    /* Wallet */
    .wallet-options{display:flex;flex-direction:column;gap:12px;margin-bottom:12px}
    .wallet-item{background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:.2s;position:relative;transform-style:preserve-3d;box-shadow:0 4px 0 rgba(0,0,0,0.2);}
    .wallet-item:hover{transform:translateY(-2px);box-shadow:0 6px 0 rgba(0,0,0,0.2);}
    .wallet-item:active{transform:translateY(2px);box-shadow:0 2px 0 rgba(0,0,0,0.2);}
    .wallet-ic{width:32px;height:32px}
    .form-label{font-size:12px;color:var(--text-secondary);font-weight:700;margin-bottom:6px;display:block}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--card-border);background:rgba(255,255,255,.06);color:#fff;outline:none}
    .row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.05);padding:10px;border-radius:10px;margin-bottom:8px;word-break:break-all}
    .copy{background:rgba(255,255,255,.12);border:1px solid var(--card-border);border-radius:8px;padding:6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .copy img{width:16px;height:16px}
    .timer{background:rgba(239,68,68,.12);border:2px solid #ef4444;border-radius:12px;padding:12px;text-align:center;margin-bottom:12px}
    .t-t{color:#ef4444;font-weight:800}

    /* History List */
    .history-list{max-height:300px;overflow-y:auto}
    .history-item{background:rgba(255,255,255,.05);border-radius:10px;padding:12px;margin-bottom:8px}
    .history-header{display:flex;justify-content:space-between;margin-bottom:8px}
    .history-id{font-size:12px;color:var(--text-secondary);font-family:monospace}
    .history-status{font-size:12px;font-weight:700}
    .history-details{display:flex;justify-content:space-between}
    .history-amount{font-weight:700}
    .history-date{font-size:11px;color:var(--text-secondary)}
    .history-extra{font-size:11px;color:var(--text-secondary);margin-top:4px;font-family:monospace;word-break:break-all}

    /* Earn */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
    .stat-box{background:rgba(255,255,255,.05);border:1px solid var(--card-border);border-radius:12px;padding:10px;text-align:center}
    .stat-box-label{font-size:10px;color:var(--text-secondary);font-weight:700;text-transform:uppercase}
    .stat-box-value{font-size:16px;font-weight:800;color:var(--accent-green)}
    .ad-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:16px;margin-bottom:12px;text-align:center}
    .ad-title{font-size:16px;font-weight:800}
    .ad-reward{font-size:12px;color:var(--accent-blue);font-weight:700;margin:6px 0}

    /* Milestone */
    .milestone-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:16px;margin-bottom:12px}
    .milestone-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .milestone-icon{width:48px;height:48px;border-radius:12px;background:var(--primary-gradient);display:flex;align-items:center;justify-content:center}
    .milestone-icon img{width:32px;height:32px}
    .milestone-info{flex:1}
    .milestone-title{font-size:16px;font-weight:800}
    .milestone-reward{font-size:13px;color:var(--accent-green);font-weight:700}
    .milestone-progress{margin:8px 0}
    .milestone-bar{height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden}
    .milestone-fill{height:100%;background:var(--success-gradient);width:0%}
    .milestone-text{text-align:center;font-size:11px;color:var(--text-secondary);margin-top:6px}

    /* Tasks */
    .task-category{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:16px;margin-bottom:12px}
    .category-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .category-icon{width:40px;height:40px;border-radius:10px;background:var(--primary-gradient);display:flex;align-items:center;justify-content:center}
    .category-icon img{width:24px;height:24px}
    .category-title{font-size:16px;font-weight:800}
    .task-card{display:flex;gap:12px;align-items:center;background:rgba(255,255,255,.05);border:1px solid var(--card-border);border-radius:12px;padding:12px;margin-bottom:8px}
    .task-image{width:52px;height:52px;border-radius:10px;object-fit:cover;border:2px solid var(--accent-blue)}
    .task-info{flex:1}
    .task-name{font-size:14px;font-weight:700}
    .task-reward{font-size:12px;color:var(--accent-green);font-weight:800}
    .task-btn{padding:8px 14px;border:none;border-radius:10px;background:var(--success-gradient);color:#fff;font-weight:800;cursor:pointer;position:relative;transform-style:preserve-3d;box-shadow:0 4px 0 rgba(0,0,0,0.2);}
    .task-btn:active{transform:translateY(4px);box-shadow:0 0 0 rgba(0,0,0,0.2);}
    .task-btn.completed{background:rgba(255,255,255,.12);color:rgba(255,255,255,.5);cursor:not-allowed}

    /* Referrals */
    .referral-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:16px;margin-bottom:12px}
    .referral-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .referral-icon{width:40px;height:40px;border-radius:10px;background:var(--primary-gradient);display:flex;align-items:center;justify-content:center}
    .referral-icon img{width:24px;height:24px}
    .referral-title{font-size:16px;font-weight:800}
    .referral-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .referral-stat{background:rgba(255,255,255,.05);border-radius:10px;padding:12px;text-align:center}
    .referral-stat-label{font-size:10px;color:var(--text-secondary);font-weight:700;text-transform:uppercase}
    .referral-stat-value{font-size:16px;font-weight:800;color:var(--accent-green)}
    .referral-item{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.05);border-radius:10px;padding:12px;margin-bottom:8px}
    .referral-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--accent-blue)}
    .referral-info{flex:1}
    .referral-name{font-size:14px;font-weight:700}
    .referral-id{font-size:12px;color:var(--text-secondary)}
    .referral-balance{font-size:14px;font-weight:800;color:var(--accent-green)}
    .referral-commission{font-size:12px;color:var(--accent-blue);font-weight:700}

    /* Ranking */
    .ranking-row{display:flex;align-items:center;gap:10px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:10px;margin-bottom:8px}
    .ranking-position-num{width:36px;height:36px;border-radius:10px;background:var(--primary-gradient);display:flex;align-items:center;justify-content:center;font-weight:800}
    .ranking-position-num.top3{background:var(--secondary-gradient)}
    .ranking-avatar{width:44px;height:44px;border-radius:50%;border:2px solid var(--accent-blue);object-fit:cover}
    .ranking-user-info{flex:1}
    .ranking-user-name{font-size:13px;font-weight:700}
    .ranking-user-id{font-size:11px;color:var(--text-secondary)}
    .ranking-balance{font-size:14px;font-weight:800;color:var(--accent-green)}
    .ranking-position{text-align:center;padding:14px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;margin-bottom:12px}

    /* Notification */
    .notification{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:var(--secondary-gradient);color:#fff;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:800;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:10000}

    /* Nav */
    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:rgba(26, 26, 46, 0.95);backdrop-filter:blur(20px);border-top:1px solid var(--card-border);display:flex;justify-content:space-around;padding:10px 0 8px;z-index:1000;box-shadow:0 -4px 16px rgba(0,0,0,.2)}
    .nav-btn{flex:1;background:none;border:none;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;transition:.2s;padding:8px;border-radius:12px;position:relative;transform-style:preserve-3d;}
    .nav-btn:active{transform:translateY(2px);}
    .nav-icon{width:30px;height:30px;border-radius:10px;filter:grayscale(100%) brightness(.7)}
    .nav-label{font-size:11px;font-weight:700;color:var(--text-secondary)}
    .nav-btn.active .nav-icon{filter:grayscale(0%) brightness(1);box-shadow:0 4px 12px rgba(118, 75, 162, 0.4)}
    .nav-btn.active .nav-label{color:var(--accent-purple)}

    /* Full Screen Modal */
    .fullscreen-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--dark-bg);
      display: none;
      flex-direction: column;
      z-index: 9999;
      overflow-y: auto;
    }
    
    .modal-header {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--card-border);
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 800;
      background: var(--secondary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      transform-style:preserve-3d;
      box-shadow:0 4px 0 rgba(0,0,0,0.2);
    }
    
    .modal-close:active {
      transform: translateY(4px);
      box-shadow:0 0 0 rgba(0,0,0,0.2);
    }
    
    .modal-content {
      flex: 1;
      padding: 20px;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }

    /* Referral List Modal */
    .modal-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(26, 26, 46, 0.8);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
    .modal-content{background:var(--dark-bg);border-radius:24px;padding:24px;max-width:480px;width:100%;max-height:80vh;overflow-y:auto;border:1px solid var(--card-border);box-shadow:var(--shadow-lg);animation:slideUp 0.3s ease}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .modal-title{font-size:24px;font-weight:800;background:var(--secondary-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .modal-close{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:var(--text-primary);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s ease}
    .modal-close:hover{background:rgba(255,255,255,.2)}

    /* Promo Code Section */
    .promo-section {
      background: rgba(118, 75, 162, 0.1);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      border: 1px solid rgba(118, 75, 162, 0.2);
    }
    
    .promo-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--accent-purple);
    }
    
    .promo-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .promo-input {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.06);
      color: #fff;
      outline: none;
    }
    
    .promo-apply-btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      background: var(--accent-purple);
      color: white;
      font-weight: 700;
      cursor: pointer;
      position: relative;
      transform-style:preserve-3d;
      box-shadow:0 4px 0 rgba(0,0,0,0.2);
    }
    
    .promo-apply-btn:active {
      transform: translateY(4px);
      box-shadow:0 0 0 rgba(0,0,0,0.2);
    }
    
    .promo-info {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 6px;
    }
    
    .promo-success {
      color: var(--accent-green);
    }
    
    .promo-error {
      color: var(--accent-red);
    }
    
    .detailed-info {
      background: rgba(118, 75, 162, 0.1);
      border: 1px solid var(--accent-purple);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
    }
    
    .detailed-info-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--accent-purple);
    }
    
    .detailed-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .detailed-info-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .detailed-info-value {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* EXV Token Withdraw Modal */
    #exv-withdraw-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--dark-bg);
      display: none;
      flex-direction: column;
      z-index: 9999;
      overflow-y: auto;
    }
    
    .exv-withdraw-header {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--card-border);
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .exv-withdraw-title {
      font-size: 20px;
      font-weight: 800;
      background: var(--exv-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .exv-withdraw-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      transform-style:preserve-3d;
      box-shadow:0 4px 0 rgba(0,0,0,0.2);
    }
    
    .exv-withdraw-close:active {
      transform: translateY(4px);
      box-shadow:0 0 0 rgba(0,0,0,0.2);
    }
    
    .exv-withdraw-content {
      flex: 1;
      padding: 20px;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }
    
    .exv-balance-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .exv-balance-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .exv-balance-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--accent-yellow);
    }
    
    .exv-balance-usd {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    .exv-withdraw-form {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .exv-withdraw-calculation {
      background: rgba(118, 75, 162, 0.1);
      border: 1px solid rgba(118, 75, 162, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .calculation-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .calculation-label {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .calculation-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .calculation-total {
      border-top: 1px solid var(--card-border);
      padding-top: 8px;
      margin-top: 8px;
    }
    
    .calculation-total .calculation-label {
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .calculation-total .calculation-value {
      color: var(--accent-green);
      font-size: 16px;
    }
    
    .service-fee {
      color: var(--accent-red);
    }

    /* Circle Loading Animation */
    .circle-loader {
      display: inline-block;
      position: relative;
      width: 40px;
      height: 40px;
    }
    
    .circle-loader div {
      box-sizing: border-box;
      display: block;
      position: absolute;
      width: 32px;
      height: 32px;
      margin: 4px;
      border: 4px solid var(--accent-blue);
      border-radius: 50%;
      animation: circle-loader 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
      border-color: var(--accent-blue) transparent transparent transparent;
    }
    
    .circle-loader div:nth-child(1) {
      animation-delay: -0.45s;
    }
    
    .circle-loader div:nth-child(2) {
      animation-delay: -0.3s;
    }
    
    .circle-loader div:nth-child(3) {
      animation-delay: -0.15s;
    }
    
    @keyframes circle-loader {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    /* Micro Tasks Section - Enhanced Professional Design */
    .microtasks-item {
      background: var(--microtask-highlight);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      transform-style: preserve-3d;
      box-shadow: 0 6px 0 rgba(118, 75, 162, 0.4);
      animation: microtaskGlow 2s infinite alternate;
      overflow: hidden;
    }
    
    @keyframes microtaskGlow {
      0% {
        box-shadow: 0 6px 0 rgba(118, 75, 162, 0.4), 0 0 15px rgba(102, 126, 234, 0.5);
      }
      100% {
        box-shadow: 0 8px 0 rgba(240, 147, 251, 0.4), 0 0 25px rgba(240, 147, 251, 0.7);
      }
    }
    
    .microtasks-item:hover {
      transform: translateY(-4px) rotateX(5deg);
      box-shadow: 0 10px 0 rgba(118, 75, 162, 0.4), 0 0 30px rgba(102, 126, 234, 0.7);
    }
    
    .microtasks-item:active {
      transform: translateY(2px) rotateX(2deg);
      box-shadow: 0 3px 0 rgba(118, 75, 162, 0.4);
    }
    
    .microtasks-item::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: rotate(45deg);
      animation: microtaskShine 3s infinite;
    }
    
    @keyframes microtaskShine {
      0% {
        transform: translateX(-100%) translateY(-100%) rotate(45deg);
      }
      100% {
        transform: translateX(100%) translateY(100%) rotate(45deg);
      }
    }
    
    .microtasks-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
    }
    
    .microtasks-text {
      font-size: 18px;
      font-weight: 800;
      color: white;
      position: relative;
      z-index: 1;
    }
    
    /* Micro Tasks Modal Styles */
    .microtasks-header {
      background: var(--microtask-gradient);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    
    .microtasks-title {
      font-size: 22px;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .microtasks-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      transform-style: preserve-3d;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
    }
    
    .microtasks-close:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
    }
    
    .microtasks-back {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      transform-style: preserve-3d;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
    }
    
    .microtasks-back:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
    }
    
    .microtasks-add-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-green);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: absolute;
      right: 16px;
      top: 16px;
      transform-style: preserve-3d;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
    }
    
    .microtasks-add-btn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
    }
    
    .microtasks-admin-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-purple);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: absolute;
      left: 60px;
      top: 16px;
      transform-style: preserve-3d;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
    }
    
    .microtasks-admin-btn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent-red);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
    }
    
    .microtasks-tabs {
      display: flex;
      background: var(--card-bg);
      border-radius: 12px;
      margin: 16px;
      overflow: hidden;
    }
    
    .microtasks-tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .microtasks-tab.active {
      color: white;
      background: var(--microtask-gradient);
    }
    
    .microtasks-content {
      padding: 0 16px 16px;
    }
    
    .microtasks-earnings-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .microtasks-earnings-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .microtasks-earnings-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--accent-yellow);
    }
    
    .microtask-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .microtask-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .microtask-image {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      border: 2px solid var(--accent-blue);
    }
    
    .microtask-info {
      flex: 1;
    }
    
    .microtask-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .microtask-reward {
      font-size: 14px;
      color: var(--accent-yellow);
      font-weight: 700;
    }
    
    .microtask-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--card-border);
    }
    
    .microtask-stat {
      text-align: center;
    }
    
    .microtask-stat-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .microtask-stat-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .microtask-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .microtask-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      transform-style: preserve-3d;
      box-shadow: 0 3px 0 rgba(0, 0, 0, 0.2);
    }
    
    .microtask-btn:active {
      transform: translateY(3px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
    }
    
    .microtask-btn.primary {
      background: var(--accent-green);
      color: white;
    }
    
    .microtask-btn.secondary {
      background: var(--accent-blue);
      color: white;
    }
    
    .microtask-btn.danger {
      background: var(--accent-red);
      color: white;
    }
    
    .microtask-form {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .microtask-form-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      outline: none;
    }
    
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .image-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .image-preview {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      border: 2px dashed var(--card-border);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-preview-placeholder {
      font-size: 40px;
      color: var(--text-secondary);
    }
    
    .image-upload-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: var(--accent-blue);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .fund-info {
      background: rgba(118, 75, 162, 0.1);
      border: 1px solid var(--accent-purple);
      border-radius: 12px;
      padding: 12px;
      margin-top: 16px;
    }
    
    .fund-info-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--accent-purple);
    }
    
    .fund-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    
    .fund-info-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .fund-info-value {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    /* EXV Deposit Modal Styles - Enhanced Professional Design */
    .exv-deposit-header {
      background: var(--exv-gradient);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .exv-deposit-title {
      font-size: 20px;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .exv-deposit-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      transform-style:preserve-3d;
      box-shadow:0 4px 0 rgba(0,0,0,0.2);
    }
    
    .exv-deposit-close:active {
      transform: translateY(4px);
      box-shadow:0 0 0 rgba(0,0,0,0.2);
    }
    
    .exv-deposit-content {
      padding: 20px;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }
    
    .exv-deposit-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .exv-deposit-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(67, 233, 123, 0.1) 0%, rgba(67, 233, 123, 0) 70%);
      animation: rotate 20s linear infinite;
    }
    
    .exv-deposit-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    
    .exv-deposit-qr {
      width: 200px;
      height: 200px;
      border-radius: 12px;
      border: 2px solid var(--accent-yellow);
      margin: 0 auto 16px;
      display: block;
      position: relative;
      z-index: 1;
    }
    
    .exv-deposit-info {
      margin-bottom: 16px;
      position: relative;
      z-index: 1;
    }
    
    .exv-deposit-amount {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .exv-deposit-amount input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      outline: none;
    }
    
    .exv-deposit-amount span {
      font-weight: 700;
      color: var(--accent-yellow);
    }
    
    .exv-deposit-usd {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
      text-align: center;
      padding: 8px;
      background: rgba(67, 233, 123, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(67, 233, 123, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .exv-deposit-submit {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: var(--exv-gradient);
      color: white;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      transform-style: preserve-3d;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
    }
    
    .exv-deposit-submit:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
    }
    
    .exv-deposit-submit:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.4);
      cursor: not-allowed;
    }
    
    /* Task Status Badge */
    .task-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .task-status.pending {
      background: rgba(254, 225, 64, 0.2);
      color: var(--accent-yellow);
      border: 1px solid rgba(254, 225, 64, 0.3);
    }
    
    .task-status.approved {
      background: rgba(67, 233, 123, 0.2);
      color: var(--accent-green);
      border: 1px solid rgba(67, 233, 123, 0.3);
    }
    
    .task-status.rejected {
      background: rgba(250, 112, 154, 0.2);
      color: var(--accent-red);
      border: 1px solid rgba(250, 112, 154, 0.3);
    }
    
    .task-status.submitted {
      background: rgba(79, 172, 254, 0.2);
      color: var(--accent-blue);
      border: 1px solid rgba(79, 172, 254, 0.3);
    }
    
    /* Edit Task Form */
    .edit-task-form {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .edit-task-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
      color: var(--text-primary);
    }
    
    /* Task Stats Chart */
    .task-stats-chart {
      height: 200px;
      margin: 16px 0;
    }
    
    /* Real-time Stats Badge */
    .realtime-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(67, 233, 123, 0.2);
      color: var(--accent-green);
      border: 1px solid var(--accent-green);
      border-radius: 12px;
      padding: 4px 8px;
      font-size: 10px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .realtime-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    /* Progress Ring */
    .progress-ring {
      position: relative;
      width: 60px;
      height: 60px;
    }
    
    .progress-ring svg {
      transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
      fill: none;
      stroke-width: 4;
    }
    
    .progress-ring-bg {
      stroke: rgba(255, 255, 255, 0.1);
    }
    
    .progress-ring-fill {
      stroke: var(--accent-green);
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }
    
    .progress-ring-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    /* Task Completion Animation */
    @keyframes taskComplete {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .task-complete-animation {
      animation: taskComplete 0.5s ease;
    }

    /* Micro Jobs Platform Styles - Enhanced Professional Design */
    .microjobs-hero {
      background: var(--microtask-gradient);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .microjobs-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      animation: rotate 20s linear infinite;
    }
    
    .microjobs-hero-title {
      font-size: 24px;
      font-weight: 800;
      color: white;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }
    
    .microjobs-hero-subtitle {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      position: relative;
      z-index: 1;
    }
    
    .microjobs-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .microjobs-stat-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .microjobs-stat-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--microtask-gradient);
    }
    
    .microjobs-stat-value {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent-yellow);
      margin-bottom: 4px;
    }
    
    .microjobs-stat-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .microjobs-categories {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 8px;
    }
    
    .microjobs-category {
      padding: 8px 16px;
      border-radius: 20px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .microjobs-category.active {
      background: var(--accent-purple);
      color: white;
      border-color: var(--accent-purple);
      transform: scale(1.05);
    }
    
    .microjobs-filter {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .microjobs-search {
      flex: 1;
      padding: 8px 12px;
      border-radius: 20px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      outline: none;
      margin-right: 8px;
    }
    
    .microjobs-sort {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      font-size: 12px;
      font-weight: 700;
    }
    
    .microjobs-task-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .microjobs-task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .microjobs-task-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .microjobs-task-image {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      border: 2px solid var(--accent-blue);
    }
    
    .microjobs-task-info {
      flex: 1;
    }
    
    .microjobs-task-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .microjobs-task-reward {
      font-size: 14px;
      color: var(--accent-yellow);
      font-weight: 700;
    }
    
    .microjobs-task-description {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .microjobs-task-meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .microjobs-task-progress {
      margin-bottom: 12px;
    }
    
    .microjobs-task-progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .microjobs-task-progress-fill {
      height: 100%;
      background: var(--accent-green);
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .microjobs-task-progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    .microjobs-task-actions {
      display: flex;
      gap: 8px;
    }
    
    .microjobs-task-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .microjobs-task-btn.primary {
      background: var(--accent-green);
      color: white;
    }
    
    .microjobs-task-btn.secondary {
      background: var(--accent-blue);
      color: white;
    }
    
    .microjobs-empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .microjobs-empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .microjobs-empty-state-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .microjobs-empty-state-text {
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .microjobs-empty-state-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: var(--accent-purple);
      color: white;
      font-weight: 700;
      cursor: pointer;
    }
    
    /* Task Proof Submission Form */
    .proof-form {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .proof-form-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
      color: var(--text-primary);
    }
    
    .proof-input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      outline: none;
      margin-bottom: 12px;
      min-height: 80px;
      resize: vertical;
    }
    
    .proof-image-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .proof-image-preview {
      width: 150px;
      height: 150px;
      border-radius: 12px;
      border: 2px dashed var(--card-border);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    .proof-image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .proof-image-placeholder {
      font-size: 40px;
      color: var(--text-secondary);
    }
    
    .proof-submit-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: var(--accent-green);
      color: white;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      transform-style: preserve-3d;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
    }
    
    .proof-submit-btn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
    }
    
    /* Task Creator Admin Panel - Enhanced Professional Design */
    .admin-header {
      background: var(--accent-purple);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }
    
    .admin-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      animation: rotate 20s linear infinite;
    }
    
    .admin-title {
      font-size: 20px;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }
    
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 16px;
    }
    
    .admin-stat-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .admin-stat-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--accent-purple);
    }
    
    .admin-stat-value {
      font-size: 18px;
      font-weight: 800;
      color: var(--accent-yellow);
      margin-bottom: 4px;
    }
    
    .admin-stat-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .admin-dashboard {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      margin: 16px;
    }
    
    .admin-dashboard-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
      color: var(--text-primary);
    }
    
    .admin-dashboard-chart {
      height: 200px;
      margin-bottom: 16px;
    }
    
    .admin-dashboard-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .admin-metric-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .admin-metric-value {
      font-size: 16px;
      font-weight: 800;
      color: var(--accent-green);
      margin-bottom: 4px;
    }
    
    .admin-metric-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .admin-task-list {
      padding: 0 16px 16px;
    }
    
    .admin-task-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .admin-task-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .admin-task-image {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      border: 2px solid var(--accent-blue);
    }
    
    .admin-task-info {
      flex: 1;
    }
    
    .admin-task-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .admin-task-reward {
      font-size: 14px;
      color: var(--accent-yellow);
      font-weight: 700;
    }
    
    .admin-task-funds {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .admin-task-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .admin-task-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .admin-task-btn.primary {
      background: var(--accent-green);
      color: white;
    }
    
    .admin-task-btn.secondary {
      background: var(--accent-blue);
      color: white;
    }
    
    .admin-task-btn.danger {
      background: var(--accent-red);
      color: white;
    }
    
    .admin-proof-list {
      padding: 0 16px 16px;
    }
    
    .admin-proof-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .admin-proof-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .admin-proof-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--accent-blue);
    }
    
    .admin-proof-info {
      flex: 1;
    }
    
    .admin-proof-name {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .admin-proof-date {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .admin-proof-content {
      margin-bottom: 12px;
      font-size: 13px;
      color: var(--text-primary);
    }
    
    .admin-proof-image {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .admin-proof-actions {
      display: flex;
      gap: 8px;
    }
    
    .admin-proof-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .admin-proof-btn.approve {
      background: var(--accent-green);
      color: white;
    }
    
    .admin-proof-btn.reject {
      background: var(--accent-red);
      color: white;
    }
    
    .admin-bulk-actions {
      display: flex;
      padding: 0 16px 16px;
      gap: 8px;
    }
    
    .admin-bulk-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .admin-bulk-btn.approve {
      background: var(--accent-green);
      color: white;
    }
    
    .admin-bulk-btn.reject {
      background: var(--accent-red);
      color: white;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .checkbox-container input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .checkbox-container label {
      font-size: 14px;
      color: var(--text-primary);
    }
    
    .admin-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 16px;
    }
    
    .admin-quick-action-btn {
      flex: 1;
      min-width: calc(50% - 4px);
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      color: var(--text-primary);
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .admin-quick-action-btn:hover {
      background: rgba(118, 75, 162, 0.2);
      border-color: var(--accent-purple);
    }
    
    .admin-quick-action-btn img {
      width: 20px;
      height: 20px;
    }
    
    .admin-templates {
      margin: 16px;
    }
    
    .admin-templates-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    
    .admin-template-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .admin-template-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .admin-template-card:hover {
      background: rgba(118, 75, 162, 0.2);
      border-color: var(--accent-purple);
    }
    
    .admin-template-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .admin-template-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .admin-analytics {
      margin: 16px;
    }
    
    .admin-analytics-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    
    .admin-analytics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .admin-analytics-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 12px;
    }
    
    .admin-analytics-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .admin-analytics-value {
      font-size: 16px;
      font-weight: 800;
      color: var(--accent-green);
    }
    
    .admin-filters {
      display: flex;
      gap: 8px;
      margin: 16px;
      flex-wrap: wrap;
    }
    
    .admin-filter-btn {
      padding: 8px 12px;
      border-radius: 20px;
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .admin-filter-btn.active {
      background: var(--accent-purple);
      color: white;
      border-color: var(--accent-purple);
    }
    
    .admin-export {
      margin: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .admin-export-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .admin-export-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: var(--accent-blue);
      color: white;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .admin-export-btn:hover {
      background: var(--accent-purple);
    }

    @media(max-width:360px){
      .live-prices{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen">
    <img src="https://i.postimg.cc/tgp7PgbV/1000015421-removebg-preview.png?raw=true" 
         class="loading-logo" 
         alt="Exotix Trade" />
    <div class="loading-text">Exotix Trade</div>
    <div class="loading-subtext">Initializing your account...</div>
    <div class="loading-spinner"></div>
    <div class="loading-progress" id="loadingProgress">Connecting to Telegram...</div>
  </div>
  
  <!-- Referral Welcome Screen -->
  <div id="referral-welcome">
    <div class="welcome-card">
      <div class="welcome-icon"></div>
      <div class="welcome-title">Welcome!</div>
      <div class="welcome-message">You've been invited to join Exotix Trade</div>
      <div class="referrer-info">
        <div class="referrer-label">Your Referrer</div>
        <div class="referrer-details">
          <img id="referrerAvatar" src="" class="referrer-avatar" alt="Referrer" />
          <div>
            <div class="referrer-name" id="referrerName">Loading...</div>
            <div class="referrer-id" id="referrerId">ID: ...</div>
          </div>
        </div>
      </div>
      <div class="welcome-countdown" id="welcomeCountdown">Starting in 5 seconds...</div>
    </div>
  </div>

  <!-- Daily Check In Modal - Enhanced Professional Design -->
  <div id="checkin-modal">
    <div class="checkin-content">
      <div class="checkin-header">
        <div class="checkin-title">Daily Check In</div>
        <button class="checkin-close" id="closeCheckin"></button>
      </div>
      
      <div class="checkin-streak">
        <div class="checkin-streak-title">Current Streak</div>
        <div class="checkin-streak-value" id="currentStreak">0 days</div>
      </div>
      
      <div class="checkin-days" id="checkinDays">
        <!-- Days will be generated dynamically -->
      </div>
      
      <div class="checkin-calendar">
        <div class="checkin-calendar-title">This Month</div>
        <div class="checkin-calendar-grid" id="checkinCalendar">
          <!-- Calendar will be generated dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- EXV Token Withdraw Modal -->
  <div id="exv-withdraw-modal">
    <div class="exv-withdraw-header">
      <div class="exv-withdraw-title">Withdraw EXV Tokens</div>
      <button class="exv-withdraw-close" id="closeExvWithdraw"></button>
    </div>
    
    <div class="exv-withdraw-content">
      <div class="exv-balance-card">
        <div class="exv-balance-label">Available Balance</div>
        <div class="exv-balance-value" id="exvModalBalance">0 EXV</div>
        <div class="exv-balance-usd" id="exvModalBalanceUsd">$0.00 USD</div>
      </div>
      
      <div class="exv-withdraw-form">
        <label class="form-label">Withdraw Amount (min 25,000 EXV)</label>
        <input id="exvWithdrawAmount" type="number" min="25000" step="1" class="input" placeholder="Enter amount">
        
        <div class="exv-withdraw-calculation">
          <div class="calculation-row">
            <div class="calculation-label">Amount:</div>
            <div class="calculation-value" id="exvAmountDisplay">0 EXV</div>
          </div>
          <div class="calculation-row">
            <div class="calculation-label">Subtotal:</div>
            <div class="calculation-value" id="exvSubtotalDisplay">$0.00</div>
          </div>
          <div class="calculation-row">
            <div class="calculation-label">Service Fee (10%):</div>
            <div class="calculation-value service-fee" id="exvFeeDisplay">$0.00</div>
          </div>
          <div class="calculation-row calculation-total">
            <div class="calculation-label">You Will Receive:</div>
            <div class="calculation-value" id="exvReceiveDisplay">$0.00</div>
          </div>
        </div>
        
        <label class="form-label" style="margin-top: 16px">TON Wallet Address</label>
        <input id="exvWithdrawAddress" class="input" placeholder="Enter your TON wallet address">
        
        <button class="btn-primary" style="margin-top: 16px" id="exvWithdrawBtn">Withdraw</button>
      </div>
    </div>
  </div>

  <!-- Full Screen Modals -->
  <div class="fullscreen-modal" id="deposit-modal">
    <div class="modal-header">
      <div class="modal-title">Deposit USDT</div>
      <button class="modal-close" id="closeDepositModal"></button>
    </div>
    <div class="modal-content" id="deposit-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <div class="fullscreen-modal" id="withdraw-modal">
    <div class="modal-header">
      <div class="modal-title">Withdraw USDT</div>
      <button class="modal-close" id="closeWithdrawModal"></button>
    </div>
    <div class="modal-content" id="withdraw-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <div class="fullscreen-modal" id="checkin-fullscreen-modal">
    <div class="modal-header">
      <div class="modal-title">Daily Check In</div>
      <button class="modal-close" id="closeCheckinFullscreenModal"></button>
    </div>
    <div class="modal-content" id="checkin-fullscreen-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <div class="fullscreen-modal" id="deposit-history-modal">
    <div class="modal-header">
      <div class="modal-title">Deposit History</div>
      <button class="modal-close" id="closeDepositHistoryModal"></button>
    </div>
    <div class="modal-content" id="deposit-history-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <div class="fullscreen-modal" id="withdraw-history-modal">
    <div class="modal-header">
      <div class="modal-title">Withdraw History</div>
      <button class="modal-close" id="closeWithdrawHistoryModal"></button>
    </div>
    <div class="modal-content" id="withdraw-history-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <div class="fullscreen-modal" id="token-withdraw-history-modal">
    <div class="modal-header">
      <div class="modal-title">EXV Deposit/Withdraw History</div>
      <button class="modal-close" id="closeTokenWithdrawHistoryModal"></button>
    </div>
    <div class="modal-content" id="token-withdraw-history-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <div class="fullscreen-modal" id="activities-modal">
    <div class="modal-header">
      <div class="modal-title">Activities</div>
      <button class="modal-close" id="closeActivitiesModal"></button>
    </div>
    <div class="modal-content" id="activities-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <div class="fullscreen-modal" id="trades-modal">
    <div class="modal-header">
      <div class="modal-title">Active Trades</div>
      <button class="modal-close" id="closeTradesModal"></button>
    </div>
    <div class="modal-content" id="trades-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <!-- Micro Tasks Modal -->
  <div class="fullscreen-modal" id="microtasks-modal">
    <div class="microtasks-header">
      <button class="microtasks-back" id="backMicrotasksModal"></button>
      <div class="microtasks-title">Micro Jobs Platform</div>
      <button class="microtasks-close" id="closeMicrotasksModal"></button>
    </div>
    
    <button class="microtasks-admin-btn" id="adminMicrotasksBtn">
      <img src="https://i.postimg.cc/LsFwJ8B7/administrator.png" alt="Admin" style="width: 24px; height: 24px;">
      <div class="notification-badge" id="adminNotificationBadge" style="display: none;">0</div>
    </button>
    
    <button class="microtasks-add-btn" id="addMicrotaskBtn">+</button>
    
    <div class="microtasks-content" id="microtasks-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <!-- Add Micro Task Modal -->
  <div class="fullscreen-modal" id="add-microtask-modal">
    <div class="modal-header">
      <div class="modal-title">Create New Task</div>
      <button class="modal-close" id="closeAddMicrotaskModal"></button>
    </div>
    <div class="modal-content" id="add-microtask-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <!-- Edit Micro Task Modal -->
  <div class="fullscreen-modal" id="edit-microtask-modal">
    <div class="modal-header">
      <div class="modal-title">Edit Task</div>
      <button class="modal-close" id="closeEditMicrotaskModal"></button>
    </div>
    <div class="modal-content" id="edit-microtask-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <!-- Task Proof Submission Modal -->
  <div class="fullscreen-modal" id="proof-modal">
    <div class="modal-header">
      <div class="modal-title">Submit Task Proof</div>
      <button class="modal-close" id="closeProofModal"></button>
    </div>
    <div class="modal-content" id="proof-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <!-- Task Creator Admin Modal -->
  <div class="fullscreen-modal" id="admin-modal">
    <div class="admin-header">
      <div class="admin-title">Task Creator Admin</div>
      <button class="modal-close" id="closeAdminModal"></button>
    </div>
    <div class="modal-content" id="admin-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <!-- EXV Deposit Modal -->
  <div class="fullscreen-modal" id="exv-deposit-modal">
    <div class="exv-deposit-header">
      <div class="exv-deposit-title">Deposit EXV Tokens</div>
      <button class="exv-deposit-close" id="closeExvDepositModal"></button>
    </div>
    <div class="exv-deposit-content" id="exv-deposit-content">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <!-- App -->
  <div id="app">
    <div class="balance-container">
      <div class="usdt-balance">
        <img src="https://github.com/s42144/exotix-/blob/ce4cd9399ff673963389c393946138254a0edbe5/USDT-Ton-Wallet.png?raw=true" class="usdt-icon" alt="USDT" />
        <div class="usdt-amount" id="usdtBalance">0.000000</div>
      </div>
      <div class="exv-balance">
        <img src="https://i.postimg.cc/C5m9vmnK/1000014663-removebg-preview.png" class="exv-icon" alt="EXV" />
        <div class="exv-amount" id="exvBalance">0</div>
      </div>
    </div>
    <div id="main-content"></div>

    <!-- Navigation Bar -->
    <div class="nav-bar">
      <button class="nav-btn active" data-tab="home">
        <img src="https://github.com/s42144/exotix-/blob/a6f0bd9d344b079353eb2e08b519ce962b4eb039/stock-market.gif?raw=true" alt="Trade Plans" class="nav-icon" />
        <span class="nav-label">Trade Plans</span>
      </button>
      <button class="nav-btn" data-tab="wallet">
        <img src="https://github.com/s42144/exotix-/blob/6391218cdf0b97d4625f423ee0e8382830d35b41/wallet.gif?raw=true" alt="Wallet" class="nav-icon" />
        <span class="nav-label">Wallet</span>
      </button>
      <button class="nav-btn" data-tab="earn">
        <img src="https://github.com/s42144/exotix-/blob/0dba281e8e48a28e069a32e0f6bb1bdbe09fc7b2/business-finance%20(1).gif?raw=true" alt="Earn" class="nav-icon" />
        <span class="nav-label">Earn</span>
      </button>
      <button class="nav-btn" data-tab="profile">
        <img src="https://github.com/s42144/exotix-/blob/e7c54b805823ed9054cbe83f50084e5f2f26acb3/user.gif?raw=true" alt="Profile" class="nav-icon" />
        <span class="nav-label">Profile</span>
      </button>
      <button class="nav-btn" data-tab="ranking">
        <img src="https://github.com/s42144/exotix-/blob/3fb3010e094cf075c42c98a61be103194ea758fc/chevron.gif?raw=true" alt="Ranking" class="nav-icon" />
        <span class="nav-label">Ranking</span>
      </button>
    </div>
  </div>

  <!-- Referral List Modal -->
  <div class="modal-overlay" id="referralModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">My Referrals</div>
        <button class="modal-close" id="closeReferralModal"></button>
      </div>
      <div id="referralListContent"></div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBfR97veh6idxb81mH6N5_Gq8-CpW2D7bE",
      authDomain: "jbhigfi.firebaseapp.com",
      databaseURL: "https://jbhigfi-default-rtdb.firebaseio.com",
      projectId: "jbhigfi",
      storageBucket: "jbhigfi.firebasestorage.app",
      messagingSenderId: "736760492095",
      appId: "1:736760492095:web:47b94412495e21c561c88a",
      measurementId: "G-ZZMHC9RTVT"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Telegram WebApp Initialization
    const tg = window.Telegram?.WebApp || { expand:()=>{}, ready:()=>{}, initDataUnsafe:{} };
    tg.expand(); tg.ready();

    // Bot
    const BOT_TOKEN = '8332448822:AAHKhDvougBhBThL6aBl3hGjZbKFGAq7BUs';
    
    // Enhanced sendBot function with inline buttons
    const sendBot = async (msg, chatId = null, inlineButtons = null) => {
      try {
        const targetChatId = chatId || userId;
        const payload = {
          chat_id: targetChatId,
          text: msg,
          parse_mode: 'HTML'
        };
        
        // Add inline keyboard if buttons are provided
        if (inlineButtons && inlineButtons.length > 0) {
          payload.reply_markup = {
            inline_keyboard: [inlineButtons]
          };
        }
        
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (e) { 
        console.warn('Bot send failed', e); 
      }
    };

    // Send welcome message with inline buttons
    const sendWelcomeMessage = (chatId) => {
      const welcomeText = ` <b>Welcome to Exotix Trade!</b>\\n\\nYour account has been successfully created. Start your trading journey with us and earn daily rewards!`;
      
      const inlineButtons = [
        { text: "Join Announcement Channel", url: "https://t.me/exotix_Ann" },
        { text: "Join Chatting Group", url: "https://t.me/exotix_chat" },
        { text: "Send Message to Claim $15 for Free", url: "https://t.me/GlowOps" }
      ];
      
      sendBot(welcomeText, chatId, inlineButtons);
    };

    // State
    let userId=null, userName=null, userAvatar=null;
    let userData=null;
    let usdtBalance=0;
    let exvBalance=0;
    let purchasedPlans={};
    let activeTrades={};
    let depositHistory=[];
    let withdrawHistory=[];
    let tokenWithdrawHistory=[]; // New state for EXV token withdrawals
    let tradeHistory=[];
    let cryptoPrices={};
    let rankingListener=null;
    let adLoading=false;
    let pendingTaskRewards={};
    let referralListener=null;
    let referralCount = 0;
    let totalReferralCommission = 0;
    let lastCommissionNotification = 0; // Track last commission notification time
    let appliedPromoCode = null;
    let promoBonus = 0;
    let checkInData = {
      lastCheckIn: 0,
      currentStreak: 0,
      claimedDays: [],
      monthlyCheckIns: {}
    };
    let imageResources = {}; // Store image URLs from Firebase
    let microtasks = {}; // Store microtasks
    let myMicrotasks = {}; // Store user's microtasks
    let microtaskEarnings = 0; // Total earnings from microtasks
    let exvDepositHistory = []; // EXV deposit history
    let userTaskCount = 0; // Track user's task count
    let currentEditingTaskId = null; // Track current editing task ID
    let microtaskCategories = ['All', 'Social Media', 'Surveys', 'App Downloads', 'Videos', 'Games', 'Other'];
    let activeMicrotaskCategory = 'All';
    let microtaskSearchTerm = '';
    let microtaskSortBy = 'newest'; // newest, oldest, reward_low, reward_high, popularity
    let taskProofs = {}; // Store task proofs
    let submittedTasks = {}; // Store submitted tasks by user
    let adminNotifications = 0; // Count of admin notifications

    // EXV Token Price
    const EXV_TOKEN_PRICE = 0.00000212; // $0.00000212 per EXV token

    // Utils
    const now = () => Math.floor(Date.now()/1000);
    const fmt = (n)=> Number(n||0).toFixed(6);
    const notify = (m, d=2200) => { 
      const n=document.createElement('div'); 
      n.className='notification'; 
      n.textContent=m; 
      document.body.appendChild(n); 
      setTimeout(()=>n.remove(), d); 
    };
    const copy = (t)=> navigator.clipboard.writeText(t).then(()=>notify('Copied!'));
    const generateId = () => 'TXN' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();

    // Update Loading Progress
    function updateLoadingProgress(text) {
      const progressEl = document.getElementById('loadingProgress');
      if (progressEl) {
        progressEl.textContent = text;
      }
    }

    // Load image resources from Firebase
    function loadImageResources() {
      database.ref('admin/imageResources').once('value').then(snapshot => {
        if (snapshot.exists()) {
          imageResources = snapshot.val();
          console.log('Image resources loaded:', imageResources);
        }
      }).catch(error => {
        console.error('Error loading image resources:', error);
      });
    }

    // Get image URL with fallback
    function getImageUrl(imageKey, fallbackUrl) {
      return imageResources[imageKey] || fallbackUrl;
    }

    // Telegram User
    function getTelegramUserData() {
      updateLoadingProgress('Getting Telegram user data...');
      
      const u = tg?.initDataUnsafe?.user;
      if (u?.id) {
        userId = String(u.id);
        userName = u.first_name + (u.last_name ? (' ' + u.last_name) : '');
        userAvatar = u.photo_url || "https://cdn-icons-png.flaticon.com/512/1077/1077114.png";
        return true;
      }
      // Fallback outside Telegram
      userId = 'test_' + Math.floor(10000 + Math.random()*89999);
      userName = 'Test User';
      userAvatar = "https://cdn-icons-png.flaticon.com/512/1077/1077114.png";
      return true;
    }

    // Process Referral
    function processReferral() {
      return new Promise((resolve) => {
        updateLoadingProgress('Processing referral...');
        
        const startParam = tg.initDataUnsafe?.start_param;
        console.log('Start Param:', startParam);
        
        if (startParam) {
          let referrerId = startParam;
          
          console.log('Referrer ID:', referrerId);
          console.log('Current User ID:', userId);
          
          if (referrerId && referrerId !== userId) {
            database.ref('users/' + userId + '/referredBy').once('value').then(snap => {
              if (!snap.exists()) {
                console.log('Processing new referral...');
                
                database.ref('users/' + referrerId).once('value').then(refSnap => {
                  if (refSnap.exists()) {
                    console.log('Referrer found in database');
                    
                    showReferralWelcome(referrerId).then(() => {
                      const referrerData = refSnap.val();
                      const newBalance = (referrerData.usdtBalance || 0) + 0.20;
                      
                      // Update referrer balance
                      database.ref('users/' + referrerId).update({
                        usdtBalance: newBalance,
                        totalReferralCommission: (referrerData.totalReferralCommission || 0) + 0.20,
                        lastUpdated: now()
                      }).then(() => {
                        console.log('Referrer balance updated to:', newBalance);
                        
                        // Update referral commissions tracking
                        const referralCommissions = referrerData.referralCommissions || {};
                        referralCommissions[userId] = (referralCommissions[userId] || 0) + 0.20;
                        
                        database.ref('users/' + referrerId + '/referralCommissions').set(referralCommissions);
                        
                        // Log the referral transaction
                        database.ref('admin/referralLog').push({
                          referrerId: referrerId,
                          referrerName: referrerData.name || 'Unknown',
                          referredUserId: userId,
                          referredUserName: userName,
                          timestamp: now(),
                          reward: 0.20
                        });
                      });
                      
                      // Save referral info for new user
                      database.ref('users/' + userId).update({
                        referredBy: referrerId,
                        referredAt: now()
                      }).then(() => {
                        console.log('Referral link saved for user');
                        
                        // Send notification to referrer with updated message
                        sendBot(` <b>New Referral Join!</b>\\n${userName} joined using your referral link.\\n$0.20 earned!`, referrerId);
                        
                        notify('Welcome! Your referrer earned $0.20 USDT!', 3000);
                        resolve();
                      });
                    });
                  } else {
                    console.log('Referrer not found in database');
                    resolve();
                  }
                });
              } else {
                console.log('User was already referred by:', snap.val());
                resolve();
              }
            });
          } else {
            resolve();
          }
        } else {
          console.log('No referral parameter found');
          resolve();
        }
      });
    }

    // Show Referral Welcome Screen
    function showReferralWelcome(referrerId) {
      return new Promise((resolve) => {
        database.ref('users/' + referrerId).once('value').then(snap => {
          if (snap.exists()) {
            const referrerData = snap.val();
            
            document.getElementById('referrerAvatar').src = referrerData.avatar || userAvatar;
            document.getElementById('referrerName').textContent = referrerData.name || 'Unknown';
            document.getElementById('referrerId').textContent = 'ID: ' + referrerId;
            
            document.getElementById('referral-welcome').style.display = 'flex';
            
            let countdown = 5;
            const countdownEl = document.getElementById('welcomeCountdown');
            
            const countdownInterval = setInterval(() => {
              countdown--;
              if (countdown > 0) {
                countdownEl.textContent = `Starting in ${countdown} seconds...`;
              } else {
                clearInterval(countdownInterval);
                document.getElementById('referral-welcome').style.display = 'none';
                resolve();
              }
            }, 1000);
          } else {
            resolve();
          }
        });
      });
    }

    // Award Referral Commission - Fixed to add to main balance
    function awardReferralCommission(earnedAmount) {
      if (!userData.referredBy) {
        console.log('No referrer for this user');
        return;
      }
      
      const commission = earnedAmount * 0.2; // 20% commission
      const referrerId = userData.referredBy;
      
      console.log(`Awarding ${commission} USDT commission to referrer ${referrerId} for ${earnedAmount} USDT earned`);
      
      // Get referrer data and update balance directly
      database.ref('users/' + referrerId).once('value').then(refSnap => {
        if (refSnap.exists()) {
          const referrerData = refSnap.val();
          const newBalance = (referrerData.usdtBalance || 0) + commission;
          const newTotalCommission = (referrerData.totalReferralCommission || 0) + commission;
          
          // Update referrer's balance and commission tracking
          database.ref('users/' + referrerId).update({
            usdtBalance: newBalance,
            totalReferralCommission: newTotalCommission,
            lastUpdated: now()
          });
          
          // Update commission tracking for this specific referral
          const referralCommissions = referrerData.referralCommissions || {};
          referralCommissions[userId] = (referralCommissions[userId] || 0) + commission;
          
          database.ref('users/' + referrerId + '/referralCommissions').set(referralCommissions);
          
          // Log the commission transaction
          database.ref('admin/commissionLog').push({
            referrerId: referrerId,
            referrerName: referrerData.name || 'Unknown',
            referredUserId: userId,
            referredUserName: userName,
            amount: commission,
            earnedAmount: earnedAmount,
            timestamp: now(),
            type: 'earning_commission'
          });
          
          // No longer sending individual commission notifications
          // These will be sent in a consolidated report every 24 hours
        }
      });
    }

    // Send Daily Commission Report
    function sendDailyCommissionReport() {
      database.ref('users').once('value').then(snapshot => {
        if (snapshot.exists()) {
          const users = snapshot.val();
          const reportData = [];
          
          // Collect all users with referral commissions
          Object.keys(users).forEach(userId => {
            const user = users[userId];
            if (user.totalReferralCommission && user.totalReferralCommission > 0) {
              reportData.push({
                userId: userId,
                userName: user.name || 'Unknown',
                totalCommission: user.totalReferralCommission,
                referralCount: Object.keys(user.referralCommissions || {}).length
              });
            }
          });
          
          // Sort by total commission (highest first)
          reportData.sort((a, b) => b.totalCommission - a.totalCommission);
          
          // Format the report
          let reportText = ` <b>Daily Referral Commission Report</b>\\n\\n`;
          reportText += ` Top Earners:\\n`;
          
          // Show top 10 earners
          const topEarners = reportData.slice(0, 10);
          topEarners.forEach((user, index) => {
            reportText += `${index + 1}. ${user.userName} - $${fmt(user.totalCommission)} (${user.referralCount} referrals)\\n`;
          });
          
          reportText += `\\n Total Referrers: ${reportData.length}\\n`;
          reportText += ` Total Commission Paid: $${fmt(reportData.reduce((sum, user) => sum + user.totalCommission, 0))}`;
          
          // Send to admin channel
          sendBot(reportText);
          
          // Send individual notifications to all users with commissions
          reportData.forEach(user => {
            const userCommissionText = ` <b>Your Daily Commission Report</b>\\n\\nYou've earned $${fmt(user.totalCommission)} from ${user.referralCount} referrals.\\n\\nKeep inviting friends to earn more!`;
            sendBot(userCommissionText, user.userId);
          });
          
          // Update last report time
          const reportTime = now();
          database.ref('admin/lastCommissionReport').set(reportTime);
        }
      });
    }

    // Prices
    async function loadCryptoPrices(){
      try{
        const url='https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,binancecoin,cardano,solana,polkadot,polygon,avalanche-2,chainlink,uniswap,cosmos,near,algorand,vechain,internet-computer,filecoin,tron,stellar,the-open-network&vs_currencies=usd&include_24hr_change=true';
        const r=await fetch(url); const d=await r.json();
        cryptoPrices = {
          BTC:{ price:d.bitcoin?.usd||3000, change:d.bitcoin?.usd_24h_change||0 },
          ETH:{ price:d.ethereum?.usd||2000, change:d.ethereum?.usd_24h_change||0 },
          BNB:{ price:d.binancecoin?.usd||300, change:d.binancecoin?.usd_24h_change||0 },
          ADA:{ price:d.cardano?.usd||0.5, change:d.cardano?.usd_24h_change||0 },
          SOL:{ price:d.solana?.usd||100, change:d.solana?.usd_24h_change||0 },
          DOT:{ price:d.polkadot?.usd||7, change:d.polkadot?.usd_24h_change||0 },
          MATIC:{ price:d.polygon?.usd||0.8, change:d.polygon?.usd_24h_change||0 },
          AVAX:{ price:d['avalanche-2']?.usd||25, change:d['avalanche-2']?.usd_24h_change||0 },
          LINK:{ price:d.chainlink?.usd||15, change:d.chainlink?.usd_24h_change||0 },
          UNI:{ price:d.uniswap?.usd||6, change:d.uniswap?.usd_24h_change||0 },
          ATOM:{ price:d.cosmos?.usd||8, change:d.cosmos?.usd_24h_change||0 },
          NEAR:{ price:d.near?.usd||3, change:d.near?.usd_24h_change||0 },
          ALGO:{ price:d.algorand?.usd||0.2, change:d.algorand?.usd_24h_change||0 },
          VET:{ price:d.vechain?.usd||0.03, change:d.vechain?.usd_24h_change||0 },
          ICP:{ price:d['internet-computer']?.usd||4, change:d['internet-computer']?.usd_24h_change||0 },
          FIL:{ price:d.filecoin?.usd||5, change:d.filecoin?.usd_24h_change||0 },
          TRX:{ price:d.tron?.usd||0.1, change:d.tron?.usd_24h_change||0 },
          XLM:{ price:d.stellar?.usd||0.12, change:d.stellar?.usd_24h_change||0 },
          TON:{ price:d['the-open-network']?.usd||2.5, change:d['the-open-network']?.usd_24h_change||0 }
        };
      }catch(e){ 
        cryptoPrices = { 
          BTC:{price:3000,change:0}, ETH:{price:2000,change:0}, BNB:{price:300,change:0}, ADA:{price:0.5,change:0}, SOL:{price:100,change:0},
          DOT:{price:7,change:0}, MATIC:{price:0.8,change:0}, AVAX:{price:25,change:0}, LINK:{price:15,change:0}, UNI:{price:6,change:0},
          ATOM:{price:8,change:0}, NEAR:{price:3,change:0}, ALGO:{price:0.2,change:0}, VET:{price:0.03,change:0},
          ICP:{price:4,change:0}, FIL:{price:5,change:0}, TRX:{price:0.1,change:0}, XLM:{price:0.12,change:0}, TON:{price:2.5,change:0}
        }; 
      }
    }

    // Plans with crypto icons - Updated MATIC to TON
    const TRADE_PLANS = [
      { id:'plan1', name:'BTC/USDT', price:40, dailyEarning:4, duration:30, icon:'bitcoin' },
      { id:'plan2', name:'ETH/USDT', price:50, dailyEarning:5, duration:30, icon:'ethereum' },
      { id:'plan3', name:'BNB/USDT', price:60, dailyEarning:6, duration:30, icon:'money' },
      { id:'plan4', name:'ADA/USDT', price:70, dailyEarning:7, duration:30, icon:'ADA' },
      { id:'plan5', name:'SOL/USDT', price:80, dailyEarning:8, duration:30, icon:'SOL' },
      { id:'plan6', name:'DOT/USDT', price:90, dailyEarning:9, duration:30, icon:'images' },
      { id:'plan7', name:'TON/USDT', price:100, dailyEarning:10, duration:30, icon:'TON' },
      { id:'plan8', name:'AVAX/USDT', price:120, dailyEarning:12, duration:30, icon:'images (1)' },
      { id:'plan9', name:'LINK/USDT', price:140, dailyEarning:14, duration:30, icon:'LINK' },
      { id:'plan10',name:'UNI/USDT', price:160, dailyEarning:16, duration:30, icon:'UNI#' },
      { id:'plan11',name:'ATOM/USDT',price:180, dailyEarning:18, duration:30, icon:'ATOM' },
      { id:'plan12',name:'NEAR/USDT',price:250, dailyEarning:25, duration:30, icon:'NEAR' },
      { id:'plan13',name:'ALGO/USDT',price:300, dailyEarning:30, duration:30, icon:'ALGO' },
      { id:'plan14',name:'VET/USDT', price:350, dailyEarning:35, duration:30, icon:'VET' },
      { id:'plan15',name:'ICP/USDT', price:400, dailyEarning:40, duration:30, icon:'ICP' },
      { id:'plan16',name:'FIL/USDT', price:500, dailyEarning:50, duration:30, icon:'FIL' },
      { id:'plan17',name:'TRX/USDT', price:600, dailyEarning:60, duration:30, icon:'TRX' },
      { id:'plan18',name:'XLM/USDT', price:700, dailyEarning:70, duration:30, icon:'XLM' }
    ];

    // DB helpers
    const userRef = (uid)=> database.ref('users/'+uid);

    async function loadUser() {
      const snap = await userRef(userId).once('value');
      if (snap.exists()) return snap.val();
      const init = {
        usdtBalance:0, 
        exvBalance:0,
        purchasedPlans:{}, activeTrades:{},
        depositHistory:[], withdrawHistory:[], tradeHistory:[],
        avatar:userAvatar, name:userName, referrals:0, completedTasks:{},
        adStats:{ today:0, yesterday:0, thisWeek:0, thisMonth:0, lifetime:0, lastAdDate: todayISO(), lastWeekReset: weekStartISO(), lastMonthReset: monthStartISO() },
        milestones:{ milestone100Claimed:false, milestone200Claimed:false, milestone500Claimed:false },
        referralCommissions:{}, totalReferralCommission:0, createdAt: now(),
        referredBy: null, referralCode: null, lastCommissionNotification: 0,
        checkInData: {
          lastCheckIn: 0,
          currentStreak: 0,
          claimedDays: [],
          monthlyCheckIns: {}
        },
        hasDeposit: false, // Track if user has made any deposit
        tokenWithdrawHistory: [], // Initialize token withdrawal history
        microtaskEarnings: 0, // Initialize microtask earnings
        exvDepositHistory: [], // Initialize EXV deposit history
        userTaskCount: 0, // Initialize user task count
        submittedTasks: {} // Initialize submitted tasks
      };
      await userRef(userId).set(init);
      return init;
    }

    function todayISO(){ return new Date().toISOString().split('T')[0]; }
    function weekStartISO(){
      const d=new Date(); const day=d.getDay(); const diff=d.getDate()-day+(day===0?-6:1); d.setDate(diff);
      return d.toISOString().split('T')[0];
    }
    function monthStartISO(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`; }

    function save(partial){
      userData = { ...userData, ...partial };
      userRef(userId).update(partial).catch(()=>{});
      // local fallback
      localStorage.setItem('exotix_user_'+userId, JSON.stringify(userData));
      if (partial.usdtBalance!==undefined) {
        usdtBalance = partial.usdtBalance;
        document.getElementById('usdtBalance').textContent = fmt(usdtBalance);
      }
      if (partial.exvBalance!==undefined) {
        exvBalance = partial.exvBalance;
        document.getElementById('exvBalance').textContent = exvBalance;
      }
    }

    // Setup Referral Listener
    function setupReferralListener() {
      if (referralListener) {
        database.ref('users').off('value', referralListener);
      }
      
      referralListener = database.ref('users')
        .orderByChild('referredBy')
        .equalTo(userId);
      
      referralListener.on('value', (snapshot) => {
        const count = snapshot.numChildren();
        referralCount = count;
        
        // Calculate total commission
        let totalCommission = 0;
        snapshot.forEach(child => {
          const referredUser = child.val();
          if (userData.referralCommissions && userData.referralCommissions[child.key]) {
            totalCommission += userData.referralCommissions[child.key];
          }
        });
        totalReferralCommission = totalCommission;
        
        // Update UI if on profile page
        const referralCountEl = document.querySelector('.referral-stat-value');
        const referralEarningsEl = document.querySelectorAll('.referral-stat-value')[1];
        
        if (referralCountEl) {
          referralCountEl.textContent = count;
        }
        if (referralEarningsEl) {
          // Show signup bonus + commission
          const signupBonus = count * 0.20;
          referralEarningsEl.textContent = fmt(signupBonus + totalCommission);
        }
        
        console.log('Real-time referral count updated:', count);
        console.log('Total referral commission:', totalCommission);
      });
    }

    // Setup Status Listeners for Deposits and Withdrawals
    function setupStatusListeners() {
      // Listen for deposit status updates
      database.ref('admin/deposits').on('value', (snapshot) => {
        if (snapshot.exists()) {
          const deposits = snapshot.val();
          Object.entries(deposits).forEach(([key, deposit]) => {
            if (deposit.userId === userId) {
              // Update local deposit history if status changed
              const localDepositIndex = depositHistory.findIndex(d => d.id === deposit.id);
              if (localDepositIndex !== -1 && depositHistory[localDepositIndex].status !== deposit.status) {
                // Update status in local history
                depositHistory[localDepositIndex].status = deposit.status;
                save({ depositHistory });
                
                // If approved, update balance
                if (deposit.status === 'approved') {
                  // Check if already added to balance to avoid double counting
                  if (!depositHistory[localDepositIndex].balanceUpdated) {
                    save({ usdtBalance: usdtBalance + deposit.amount });
                    depositHistory[localDepositIndex].balanceUpdated = true;
                    save({ depositHistory });
                    
                    // Mark user as having a deposit
                    save({ hasDeposit: true });
                    
                    notify(`Deposit of $${deposit.amount} approved!`);
                    sendBot(` <b>Deposit Approved</b>\\nAmount: $${deposit.amount} USDT\\nNew balance: $${fmt(usdtBalance + deposit.amount)} USDT`);
                  }
                } else if (deposit.status === 'rejected') {
                  notify(`Deposit of $${deposit.amount} rejected!`);
                  sendBot(` <b>Deposit Rejected</b>\\nAmount: $${deposit.amount} USDT\\nReason: ${deposit.reason || 'Not specified'}`);
                }
                
                // Refresh wallet view if active
                if (document.querySelector('.nav-btn.active').dataset.tab === 'wallet') {
                  const currentContent = document.getElementById('deposit-content').innerHTML;
                  if (currentContent && currentContent.includes('Deposit History')) {
                    showDepositHistory();
                  }
                }
              }
            }
          });
        }
      });
      
      // Listen for withdrawal status updates
      database.ref('admin/withdrawals').on('value', (snapshot) => {
        if (snapshot.exists()) {
          const withdrawals = snapshot.val();
          Object.entries(withdrawals).forEach(([key, withdrawal]) => {
            if (withdrawal.userId === userId) {
              // Update local withdrawal history if status changed
              const localWithdrawalIndex = withdrawHistory.findIndex(w => w.id === withdrawal.id);
              if (localWithdrawalIndex !== -1 && withdrawHistory[localWithdrawalIndex].status !== withdrawal.status) {
                // Update status in local history
                withdrawHistory[localWithdrawalIndex].status = withdrawal.status;
                save({ withdrawHistory });
                
                // If approved, no additional balance changes needed (already deducted)
                if (withdrawal.status === 'approved') {
                  notify(`Withdrawal of $${withdrawal.amount} approved!`);
                  sendBot(` <b>Withdrawal Approved</b>\\nAmount: $${withdrawal.amount} USDT`);
                } else if (withdrawal.status === 'rejected') {
                  // Check if already refunded to balance to avoid double counting
                  if (!withdrawHistory[localWithdrawalIndex].balanceUpdated) {
                    save({ usdtBalance: usdtBalance + withdrawal.amount });
                    withdrawHistory[localWithdrawalIndex].balanceUpdated = true;
                    save({ withdrawHistory });
                    notify(`Withdrawal of $${withdrawal.amount} rejected. Amount refunded.`);
                    sendBot(` <b>Withdrawal Rejected</b>\\nAmount: $${withdrawal.amount} USDT\\nReason: ${withdrawal.reason || 'Not specified'}\\nAmount refunded to balance.`);
                  }
                }
                
                // Refresh wallet view if active
                if (document.querySelector('.nav-btn.active').dataset.tab === 'wallet') {
                  const currentContent = document.getElementById('withdraw-content').innerHTML;
                  if (currentContent && currentContent.includes('Withdraw History')) {
                    showWithdrawHistory();
                  }
                }
              }
            }
          });
        }
      });
      
      // Listen for token withdrawal status updates
      database.ref('admin/tokenWithdrawals').on('value', (snapshot) => {
        if (snapshot.exists()) {
          const tokenWithdrawals = snapshot.val();
          Object.entries(tokenWithdrawals).forEach(([key, tokenWithdrawal]) => {
            if (tokenWithdrawal.userId === userId) {
              // Update local token withdrawal history if status changed
              const localTokenWithdrawalIndex = tokenWithdrawHistory.findIndex(tw => tw.id === tokenWithdrawal.id);
              if (localTokenWithdrawalIndex !== -1 && tokenWithdrawHistory[localTokenWithdrawalIndex].status !== tokenWithdrawal.status) {
                // Update status in local history
                tokenWithdrawHistory[localTokenWithdrawalIndex].status = tokenWithdrawal.status;
                save({ tokenWithdrawHistory });
                
                // If approved, no additional balance changes needed (already deducted)
                if (tokenWithdrawal.status === 'approved') {
                  notify(`Token withdrawal of ${tokenWithdrawal.amount} EXV approved!`);
                  sendBot(` <b>Token Withdrawal Approved</b>\\nAmount: ${tokenWithdrawal.amount} EXV\\nReceived: $${tokenWithdrawal.receiveAmount.toFixed(6)} USDT`);
                } else if (tokenWithdrawal.status === 'rejected') {
                  // Check if already refunded to balance to avoid double counting
                  if (!tokenWithdrawHistory[localTokenWithdrawalIndex].balanceUpdated) {
                    save({ exvBalance: exvBalance + tokenWithdrawal.amount });
                    tokenWithdrawHistory[localTokenWithdrawalIndex].balanceUpdated = true;
                    save({ tokenWithdrawHistory });
                    notify(`Token withdrawal of ${tokenWithdrawal.amount} EXV rejected. Amount refunded.`);
                    sendBot(` <b>Token Withdrawal Rejected</b>\\nAmount: ${tokenWithdrawal.amount} EXV\\nReason: ${tokenWithdrawal.reason || 'Not specified'}\\nAmount refunded to balance.`);
                  }
                }
                
                // Refresh wallet view if active
                if (document.querySelector('.nav-btn.active').dataset.tab === 'wallet') {
                  const currentContent = document.getElementById('token-withdraw-history-content').innerHTML;
                  if (currentContent && currentContent.includes('Token Withdraw History')) {
                    showTokenWithdrawHistory();
                  }
                }
              }
            }
          });
        }
      });
      
      // Listen for EXV deposit status updates
      database.ref('admin/exvDeposits').on('value', (snapshot) => {
        if (snapshot.exists()) {
          const exvDeposits = snapshot.val();
          Object.entries(exvDeposits).forEach(([key, exvDeposit]) => {
            if (exvDeposit.userId === userId) {
              // Update local EXV deposit history if status changed
              const localExvDepositIndex = exvDepositHistory.findIndex(d => d.id === exvDeposit.id);
              if (localExvDepositIndex !== -1 && exvDepositHistory[localExvDepositIndex].status !== exvDeposit.status) {
                // Update status in local history
                exvDepositHistory[localExvDepositIndex].status = exvDeposit.status;
                save({ exvDepositHistory });
                
                // If approved, update balance
                if (exvDeposit.status === 'approved') {
                  // Check if already added to balance to avoid double counting
                  if (!exvDepositHistory[localExvDepositIndex].balanceUpdated) {
                    save({ exvBalance: exvBalance + exvDeposit.amount });
                    exvDepositHistory[localExvDepositIndex].balanceUpdated = true;
                    save({ exvDepositHistory });
                    
                    notify(`EXV deposit of ${exvDeposit.amount} approved!`);
                    sendBot(` <b>EXV Deposit Approved</b>\\nAmount: ${exvDeposit.amount} EXV\\nNew balance: ${exvBalance + exvDeposit.amount} EXV`);
                  }
                } else if (exvDeposit.status === 'rejected') {
                  notify(`EXV deposit of ${exvDeposit.amount} rejected!`);
                  sendBot(` <b>EXV Deposit Rejected</b>\\nAmount: ${exvDeposit.amount} EXV\\nReason: ${exvDeposit.reason || 'Not specified'}`);
                }
                
                // Refresh wallet view if active
                if (document.querySelector('.nav-btn.active').dataset.tab === 'wallet') {
                  const currentContent = document.getElementById('exv-deposit-content').innerHTML;
                  if (currentContent && currentContent.includes('Deposit History')) {
                    showExvDepositHistory();
                  }
                }
              }
            }
          });
        }
      });
      
      // Listen for microtask status updates
      database.ref('admin/microtasks').on('value', (snapshot) => {
        if (snapshot.exists()) {
          const adminTasks = snapshot.val();
          Object.entries(adminTasks).forEach(([taskId, task]) => {
            // Check if this is a task created by the current user
            if (task.creatorId === userId) {
              // Update local task if status changed
              if (myMicrotasks[taskId] && myMicrotasks[taskId].status !== task.status) {
                myMicrotasks[taskId].status = task.status;
                
                // Update in global microtasks if it exists there
                if (microtasks[taskId]) {
                  microtasks[taskId].status = task.status;
                }
                
                // Send notification to user
                if (task.status === 'approved') {
                  notify(`Your task "${task.name}" has been approved!`);
                  sendBot(` <b>Task Approved</b>\\nYour task "${task.name}" has been approved and is now available for users to complete.`);
                } else if (task.status === 'rejected') {
                  notify(`Your task "${task.name}" has been rejected. Reason: ${task.reason || 'Not specified'}`);
                  sendBot(` <b>Task Rejected</b>\\nYour task "${task.name}" has been rejected.\\nReason: ${task.reason || 'Not specified'}`);
                }
                
                // Refresh microtasks view if active
                if (document.getElementById('microtasks-modal').style.display === 'flex') {
                  const activeTab = document.querySelector('.microtasks-tab.active').dataset.tab;
                  if (activeTab === 'mytasks') {
                    showMicrotasksTab('mytasks');
                  }
                }
              }
            }
          });
        }
      });
      
      // Listen for microtask balance updates
      database.ref('microtasks').on('value', (snapshot) => {
        if (snapshot.exists()) {
          const tasks = snapshot.val();
          Object.entries(tasks).forEach(([taskId, task]) => {
            // Check if this is a task created by the current user
            if (task.creatorId === userId) {
              // Check if task balance is running low
              if (task.status === 'active' && task.remainingFunds < task.reward) {
                // Send notification to user
                sendBot(` <b>Task Balance Low</b>\\nYour task "${task.name}" is running low on EXV balance.\\nRemaining: ${task.remainingFunds} EXV\\nPlease add more funds to keep the task active.`);
                
                // Update local task status to paused
                if (myMicrotasks[taskId]) {
                  myMicrotasks[taskId].status = 'paused';
                  database.ref('userMicrotasks/' + userId + '/' + taskId).update({
                    status: 'paused'
                  });
                }
              }
            }
          });
        }
      });
      
      // Listen for task proof submissions
      database.ref('taskProofs').on('value', (snapshot) => {
        if (snapshot.exists()) {
          taskProofs = snapshot.val();
          
          // Update admin notification count
          let notificationCount = 0;
          Object.keys(taskProofs).forEach(taskId => {
            if (microtasks[taskId] && microtasks[taskId].creatorId === userId) {
              Object.keys(taskProofs[taskId]).forEach(userId => {
                if (taskProofs[taskId][userId].status === 'pending') {
                  notificationCount++;
                }
              });
            }
          });
          
          adminNotifications = notificationCount;
          updateAdminNotificationBadge();
        }
      });
      
      // Auto-approve proofs after 48 hours
      setInterval(() => {
        if (Object.keys(taskProofs).length > 0) {
          const currentTime = now();
          const fortyEightHours = 48 * 60 * 60; // 48 hours in seconds
          
          Object.keys(taskProofs).forEach(taskId => {
            if (microtasks[taskId] && microtasks[taskId].creatorId === userId) {
              Object.keys(taskProofs[taskId]).forEach(submitterId => {
                const proof = taskProofs[taskId][submitterId];
                
                // Check if proof is pending and older than 48 hours
                if (proof.status === 'pending' && (currentTime - proof.submittedAt) > fortyEightHours) {
                  // Auto-approve the proof
                  approveTaskProof(taskId, submitterId, true); // true indicates auto-approval
                }
              });
            }
          });
        }
      }, 60000); // Check every minute
    }

    // Setup Real-time Balance Listener
    function setupBalanceListener() {
      database.ref('users/' + userId + '/usdtBalance').on('value', (snapshot) => {
        if (snapshot.exists() && snapshot.val() !== usdtBalance) {
          usdtBalance = snapshot.val();
          document.getElementById('usdtBalance').textContent = fmt(usdtBalance);
          console.log('Real-time USDT balance updated:', usdtBalance);
        }
      });
      
      database.ref('users/' + userId + '/exvBalance').on('value', (snapshot) => {
        if (snapshot.exists() && snapshot.val() !== exvBalance) {
          exvBalance = snapshot.val();
          document.getElementById('exvBalance').textContent = exvBalance;
          console.log('Real-time EXV balance updated:', exvBalance);
        }
      });
    }

    // Setup Real-time User Data Listener
    function setupUserDataListener() {
      database.ref('users/' + userId).on('value', (snapshot) => {
        if (snapshot.exists()) {
          const updatedData = snapshot.val();
          userData = updatedData;
          
          // Update local variables
          usdtBalance = updatedData.usdtBalance || 0;
          exvBalance = updatedData.exvBalance || 0;
          purchasedPlans = updatedData.purchasedPlans || {};
          activeTrades = updatedData.activeTrades || {};
          depositHistory = updatedData.depositHistory || [];
          withdrawHistory = updatedData.withdrawHistory || [];
          tradeHistory = updatedData.tradeHistory || [];
          tokenWithdrawHistory = updatedData.tokenWithdrawHistory || [];
          checkInData = updatedData.checkInData || {
            lastCheckIn: 0,
            currentStreak: 0,
            claimedDays: [],
            monthlyCheckIns: {}
          };
          microtaskEarnings = updatedData.microtaskEarnings || 0;
          exvDepositHistory = updatedData.exvDepositHistory || [];
          userTaskCount = updatedData.userTaskCount || 0;
          submittedTasks = updatedData.submittedTasks || {};
          
          // Update UI elements
          document.getElementById('usdtBalance').textContent = fmt(usdtBalance);
          document.getElementById('exvBalance').textContent = exvBalance;
          
          // Refresh current tab if needed
          const activeTab = document.querySelector('.nav-btn.active').dataset.tab;
          if (activeTab === 'home') renderHome();
          if (activeTab === 'wallet') renderWallet();
          if (activeTab === 'earn') renderEarn();
          if (activeTab === 'profile') renderProfile();
          if (activeTab === 'ranking') renderRanking();
        }
      });
    }

    // Load Micro Tasks
    function loadMicroTasks() {
      database.ref('microtasks').once('value').then(snapshot => {
        if (snapshot.exists()) {
          microtasks = snapshot.val();
        }
      });
      
      // Load user's microtasks
      database.ref('userMicrotasks/' + userId).once('value').then(snapshot => {
        if (snapshot.exists()) {
          myMicrotasks = snapshot.val();
        }
      });
      
      // Load task proofs
      database.ref('taskProofs').once('value').then(snapshot => {
        if (snapshot.exists()) {
          taskProofs = snapshot.val();
        }
      });
      
      // Load user's submitted tasks
      database.ref('users/' + userId + '/submittedTasks').once('value').then(snapshot => {
        if (snapshot.exists()) {
          submittedTasks = snapshot.val();
        }
      });
      
      // Setup real-time listener for microtasks
      database.ref('microtasks').on('value', (snapshot) => {
        if (snapshot.exists()) {
          microtasks = snapshot.val();
          
          // Refresh microtasks view if active
          if (document.getElementById('microtasks-modal').style.display === 'flex') {
            const activeTab = document.querySelector('.microtasks-tab.active').dataset.tab;
            showMicrotasksTab(activeTab);
          }
        }
      });
      
      // Setup real-time listener for user's microtasks
      database.ref('userMicrotasks/' + userId).on('value', (snapshot) => {
        if (snapshot.exists()) {
          myMicrotasks = snapshot.val();
          
          // Refresh microtasks view if active
          if (document.getElementById('microtasks-modal').style.display === 'flex') {
            const activeTab = document.querySelector('.microtasks-tab.active').dataset.tab;
            showMicrotasksTab(activeTab);
          }
        }
      });
      
      // Setup real-time listener for task proofs
      database.ref('taskProofs').on('value', (snapshot) => {
        if (snapshot.exists()) {
          taskProofs = snapshot.val();
          
          // Update admin notification count
          let notificationCount = 0;
          Object.keys(taskProofs).forEach(taskId => {
            if (microtasks[taskId] && microtasks[taskId].creatorId === userId) {
              Object.keys(taskProofs[taskId]).forEach(userId => {
                if (taskProofs[taskId][userId].status === 'pending') {
                  notificationCount++;
                }
              });
            }
          });
          
          adminNotifications = notificationCount;
          updateAdminNotificationBadge();
          
          // Refresh admin view if active
          if (document.getElementById('admin-modal').style.display === 'flex') {
            showAdminProofs();
          }
        }
      });
      
      // Setup real-time listener for user's submitted tasks
      database.ref('users/' + userId + '/submittedTasks').on('value', (snapshot) => {
        if (snapshot.exists()) {
          submittedTasks = snapshot.val();
          
          // Refresh microtasks view if active
          if (document.getElementById('microtasks-modal').style.display === 'flex') {
            const activeTab = document.querySelector('.microtasks-tab.active').dataset.tab;
            showMicrotasksTab(activeTab);
          }
        }
      });
    }

    // Update Admin Notification Badge
    function updateAdminNotificationBadge() {
      const badge = document.getElementById('adminNotificationBadge');
      if (badge) {
        if (adminNotifications > 0) {
          badge.textContent = adminNotifications > 99 ? '99+' : adminNotifications;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // Tabs
    function showTab(tab){
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
      if(tab==='home') renderHome();
      if(tab==='wallet') renderWallet();
      if(tab==='earn') renderEarn();
      if(tab==='profile') renderProfile();
      if(tab==='ranking') renderRanking();
    }

    // Home (Trade Plans)
    function formatTime(s){ s=Math.max(0,s|0); const h=(s/3600)|0; const m=((s%3600)/60)|0; const sec=s%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }

    function renderHome(){
      const btc = cryptoPrices.BTC||{price:3000,change:0};
      const eth = cryptoPrices.ETH||{price:2000,change:0};

      const html = `
        <div class="section-header">
          <div class="section-title">Trade Plans</div>
          <div class="section-subtitle">Invest and claim earnings every 24 hours</div>
        </div>

        <div class="live-prices">
          <div class="price-card">
            <div class="price-symbol">BTC/USDT</div>
            <div class="price-value">$${(btc.price||3000).toFixed(2)}</div>
            <div class="price-change ${btc.change>=0?'positive':'negative'}">${(btc.change>=0?'+':'')}${(btc.change||0).toFixed(2)}%</div>
          </div>
          <div class="price-card">
            <div class="price-symbol">ETH/USDT</div>
            <div class="price-value">$${(eth.price||2000).toFixed(2)}</div>
            <div class="price-change ${eth.change>=0?'positive':'negative'}">${(eth.change>=0?'+':'')}${(eth.change||0).toFixed(2)}%</div>
          </div>
        </div>

        ${TRADE_PLANS.map(p=>{
          const purchased = !!purchasedPlans[p.id];
          const tr = activeTrades[p.id];
          const canClaim = tr ? (now()-tr.lastClaim)>=86400 : false;
          const prog = tr ? (tr.claimedDays/p.duration*100) : 0;
          const cryptoPrice = cryptoPrices[p.name.split('/')[0]] || {price: 100, change: 0};

          return `
            <div class="plan">
              <div class="plan-h">
                <div class="plan-ic">
                  <img src="${getImageUrl(p.icon, `https://github.com/s42144/exotix-/blob/${getIconPath(p.icon)}?raw=true`)}" alt="${p.name}" />
                </div>
                <div>
                  <div class="plan-tt">${p.name}</div>
                  <div class="plan-pr">$${p.price} USDT</div>
                </div>
              </div>

              <div class="chart-container">
                <div class="chart-title">Live ${p.name} Chart</div>
                <iframe src="https://www.tradingview.com/widgetembed/?symbol=BINANCE:${p.name.split('/')[0]}USDT&interval=1&theme=dark" width="100%" height="200" frameborder="0"></iframe>
              </div>

              <div class="plan-g">
                <div class="g-it">
                  <div class="g-l">Daily Earning</div>
                  <div class="g-v">$${p.dailyEarning}</div>
                </div>
                <div class="g-it">
                  <div class="g-l">Duration</div>
                  <div class="g-v">${p.duration} days</div>
                </div>
              </div>

              ${tr ? `
                <div class="prog">
                  <div class="progbar"><div class="progfill" style="width:${prog}%"></div></div>
                  <div class="progtext">Progress: ${tr.claimedDays}/${p.duration} days</div>
                </div>
                <div class="countdown" id="cd_${p.id}">Next claim in: ${formatTime(86400-(now()-tr.lastClaim))}</div>
                <button class="btn-claim" id="claim_${p.id}" ${canClaim?'':'disabled'}>${canClaim?`Claim $${p.dailyEarning}`:'Wait'}</button>
              ` : `
                <button class="btn-primary" id="buy_${p.id}" ${purchased?'disabled':''}>${purchased?'Purchased':'Buy Plan'}</button>
              `}
            </div>
          `;
        }).join('')}
      `;
      document.getElementById('main-content').innerHTML = html;

      // Bind
      TRADE_PLANS.forEach(p=>{
        const buy=document.getElementById(`buy_${p.id}`);
        const claim=document.getElementById(`claim_${p.id}`);
        if(buy){
          buy.addEventListener('click', ()=>{
            if (purchasedPlans[p.id]) { notify('Already purchased'); return; }
            if (usdtBalance < p.price) { notify('Insufficient balance'); return; }
            const newBal=usdtBalance - p.price;
            const newPurchased = { ...purchasedPlans, [p.id]:true };
            const newTrades = { ...activeTrades, [p.id]:{ planId:p.id, purchasedAt:now(), lastClaim:now(), claimedDays:0, totalEarned:0 } };
            save({ usdtBalance:newBal, purchasedPlans:newPurchased, activeTrades:newTrades });
            tradeHistory.push({ type:'purchase', planId:p.id, planName:p.name, amount:p.price, timestamp:now() });
            save({ tradeHistory });
            sendBot(` <b>Plan Purchased</b>\\nPlan: ${p.name}\\nAmount: $${p.price} USDT\\nDaily: $${p.dailyEarning}\\nDuration: ${p.duration} days`);
            notify(`Purchased ${p.name}`);
            renderHome();
          });
        }
        if(claim){
          claim.addEventListener('click', ()=>{
            const tr=activeTrades[p.id]; if(!tr) return;
            if ((now()-tr.lastClaim)<86400){ notify('Claim available every 24h'); return; }
            const earned=p.dailyEarning;
            const newBal=usdtBalance+earned;
            tr.lastClaim=now(); tr.claimedDays+=1; tr.totalEarned+=earned;
            
            // Process referral commission (20% of earnings)
            awardReferralCommission(earned);
            
            if (tr.claimedDays>=p.duration){
              const copy={...activeTrades}; delete copy[p.id];
              save({ usdtBalance:newBal, activeTrades:copy });
              notify(`Plan completed. Total earned $${tr.totalEarned}`);
              sendBot(` <b>Plan Completed</b>\\nPlan: ${p.name}\\nTotal Earned: $${tr.totalEarned} USDT`);
            }else{
              save({ usdtBalance:newBal, activeTrades:{...activeTrades} });
              notify(`Claimed $${earned} from ${p.name}`);
              sendBot(` <b>Daily Claimed</b>\\nPlan: ${p.name}\\nEarned: $${earned} USDT\\nProgress: ${tr.claimedDays}/${p.duration}`);
            }
            tradeHistory.push({ type:'claim', planId:p.id, planName:p.name, amount:earned, timestamp:now() });
            save({ tradeHistory });
            renderHome();
          });
        }
      });

      // Countdowns
      setInterval(()=>{
        Object.values(activeTrades).forEach(tr=>{
          const el=document.getElementById(`cd_${tr.planId}`); if(!el) return;
          el.textContent = `Next claim in: ${formatTime(86400-(now()-tr.lastClaim))}`;
        });
      },1000);
    }

    // Helper function to get icon path
    function getIconPath(iconName) {
      const iconPaths = {
        'bitcoin': 'b664bfe02b4b6ad4a01630e7ef0d11591eec6633/bitcoin.png',
        'ethereum': 'a21e4200f019c08e41e0df1150845c048a548eda/ethereum.png',
        'money': 'b664bfe02b4b6ad4a01630e7ef0d11591eec6633/money.png',
        'ADA': 'e7f6eec9bf7824e3ff41e66e77e14b711361d780/ADA.png',
        'SOL': 'b664bfe02b4b6ad4a01630e7ef0d11591eec6633/SOL.webp',
        'images': 'b664bfe02b4b6ad4a01630e7ef0d11591eec6633/images.png',
        'TON': '76ccee51eaaff076a5be449f03426720b5ea8b14/TON.png',
        'images (1)': '2a92878ba871080d95116374cedeb7c1b0b75545/images%20(1).png',
        'LINK': 'a21e4200f019c08e41e0df1150845c048a548eda/LINK.png',
        'UNI#': 'a21e4200f019c08e41e0df1150845c048a548eda/UNI%23.png',
        'ATOM': 'a21e4200f019c08e41e0df1150845c048a548eda/ATOM.png',
        'NEAR': 'a21e4200f019c08e41e0df1150845c048a548eda/NEAR.png',
        'ALGO': 'a21e4200f019c08e41e0df1150845c048a548eda/ALGO.png',
        'VET': 'a21e4200f019c08e41e0df1150845c048a548eda/VET.png',
        'ICP': 'a21e4200f019c08e41e0df1150845c048a548eda/ICP.png',
        'FIL': 'a21e4200f019c08e41e0df1150845c048a548eda/FIL.png',
        'TRX': 'a21e4200f019c08e41e0df1150845c048a548eda/TRX.png',
        'XLM': 'a21e4200f019c08e41e0df1150845c048a548eda/XLM.png'
      };
      return iconPaths[iconName] || 'b664bfe02b4b6ad4a01630e7ef0d11591eec6633/bitcoin.png';
    }

    // Wallet
    function renderWallet(){
      const html = `
        <div class="section-header">
          <div class="section-title">Wallet</div>
          <div class="section-subtitle">Deposit, Withdraw, History, Activities & Trades</div>
        </div>

        <div class="wallet-options">
          <div class="microtasks-item" id="w_microtasks">
            <div class="microtasks-icon">
              <div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); display: flex; align-items: center; justify-content: center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 11H7V13H9V11Z" fill="white"/>
                  <path d="M13 11H11V13H13V11Z" fill="white"/>
                  <path d="M17 11H15V13H17V11Z" fill="white"/>
                  <path d="M9 15H7V17H9V15Z" fill="white"/>
                  <path d="M13 15H11V17H13V15Z" fill="white"/>
                  <path d="M17 15H15V17H17V15Z" fill="white"/>
                  <path d="M3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5ZM5 5H19V19H5V5Z" fill="white"/>
                </svg>
              </div>
            </div>
            <div class="microtasks-text">Micro Jobs Platform</div>
          </div>
          <div class="wallet-item" id="w_dep"><img src="${getImageUrl('wallet', 'https://github.com/s42144/exotix-/blob/55716b0c008098f802c57e8c2a72d2839882d9a6/wallet.png?raw=true')}" class="wallet-ic" alt="Deposit">Deposit</div>
          <div class="wallet-item" id="w_wd"><img src="${getImageUrl('top-up', 'https://i.postimg.cc/0yHFM9nV/withdraw.png?raw=true')}" class="wallet-ic" alt="Withdraw">Withdraw</div>
          <div class="wallet-item" id="w_checkin"><img src="${getImageUrl('check-in', 'https://i.postimg.cc/0jbJNdyF/check-in.png?raw=true')}" class="wallet-ic" alt="Daily Check In">Daily Check In</div>
          <div class="wallet-item" id="w_deph"><img src="${getImageUrl('history', 'https://github.com/s42144/exotix-/blob/fb47587bd76a06af6c816e1421c6b9ca862192cf/history.png?raw=true')}" class="wallet-ic" alt="Deposit History">Deposit History</div>
          <div class="wallet-item" id="w_wdh"><img src="${getImageUrl('history', 'https://github.com/s42144/exotix-/blob/fb47587bd76a06af6c816e1421c6b9ca862192cf/history.png?raw=true')}" class="wallet-ic" alt="Withdraw History">Withdraw History</div>
          <div class="wallet-item" id="w_tokenwd"><img src="${getImageUrl('history', 'https://github.com/s42144/exotix-/blob/fb47587bd76a06af6c816e1421c6b9ca862192cf/history.png?raw=true')}" class="wallet-ic" alt="EXV Deposit/Withdraw History">EXV Deposit/Withdraw History</div>
          <div class="wallet-item" id="w_exvwd"><img src="${getImageUrl('top-up', 'https://i.postimg.cc/0yHFM9nV/withdraw.png?raw=true')}" class="wallet-ic" alt="Withdraw EXV Token">Withdraw EXV Token</div>
          <div class="wallet-item" id="w_exvdep"><img src="${getImageUrl('wallet', 'https://github.com/s42144/exotix-/blob/55716b0c008098f802c57e8c2a72d2839882d9a6/wallet.png?raw=true')}" class="wallet-ic" alt="Deposit EXV Token">Deposit EXV Token</div>
          <div class="wallet-item" id="w_act"><img src="${getImageUrl('process', 'https://github.com/s42144/exotix-/blob/b827cb1714a241f36d4d03a1dacbce5ce15bf795/process.png?raw=true')}" class="wallet-ic" alt="Activities">Activities</div>
          <div class="wallet-item" id="w_trd"><img src="${getImageUrl('trade', 'https://github.com/s42144/exotix-/blob/fb47587bd76a06af6c816e1421c6b9ca862192cf/trade.png?raw=true')}" class="wallet-ic" alt="Trades">Trades</div>
        </div>
      `;
      document.getElementById('main-content').innerHTML = html;

      document.getElementById('w_dep').onclick = showDepositModal;
      document.getElementById('w_wd').onclick = showWithdrawModal;
      document.getElementById('w_checkin').onclick = showCheckInFullscreenModal;
      document.getElementById('w_deph').onclick = showDepositHistoryModal;
      document.getElementById('w_wdh').onclick = showWithdrawHistoryModal;
      document.getElementById('w_tokenwd').onclick = showTokenWithdrawHistoryModal;
      document.getElementById('w_exvwd').onclick = showExvWithdrawModal;
      document.getElementById('w_exvdep').onclick = showExvDepositModal;
      document.getElementById('w_microtasks').onclick = showMicrotasksModal;
      document.getElementById('w_act').onclick = showActivitiesModal;
      document.getElementById('w_trd').onclick = showTradesModal;
    }

    function showDepositModal() {
      const modal = document.getElementById('deposit-modal');
      const content = document.getElementById('deposit-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="card">
            <div class="section-subtitle" style="text-align:center;margin-bottom:8px">Deposit USDT (TON)</div>
            <label class="form-label">Amount (min $10)</label>
            <input id="dep_amt" type="number" min="10" step="0.01" class="input" placeholder="Enter amount">
            
            <div class="promo-section">
              <div class="promo-title">Promo Code (Optional)</div>
              <div class="promo-input-group">
                <input id="promo_code" class="promo-input" placeholder="Enter promo code">
                <button class="promo-apply-btn" id="apply_promo">Apply</button>
              </div>
              <div class="promo-info" id="promo_info"></div>
            </div>
            
            <div class="detailed-info" id="detailed_info" style="display:none">
              <div class="detailed-info-title">DETAILED INFO</div>
              <div class="detailed-info-row">
                <div class="detailed-info-label">Deposit Amount:</div>
                <div class="detailed-info-value" id="deposit_amount">$0.00</div>
              </div>
              <div class="detailed-info-row">
                <div class="detailed-info-label">Bonus Amount:</div>
                <div class="detailed-info-value" id="bonus_amount">$0.00</div>
              </div>
              <div class="detailed-info-row">
                <div class="detailed-info-label">Total Amount:</div>
                <div class="detailed-info-value" id="total_amount">$0.00</div>
              </div>
            </div>
            
            <button class="btn-primary" style="margin-top:10px" id="dep_go">Confirm</button>
          </div>
        `;
        
        // Apply promo code functionality
        document.getElementById('apply_promo').onclick = () => {
          const promoCode = document.getElementById('promo_code').value.trim();
          const amount = parseFloat(document.getElementById('dep_amt').value) || 0;
          
          if (!promoCode) {
            document.getElementById('promo_info').textContent = 'Please enter a promo code';
            document.getElementById('promo_info').className = 'promo-info promo-error';
            return;
          }
          
          // Check promo code in database
          database.ref('promoCodes/' + promoCode).once('value').then(snap => {
            if (snap.exists()) {
              const promoData = snap.val();
              
              // Check if promo code is still valid
              if (promoData.used >= promoData.maxUsers) {
                document.getElementById('promo_info').textContent = 'This promo code has reached its maximum usage limit';
                document.getElementById('promo_info').className = 'promo-info promo-error';
                return;
              }
              
              // Calculate bonus
              const bonusPercentage = promoData.percentage || 0;
              const bonusAmount = amount * (bonusPercentage / 100);
              const totalAmount = amount + bonusAmount;
              
              // Update UI
              document.getElementById('promo_info').innerHTML = `Promo code applied! You get ${bonusPercentage}% bonus<br>Bonus: $${bonusAmount.toFixed(2)}`;
              document.getElementById('promo_info').className = 'promo-info promo-success';
              
              document.getElementById('detailed_info').style.display = 'block';
              document.getElementById('deposit_amount').textContent = `$${amount.toFixed(2)}`;
              document.getElementById('bonus_amount').textContent = `$${bonusAmount.toFixed(2)}`;
              document.getElementById('total_amount').textContent = `$${totalAmount.toFixed(2)}`;
              
              // Store applied promo code
              appliedPromoCode = promoCode;
              promoBonus = bonusAmount;
            } else {
              document.getElementById('promo_info').textContent = 'Invalid promo code';
              document.getElementById('promo_info').className = 'promo-info promo-error';
              
              document.getElementById('detailed_info').style.display = 'none';
              appliedPromoCode = null;
              promoBonus = 0;
            }
          });
        };
        
        // Update total amount when deposit amount changes
        document.getElementById('dep_amt').oninput = () => {
          if (appliedPromoCode) {
            document.getElementById('apply_promo').click();
          }
        };
        
        document.getElementById('dep_go').onclick = processDeposit;
      }, 500);
    }

    function processDeposit(){
      const amt = parseFloat(document.getElementById('dep_amt').value);
      if(!amt || amt<10){ notify('Minimum deposit is $10'); return; }
      const memo = `ExotixDP_${userId}`;
      const id = generateId();
      const totalAmount = amt + promoBonus;

      const content = document.getElementById('deposit-content');
      content.innerHTML = `
        <div class="card">
          <div class="timer"><div class="t-t">Complete within 15:00</div><div id="dep_timer" class="t-t" style="font-size:22px;margin-top:6px">15:00</div></div>
          <img src="${getImageUrl('qr', 'https://i.postimg.cc/g2mgknm3/Screenshot-2025-10-17-16-28-28-211-com-ton-keeper-edit.jpg')}" alt="QR" style="width:200px;height:200px;border-radius:12px;border:2px solid var(--accent-blue);display:block;margin:0 auto 10px">
          <div class="row"><div>Network</div><div>TON <button class="copy" onclick="navigator.clipboard.writeText('TON')"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div></div>
          <div class="row"><div>Address</div><div style="font-family:monospace;word-break:break-all">UQBWOgFgB4B8qBCo8CNjDUNAtvUSosw4v7v9gkt0GVOaNLSz <button class="copy" id="cp_addr"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div></div>
          <div class="row"><div>Amount</div><div>$${amt.toFixed(2)} <button class="copy" id="cp_amt"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div></div>
          ${promoBonus > 0 ? `<div class="row"><div>Bonus</div><div>$${promoBonus.toFixed(2)} (from promo code)</div></div>` : ''}
          <div class="row"><div>Total Amount</div><div>$${totalAmount.toFixed(2)} <button class="copy" id="cp_total"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div></div>
          <div class="row"><div>Memo</div><div style="font-family:monospace">${memo} <button class="copy" id="cp_memo"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div></div>
          <label class="form-label" style="margin-top:8px">Transaction Hash</label>
          <input id="txh" class="input" placeholder="Enter transaction hash">
          <button class="btn-primary" style="margin-top:10px" id="dep_submit">Confirm Transaction</button>
        </div>
      `;
      document.getElementById('cp_addr').onclick=()=>copy('UQBWOgFgB4B8qBCo8CNjDUNAtvUSosw4v7v9gkt0GVOaNLSz');
      document.getElementById('cp_amt').onclick=()=>copy(String(amt));
      document.getElementById('cp_total').onclick=()=>copy(String(totalAmount));
      document.getElementById('cp_memo').onclick=()=>copy(memo);

      let t=900; const el=document.getElementById('dep_timer');
      const it=setInterval(()=>{ const m=(t/60|0), s=(t%60); el.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; if(--t<0){clearInterval(it); el.textContent='Expired';} },1000);

      document.getElementById('dep_submit').onclick = async ()=>{
        const tx = document.getElementById('txh').value.trim();
        if(!tx){ notify('Enter transaction hash'); return; }
        
        // Create deposit record
        const depositData = {
          id: id,
          userId: userId,
          userName: userName,
          amount: amt,
          bonus: promoBonus,
          totalAmount: totalAmount,
          promoCode: appliedPromoCode,
          txHash: tx,
          memo: memo,
          status: 'pending',
          timestamp: now(),
          balanceUpdated: false
        };
        
        // Add to local history
        depositHistory.push(depositData);
        save({ depositHistory });
        
        // Mark user as having made a deposit (even if not yet approved)
        save({ hasDeposit: true });
        
        // Update promo code usage if applicable
        if (appliedPromoCode) {
          database.ref('promoCodes/' + appliedPromoCode).once('value').then(snap => {
            if (snap.exists()) {
              const promoData = snap.val();
              database.ref('promoCodes/' + appliedPromoCode).update({
                used: promoData.used + 1
              });
            }
          });
        }
        
        // Save to admin panel using push() to ensure proper Firebase structure
        database.ref('admin/deposits').push(depositData)
          .then((ref) => {
            // Update the record with the generated key as ID
            database.ref('admin/deposits/' + ref.key).update({ id: ref.key })
              .then(() => {
                console.log('Deposit saved to admin panel with ID:', ref.key);
                sendBot(` <b>Deposit Submitted</b>\\nAmount: $${amt.toFixed(2)} USDT\\nBonus: $${promoBonus.toFixed(2)} USDT\\nTotal: $${totalAmount.toFixed(2)} USDT\\nStatus: Pending\\nTX: ${tx}\\nID: ${ref.key}`);
                notify('Submitted. Awaiting approval.');
                showDepositHistoryModal();
              });
          })
          .catch(error => {
            console.error('Error saving deposit to admin panel:', error);
            notify('Error submitting deposit. Please try again.');
          });
      };
    }

    function showDepositHistoryModal() {
      const modal = document.getElementById('deposit-history-modal');
      const content = document.getElementById('deposit-history-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="card">
            <div class="section-title" style="font-size:18px">Deposit History</div>
            <div class="history-list">
              ${depositHistory.length?depositHistory.map(d=>`
                <div class="history-item">
                  <div class="history-header">
                    <div class="history-id">ID: ${d.id} <button class="copy" onclick="copy('${d.id}')"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div>
                  </div>
                  <div class="history-details">
                    <div class="history-amount">$${d.amount.toFixed(2)}${d.bonus ? ` + $${d.bonus.toFixed(2)} bonus` : ''}</div>
                    <div class="history-date">${new Date(d.timestamp*1000).toLocaleString()}</div>
                  </div>
                  ${d.promoCode ? `<div class="history-extra">Promo Code: ${d.promoCode}</div>` : ''}
                  ${d.txHash ? `<div class="history-extra">TX: ${d.txHash}</div>` : ''}
                </div>
              `).join(''):`<div class="section-subtitle" style="text-align:center">No deposits yet</div>`}
            </div>
          </div>
        `;
      }, 500);
    }

    function showWithdrawModal() {
      const modal = document.getElementById('withdraw-modal');
      const content = document.getElementById('withdraw-content');
      
      // Check if user has made at least one deposit (not necessarily approved)
      const hasDeposit = userData.hasDeposit || depositHistory.length > 0;
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="card">
            <div class="section-subtitle" style="text-align:center;margin-bottom:8px">Withdraw USDT (TON)</div>
            ${!hasDeposit ? `
              <div style="background:rgba(239,68,68,0.1);border:1px solid var(--accent-red);border-radius:12px;padding:12px;margin-bottom:16px;text-align:center">
                <div style="color:var(--accent-red);font-weight:700;margin-bottom:8px">Deposit Required</div>
                <div style="color:var(--text-secondary);font-size:13px">You need to make at least one deposit before you can withdraw funds.</div>
              </div>
            ` : ''}
            <label class="form-label">TON Address</label>
            <input id="wd_addr" class="input" placeholder="Enter TON wallet">
            <label class="form-label" style="margin-top:8px">Amount (min $0.10)</label>
            <input id="wd_amt" type="number" min="0.10" step="0.01" class="input" placeholder="Enter amount">
            <label class="form-label" style="margin-top:8px">Memo/Comment (optional)</label>
            <input id="wd_memo" class="input" placeholder="Enter memo">
            <button class="btn-primary" style="margin-top:10px" id="wd_go" ${!hasDeposit ? 'disabled' : ''}>${!hasDeposit ? 'Deposit Required' : 'Confirm Withdraw'}</button>
          </div>
        `;
        
        if (hasDeposit) {
          document.getElementById('wd_go').onclick = async ()=>{
            const addr=document.getElementById('wd_addr').value.trim();
            const amt=parseFloat(document.getElementById('wd_amt').value);
            const memo=document.getElementById('wd_memo').value.trim();
            if(!addr){ notify('Enter address'); return; }
            if(!amt || amt<0.10){ notify('Minimum $0.10'); return; }
            if(amt>usdtBalance){ notify('Insufficient balance'); return; }
            const id=generateId();
            
            // Create withdrawal record
            const withdrawalData = {
              id: id,
              userId: userId,
              userName: userName,
              amount: amt,
              address: addr,
              memo: memo,
              status: 'pending',
              timestamp: now(),
              balanceUpdated: true // Mark as already deducted from balance
            };
            
            // Add to local history
            withdrawHistory.push(withdrawalData);
            save({ withdrawHistory });
            
            // Instantly deduct from balance
            save({ usdtBalance: usdtBalance - amt });
            
            // Save to admin panel using push() to ensure proper Firebase structure
            database.ref('admin/withdrawals').push(withdrawalData)
              .then((ref) => {
                // Update the record with the generated key as ID
                database.ref('admin/withdrawals/' + ref.key).update({ id: ref.key })
                  .then(() => {
                    console.log('Withdrawal saved to admin panel with ID:', ref.key);
                    sendBot(` <b>Withdrawal Submitted</b>\\nAmount: $${amt.toFixed(2)} USDT\\nStatus: Pending\\nAddress: ${addr}\\nID: ${ref.key}`);
                    notify(`Withdrawal of $${amt} submitted. Amount deducted from balance.`);
                    showWithdrawHistoryModal();
                  });
              })
              .catch(error => {
                console.error('Error saving withdrawal to admin panel:', error);
                notify('Error submitting withdrawal. Please try again.');
                // Refund if error
                save({ usdtBalance: usdtBalance + amt });
              });
          };
        }
      }, 500);
    }

    function showWithdrawHistoryModal() {
      const modal = document.getElementById('withdraw-history-modal');
      const content = document.getElementById('withdraw-history-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="card">
            <div class="section-title" style="font-size:18px">Withdraw History</div>
            <div class="history-list">
              ${withdrawHistory.length?withdrawHistory.map(w=>`
                <div class="history-item">
                  <div class="history-header">
                    <div class="history-id">ID: ${w.id} <button class="copy" onclick="copy('${w.id}')"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div>
                  </div>
                  <div class="history-details">
                    <div class="history-amount">$${w.amount.toFixed(2)}</div>
                    <div class="history-date">${new Date(w.timestamp*1000).toLocaleString()}</div>
                  </div>
                  <div class="history-extra">To: ${w.address}</div>
                </div>
              `).join(''):`<div class="section-subtitle" style="text-align:center">No withdrawals yet</div>`}
            </div>
          </div>
        `;
      }, 500);
    }

    // EXV Token Withdraw Modal
    function showExvWithdrawModal() {
      const modal = document.getElementById('exv-withdraw-modal');
      
      // Update balance display
      document.getElementById('exvModalBalance').textContent = `${exvBalance} EXV`;
      document.getElementById('exvModalBalanceUsd').textContent = `$${(exvBalance * EXV_TOKEN_PRICE).toFixed(6)} USD`;
      
      // Reset form
      document.getElementById('exvWithdrawAmount').value = '';
      document.getElementById('exvWithdrawAddress').value = '';
      updateExvWithdrawCalculation();
      
      modal.style.display = 'flex';
    }
    
    function updateExvWithdrawCalculation() {
      const amount = parseFloat(document.getElementById('exvWithdrawAmount').value) || 0;
      const subtotal = amount * EXV_TOKEN_PRICE;
      const serviceFee = subtotal * 0.1; // 10% service fee
      const receiveAmount = subtotal - serviceFee;
      
      document.getElementById('exvAmountDisplay').textContent = `${amount} EXV`;
      document.getElementById('exvSubtotalDisplay').textContent = `$${subtotal.toFixed(6)}`;
      document.getElementById('exvFeeDisplay').textContent = `$${serviceFee.toFixed(6)}`;
      document.getElementById('exvReceiveDisplay').textContent = `$${receiveAmount.toFixed(6)}`;
    }
    
    function processExvWithdraw() {
      const amount = parseFloat(document.getElementById('exvWithdrawAmount').value) || 0;
      const address = document.getElementById('exvWithdrawAddress').value.trim();
      
      if (amount < 25000) {
        notify('Minimum withdrawal is 25,000 EXV tokens');
        return;
      }
      
      if (amount > exvBalance) {
        notify('Insufficient EXV balance');
        return;
      }
      
      if (!address) {
        notify('Please enter your TON wallet address');
        return;
      }
      
      const subtotal = amount * EXV_TOKEN_PRICE;
      const serviceFee = subtotal * 0.1; // 10% service fee
      const receiveAmount = subtotal - serviceFee;
      const id = generateId();
      
      // Create token withdrawal record
      const tokenWithdrawalData = {
        id: id,
        userId: userId,
        userName: userName,
        amount: amount,
        subtotal: subtotal,
        serviceFee: serviceFee,
        receiveAmount: receiveAmount,
        address: address,
        status: 'pending',
        timestamp: now(),
        balanceUpdated: true // Mark as already deducted from balance
      };
      
      // Add to local history
      tokenWithdrawHistory.push(tokenWithdrawalData);
      save({ tokenWithdrawHistory });
      
      // Instantly deduct from balance
      save({ exvBalance: exvBalance - amount });
      
      // Save to admin panel using push() to ensure proper Firebase structure
      database.ref('admin/tokenWithdrawals').push(tokenWithdrawalData)
        .then((ref) => {
          // Update the record with the generated key as ID
          database.ref('admin/tokenWithdrawals/' + ref.key).update({ id: ref.key })
            .then(() => {
              console.log('Token withdrawal saved to admin panel with ID:', ref.key);
              sendBot(` <b>EXV Token Withdrawal Submitted</b>\\nAmount: ${amount} EXV\\nSubtotal: $${subtotal.toFixed(6)} USDT\\nService Fee (10%): $${serviceFee.toFixed(6)} USDT\\nYou Will Receive: $${receiveAmount.toFixed(6)} USDT\\nStatus: Pending\\nAddress: ${address}\\nID: ${ref.key}`);
              notify(`Token withdrawal of ${amount} EXV submitted. Amount deducted from balance.`);
              
              // Close modal and show history
              document.getElementById('exv-withdraw-modal').style.display = 'none';
              showTokenWithdrawHistoryModal();
            });
        })
        .catch(error => {
          console.error('Error saving token withdrawal to admin panel:', error);
          notify('Error submitting token withdrawal. Please try again.');
          // Refund if error
          save({ exvBalance: exvBalance + amount });
        });
    }
    
    function showTokenWithdrawHistoryModal(){
      const modal = document.getElementById('token-withdraw-history-modal');
      const content = document.getElementById('token-withdraw-history-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        // Combine deposit and withdrawal history
        const allTransactions = [
          ...exvDepositHistory.map(d => ({...d, type: 'deposit'})),
          ...tokenWithdrawHistory.map(w => ({...w, type: 'withdrawal'}))
        ].sort((a, b) => b.timestamp - a.timestamp);
        
        content.innerHTML = `
          <div class="card">
            <div class="section-title" style="font-size:18px">EXV Deposit/Withdraw History</div>
            <div class="history-list">
              ${allTransactions.length ? allTransactions.map(t => `
                <div class="history-item">
                  <div class="history-header">
                    <div class="history-id">ID: ${t.id} <button class="copy" onclick="copy('${t.id}')"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div>
                    <div class="task-status ${t.type}">${t.type === 'deposit' ? 'Deposit' : 'Withdrawal'}</div>
                  </div>
                  <div class="history-details">
                    <div class="history-amount">${t.amount} EXV</div>
                    <div class="history-date">${new Date(t.timestamp*1000).toLocaleString()}</div>
                  </div>
                  ${t.type === 'withdrawal' ? `
                    <div class="history-extra">Subtotal: $${t.subtotal.toFixed(6)} USDT</div>
                    <div class="history-extra">Service Fee: $${t.serviceFee.toFixed(6)} USDT (10%)</div>
                    <div class="history-extra">You Will Receive: $${t.receiveAmount.toFixed(6)} USDT</div>
                    <div class="history-extra">To: ${t.address}</div>
                  ` : `
                    <div class="history-extra">Value: $${t.usdValue.toFixed(6)} USDT</div>
                  `}
                  ${t.txHash ? `<div class="history-extra">TX: ${t.txHash}</div>` : ''}
                </div>
              `).join('') : `<div class="section-subtitle" style="text-align:center">No EXV transactions yet</div>`}
            </div>
          </div>
        `;
      }, 500);
    }

    // EXV Deposit Modal - Enhanced Professional Design
    function showExvDepositModal() {
      const modal = document.getElementById('exv-deposit-modal');
      const content = document.getElementById('exv-deposit-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="exv-deposit-card">
            <div class="exv-deposit-title">Deposit EXV Tokens</div>
            <img src="${getImageUrl('qr', 'https://i.postimg.cc/g2mgknm3/Screenshot-2025-10-17-16-28-28-211-com-ton-keeper-edit.jpg')}" class="exv-deposit-qr" alt="QR Code">
            
            <div class="exv-deposit-info">
              <div class="row"><div>Network</div><div>TON <button class="copy" onclick="navigator.clipboard.writeText('TON')"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div></div>
              <div class="row"><div>Address</div><div style="font-family:monospace;word-break:break-all">UQBWOgFgB4B8qBCo8CNjDUNAtvUSosw4v7v9gkt0GVOaNLSz <button class="copy" id="cp_exv_addr"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div></div>
              
              <div class="exv-deposit-amount">
                <input id="exv_dep_amt" type="number" min="100000" step="1" class="input" placeholder="Enter amount">
                <span>EXV</span>
              </div>
              
              <div class="exv-deposit-usd" id="exv_dep_usd">
                <div>Total USDT to send: $0.00</div>
                <button class="copy" id="cp_exv_usd" style="margin-left: 8px; padding: 4px 8px; font-size: 12px;">Copy</button>
              </div>
              
              <label class="form-label" style="margin-top:8px">Transaction Hash</label>
              <input id="exv_txh" class="input" placeholder="Enter transaction hash">
              
              <button class="exv-deposit-submit" id="exv_dep_submit">Submit Deposit</button>
            </div>
          </div>
        `;
        
        // Copy address
        document.getElementById('cp_exv_addr').onclick=()=>copy('UQBWOgFgB4B8qBCo8CNjDUNAtvUSosw4v7v9gkt0GVOaNLSz');
        
        // Update USD value when amount changes
        document.getElementById('exv_dep_amt').oninput = () => {
          const amount = parseFloat(document.getElementById('exv_dep_amt').value) || 0;
          const usdValue = amount * EXV_TOKEN_PRICE;
          document.getElementById('exv_dep_usd').innerHTML = `
            <div>Total USDT to send: $${usdValue.toFixed(6)}</div>
            <button class="copy" id="cp_exv_usd" style="margin-left: 8px; padding: 4px 8px; font-size: 12px;">Copy</button>
          `;
          
          // Add event listener to the new copy button
          document.getElementById('cp_exv_usd').onclick = () => copy(usdValue.toFixed(6));
        };
        
        // Submit deposit
        document.getElementById('exv_dep_submit').onclick = () => {
          const amount = parseFloat(document.getElementById('exv_dep_amt').value);
          const txHash = document.getElementById('exv_txh').value.trim();
          
          if (!amount || amount < 100000) {
            notify('Minimum deposit is 100,000 EXV tokens');
            return;
          }
          
          if (!txHash) {
            notify('Please enter transaction hash');
            return;
          }
          
          const id = generateId();
          const usdValue = amount * EXV_TOKEN_PRICE;
          
          // Create EXV deposit record
          const exvDepositData = {
            id: id,
            userId: userId,
            userName: userName,
            amount: amount,
            usdValue: usdValue,
            txHash: txHash,
            status: 'pending',
            timestamp: now(),
            balanceUpdated: false
          };
          
          // Add to local history
          exvDepositHistory.push(exvDepositData);
          save({ exvDepositHistory });
          
          // Save to admin panel using push() to ensure proper Firebase structure
          database.ref('admin/exvDeposits').push(exvDepositData)
            .then((ref) => {
              // Update the record with the generated key as ID
              database.ref('admin/exvDeposits/' + ref.key).update({ id: ref.key })
                .then(() => {
                  console.log('EXV deposit saved to admin panel with ID:', ref.key);
                  sendBot(` <b>EXV Deposit Submitted</b>\\nAmount: ${amount} EXV\\nValue: $${usdValue.toFixed(6)} USD\\nStatus: Pending\\nTX: ${txHash}\\nID: ${ref.key}`);
                  notify('EXV deposit submitted. Awaiting approval.');
                  
                  // Reset form
                  document.getElementById('exv_dep_amt').value = '';
                  document.getElementById('exv_txh').value = '';
                  document.getElementById('exv_dep_usd').innerHTML = `
                    <div>Total USDT to send: $0.00</div>
                    <button class="copy" id="cp_exv_usd" style="margin-left: 8px; padding: 4px 8px; font-size: 12px;">Copy</button>
                  `;
                });
            })
            .catch(error => {
              console.error('Error saving EXV deposit to admin panel:', error);
              notify('Error submitting EXV deposit. Please try again.');
            });
        };
      }, 500);
    }

    function showExvDepositHistory() {
      // This function is now integrated into showExvDepositModal
      showExvDepositModal();
    }

    function showActivitiesModal(){
      const modal = document.getElementById('activities-modal');
      const content = document.getElementById('activities-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        const all=[...depositHistory.map(x=>({...x,type:'deposit'})),...withdrawHistory.map(x=>({...x,type:'withdraw'})),...tradeHistory.map(x=>({...x,type:'trade'}))].sort((a,b)=>b.timestamp-a.timestamp);
        content.innerHTML = `
          <div class="card">
            <div class="section-title" style="font-size:18px">Activities</div>
            <div class="history-list">
              ${all.length?all.map(a=>`
                <div class="history-item">
                  <div class="history-header">
                    <div class="history-id">${a.type}</div>
                    <div class="history-date">${new Date(a.timestamp*1000).toLocaleString()}</div>
                  </div>
                  <div class="history-details">
                    <div class="history-amount">${a.type==='deposit'?'+':a.type==='withdraw'?'-':''}$${(a.amount||0).toFixed? (a.amount||0).toFixed(2) : a.amount}</div>
                  </div>
                </div>
              `).join(''):`<div class="section-subtitle" style="text-align:center">No activities</div>`}
            </div>
          </div>
        `;
      }, 500);
    }

    function showTradesModal(){
      const modal = document.getElementById('trades-modal');
      const content = document.getElementById('trades-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        const list=Object.values(activeTrades);
        content.innerHTML = `
          <div class="card">
            <div class="section-title" style="font-size:18px">Active Trades</div>
            <div class="history-list">
              ${list.length?list.map(t=>{
                const p=TRADE_PLANS.find(pp=>pp.id===t.planId);
                const prog=(t.claimedDays/p.duration*100);
                return `
                  <div class="history-item">
                    <div class="history-header">
                      <div class="history-id">${p.name}</div>
                      <div class="history-amount" style="color:var(--accent-blue)">$${p.price}</div>
                    </div>
                    <div class="prog" style="margin-top:10px">
                      <div class="progbar"><div class="progfill" style="width:${prog}%"></div></div>
                      <div class="progtext">Progress: ${t.claimedDays}/${p.duration} days</div>
                    </div>
                    <div class="countdown">Next claim in: ${formatTime(86400-(now()-t.lastClaim))}</div>
                  </div>
                `;
              }).join(''): `<div class="section-subtitle" style="text-align:center">No active trades</div>`}
            </div>
          </div>
        `;
      }, 500);
    }

    // Micro Jobs Platform - Enhanced Professional Design
    function showMicrotasksModal() {
      const modal = document.getElementById('microtasks-modal');
      const content = document.getElementById('microtasks-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="microjobs-hero">
            <div class="microjobs-hero-title">Micro Jobs Platform</div>
            <div class="microjobs-hero-subtitle">Complete tasks and earn EXV tokens</div>
          </div>
          
          <div class="microjobs-stats">
            <div class="microjobs-stat-card">
              <div class="microjobs-stat-value" id="totalTasksCount">0</div>
              <div class="microjobs-stat-label">Total Tasks</div>
            </div>
            <div class="microjobs-stat-card">
              <div class="microjobs-stat-value" id="completedTasksCount">0</div>
              <div class="microjobs-stat-label">Completed</div>
            </div>
            <div class="microjobs-stat-card">
              <div class="microjobs-stat-value" id="totalEarningsValue">0</div>
              <div class="microjobs-stat-label">Total Earnings</div>
            </div>
          </div>
          
          <div class="microjobs-categories">
            ${microtaskCategories.map(cat => `
              <div class="microjobs-category ${activeMicrotaskCategory === cat ? 'active' : ''}" data-category="${cat}">${cat}</div>
            `).join('')}
          </div>
          
          <div class="microjobs-filter">
            <input type="text" class="microjobs-search" placeholder="Search tasks..." id="microtasksSearch">
            <select class="microjobs-sort" id="microtasksSort">
              <option value="newest">Newest</option>
              <option value="oldest">Oldest</option>
              <option value="reward_low">Reward: Low to High</option>
              <option value="reward_high">Reward: High to Low</option>
              <option value="popularity">Most Popular</option>
            </select>
          </div>
          
          <div id="microtasksList"></div>
        `;
        
        // Update stats
        updateMicroJobsStats();
        
        // Load tasks
        loadMicroJobsTasks();
        
        // Setup category filters
        document.querySelectorAll('.microjobs-category').forEach(cat => {
          cat.addEventListener('click', () => {
            activeMicrotaskCategory = cat.dataset.category;
            document.querySelectorAll('.microjobs-category').forEach(c => c.classList.remove('active'));
            cat.classList.add('active');
            loadMicroJobsTasks();
          });
        });
        
        // Setup search
        document.getElementById('microtasksSearch').addEventListener('input', (e) => {
          microtaskSearchTerm = e.target.value.toLowerCase();
          loadMicroJobsTasks();
        });
        
        // Setup sort
        document.getElementById('microtasksSort').addEventListener('change', (e) => {
          microtaskSortBy = e.target.value;
          loadMicroJobsTasks();
        });
        
        // Setup add task button
        document.getElementById('addMicrotaskBtn').addEventListener('click', showAddMicrotaskModal);
        
        // Setup admin button
        document.getElementById('adminMicrotasksBtn').addEventListener('click', showAdminModal);
        
        // Setup back button
        document.getElementById('backMicrotasksModal').addEventListener('click', () => {
          document.getElementById('microtasks-modal').style.display = 'none';
        });
      }, 500);
    }
    
    function updateMicroJobsStats() {
      // Count total tasks
      const totalTasks = Object.keys(microtasks).filter(taskId => 
        microtasks[taskId].status === 'active' && microtasks[taskId].remainingFunds >= microtasks[taskId].reward
      ).length;
      
      // Count completed tasks by current user
      let completedTasks = 0;
      let totalEarnings = 0;
      
      Object.keys(microtasks).forEach(taskId => {
        const task = microtasks[taskId];
        if (task.completedBy && task.completedBy[userId]) {
          completedTasks++;
          totalEarnings += task.reward;
        }
      });
      
      // Update UI
      document.getElementById('totalTasksCount').textContent = totalTasks;
      document.getElementById('completedTasksCount').textContent = completedTasks;
      document.getElementById('totalEarningsValue').textContent = totalEarnings;
    }
    
    function loadMicroJobsTasks() {
      const tasksList = document.getElementById('microtasksList');
      
      // Filter tasks
      let filteredTasks = Object.keys(microtasks).filter(taskId => {
        const task = microtasks[taskId];
        
        // Only show active tasks with enough funds
        if (task.status !== 'active' || task.remainingFunds < task.reward) {
          return false;
        }
        
        // Filter out tasks already submitted by user
        if (submittedTasks && submittedTasks[taskId]) {
          return false;
        }
        
        // Filter by category
        if (activeMicrotaskCategory !== 'All' && task.category !== activeMicrotaskCategory) {
          return false;
        }
        
        // Filter by search term
        if (microtaskSearchTerm && !task.name.toLowerCase().includes(microtaskSearchTerm) && 
            !task.description.toLowerCase().includes(microtaskSearchTerm)) {
          return false;
        }
        
        return true;
      });
      
      // Sort tasks
      filteredTasks.sort((a, b) => {
        const taskA = microtasks[a];
        const taskB = microtasks[b];
        
        switch (microtaskSortBy) {
          case 'oldest':
            return taskA.createdAt - taskB.createdAt;
          case 'reward_low':
            return taskA.reward - taskB.reward;
          case 'reward_high':
            return taskB.reward - taskA.reward;
          case 'popularity':
            const popularityA = taskA.completedBy ? Object.keys(taskA.completedBy).length : 0;
            const popularityB = taskB.completedBy ? Object.keys(taskB.completedBy).length : 0;
            return popularityB - popularityA;
          case 'newest':
          default:
            return taskB.createdAt - taskA.createdAt;
        }
      });
      
      // Render tasks
      if (filteredTasks.length === 0) {
        tasksList.innerHTML = `
          <div class="microjobs-empty-state">
            <div class="microjobs-empty-state-icon"></div>
            <div class="microjobs-empty-state-title">No tasks found</div>
            <div class="microjobs-empty-state-text">Try adjusting your filters or check back later</div>
            <button class="microjobs-empty-state-btn" onclick="activeMicrotaskCategory='All'; loadMicroJobsTasks();">Show All Tasks</button>
          </div>
        `;
      } else {
        tasksList.innerHTML = filteredTasks.map(taskId => {
          const task = microtasks[taskId];
          const isSubmitted = submittedTasks && submittedTasks[taskId];
          const leftToDo = Math.floor(task.remainingFunds / task.reward);
          const completedCount = task.completedBy ? Object.keys(task.completedBy).length : 0;
          const progressPercentage = task.totalFunds > 0 ? ((task.totalFunds - task.remainingFunds) / task.totalFunds * 100) : 0;
          
          return `
            <div class="microjobs-task-card">
              <div class="realtime-badge">LIVE</div>
              <div class="microjobs-task-header">
                <img src="${task.photo}" class="microjobs-task-image" alt="${task.name}">
                <div class="microjobs-task-info">
                  <div class="microjobs-task-title">${task.name}</div>
                  <div class="microjobs-task-reward">Reward: ${task.reward} EXV</div>
                </div>
              </div>
              
              <div class="microjobs-task-description">${task.description}</div>
              
              <div class="microjobs-task-meta">
                <div>Category: ${task.category || 'Other'}</div>
                <div>Created by: ${task.creatorName || 'Unknown'}</div>
              </div>
              
              <div class="microjobs-task-progress">
                <div class="microjobs-task-progress-bar">
                  <div class="microjobs-task-progress-fill" style="width: ${progressPercentage}%"></div>
                </div>
                <div class="microjobs-task-progress-text">
                  <span>${completedCount} completed</span>
                  <span>${leftToDo} left</span>
                </div>
              </div>
              
              <div class="microjobs-task-actions">
                ${isSubmitted ? 
                  `<button class="microjobs-task-btn submitted" disabled>Submitted</button>` :
                  `<button class="microjobs-task-btn primary" onclick="startMicrotask('${taskId}')">Start</button>`
                }
              </div>
            </div>
          `;
        }).join('');
      }
    }
    
    // Start Micro Task - Enhanced with proof submission
    window.startMicrotask = function(taskId) {
      const task = microtasks[taskId];
      
      if (!task) {
        notify('Task not found');
        return;
      }
      
      if (task.status !== 'active' || task.remainingFunds < task.reward) {
        notify('Task is not active');
        return;
      }
      
      if (submittedTasks && submittedTasks[taskId]) {
        notify('You have already submitted proof for this task');
        return;
      }
      
      // Open task link in new tab
      window.open(task.link, '_blank');
      
      // Mark task as started
      if (!userData.startedTasks) {
        userData.startedTasks = {};
      }
      userData.startedTasks[taskId] = {
        startedAt: now(),
        taskId: taskId
      };
      save({ startedTasks: userData.startedTasks });
      
      // Show proof submission modal
      showProofModal(taskId);
    };
    
    // Show Proof Submission Modal
    function showProofModal(taskId) {
      const modal = document.getElementById('proof-modal');
      const content = document.getElementById('proof-content');
      
      const task = microtasks[taskId];
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="proof-form">
            <div class="proof-form-title">Submit Task Proof</div>
            
            <div class="form-group">
              <label>Task</label>
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <img src="${task.photo}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                <div>
                  <div style="font-weight: 700;">${task.name}</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">Reward: ${task.reward} EXV</div>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Proof Description</label>
              <textarea id="proof_description" class="proof-input" placeholder="Describe how you completed this task"></textarea>
            </div>
            
            <div class="form-group">
              <label>Proof Image</label>
              <div class="proof-image-upload">
                <div class="proof-image-preview" id="proof_image_preview">
                  <div class="proof-image-placeholder"></div>
                </div>
                <input type="file" id="proof_image_input" accept="image/*" style="display: none;">
                <button class="image-upload-btn" onclick="document.getElementById('proof_image_input').click()">Choose Image</button>
              </div>
            </div>
            
            <button class="proof-submit-btn" id="submit_proof_btn">Submit Proof</button>
          </div>
        `;
        
        // Setup image upload
        document.getElementById('proof_image_input').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
              document.getElementById('proof_image_preview').innerHTML = `<img src="${event.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
          }
        });
        
        // Submit proof
        document.getElementById('submit_proof_btn').addEventListener('click', function() {
          const description = document.getElementById('proof_description').value.trim();
          const imagePreview = document.getElementById('proof_image_preview').querySelector('img');
          
          if (!description) {
            notify('Please enter proof description');
            return;
          }
          
          if (!imagePreview) {
            notify('Please upload a proof image');
            return;
          }
          
          // Create proof object
          const proofId = generateId();
          const proof = {
            id: proofId,
            taskId: taskId,
            taskName: task.name,
            userId: userId,
            userName: userName,
            userAvatar: userAvatar,
            description: description,
            image: imagePreview.src,
            submittedAt: now(),
            status: 'pending'
          };
          
          // Save proof to database
          if (!taskProofs[taskId]) {
            taskProofs[taskId] = {};
          }
          taskProofs[taskId][userId] = proof;
          database.ref('taskProofs/' + taskId + '/' + userId).set(proof);
          
          // Update user's submitted tasks
          if (!submittedTasks) {
            submittedTasks = {};
          }
          submittedTasks[taskId] = {
            submittedAt: now(),
            status: 'pending'
          };
          save({ submittedTasks: submittedTasks });
          
          // Send notification to task creator
          sendBot(` <b>New Task Proof Submitted</b>\\n\\n<b>Task:</b> ${task.name}\\n<b>User:</b> ${userName}\\n<b>Status:</b> Pending Review\\n\\nPlease review and approve or reject the proof.`, task.creatorId);
          
          // Update admin notification count
          adminNotifications++;
          updateAdminNotificationBadge();
          
          notify('Proof submitted successfully! Awaiting approval.');
          
          // Close modal and refresh tasks
          document.getElementById('proof-modal').style.display = 'none';
          loadMicroJobsTasks();
        });
      }, 500);
    }
    
    // Show Admin Modal - Enhanced Professional Design
    function showAdminModal() {
      const modal = document.getElementById('admin-modal');
      const content = document.getElementById('admin-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="admin-dashboard">
            <div class="admin-dashboard-title">Task Creator Dashboard</div>
            <div class="admin-dashboard-chart">
              <canvas id="adminChart"></canvas>
            </div>
            <div class="admin-dashboard-metrics">
              <div class="admin-metric-card">
                <div class="admin-metric-value" id="adminTotalEarnings">0 EXV</div>
                <div class="admin-metric-label">Total Earnings</div>
              </div>
              <div class="admin-metric-card">
                <div class="admin-metric-value" id="adminAvgCompletion">0%</div>
                <div class="admin-metric-label">Avg Completion</div>
              </div>
              <div class="admin-metric-card">
                <div class="admin-metric-value" id="adminActiveTasks">0</div>
                <div class="admin-metric-label">Active Tasks</div>
              </div>
              <div class="admin-metric-card">
                <div class="admin-metric-value" id="adminTotalClicks">0</div>
                <div class="admin-metric-label">Total Clicks</div>
              </div>
            </div>
          </div>
          
          <div class="admin-stats">
            <div class="admin-stat-card">
              <div class="admin-stat-value" id="adminCreatedTasks">0</div>
              <div class="admin-stat-label">Created Tasks</div>
            </div>
            <div class="admin-stat-card">
              <div class="admin-stat-value" id="adminTotalSpent">0 EXV</div>
              <div class="admin-stat-label">Total Spent</div>
            </div>
            <div class="admin-stat-card">
              <div class="admin-stat-value" id="adminAvailableFunds">0 EXV</div>
              <div class="admin-stat-label">Available Funds</div>
            </div>
            <div class="admin-stat-card">
              <div class="admin-stat-value" id="adminPendingProofs">0</div>
              <div class="admin-stat-label">Pending Proofs</div>
            </div>
          </div>
          
          <div class="admin-quick-actions">
            <button class="admin-quick-action-btn" onclick="showAddMicrotaskModal()">
              <span></span> Create Task
            </button>
            <button class="admin-quick-action-btn" onclick="showTaskTemplates()">
              <span></span> Task Templates
            </button>
            <button class="admin-quick-action-btn" onclick="showTaskAnalytics()">
              <span></span> Analytics
            </button>
            <button class="admin-quick-action-btn" onclick="exportTaskData()">
              <span></span> Export Data
            </button>
          </div>
          
          <div class="admin-filters">
            <button class="admin-filter-btn active" data-filter="all">All Tasks</button>
            <button class="admin-filter-btn" data-filter="active">Active</button>
            <button class="admin-filter-btn" data-filter="paused">Paused</button>
            <button class="admin-filter-btn" data-filter="pending">Pending</button>
          </div>
          
          <div class="microtasks-tabs">
            <button class="microtasks-tab active" data-tab="tasks">My Tasks</button>
            <button class="microtasks-tab" data-tab="proofs">Pending Proofs</button>
            <button class="microtasks-tab" data-tab="analytics">Analytics</button>
            <button class="microtasks-tab" data-tab="templates">Templates</button>
          </div>
          
          <div id="adminContent"></div>
        `;
        
        // Update stats
        updateAdminStats();
        
        // Initialize chart
        initAdminChart();
        
        // Setup filters
        document.querySelectorAll('.admin-filter-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.admin-filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const filter = btn.dataset.filter;
            filterAdminTasks(filter);
          });
        });
        
        // Setup tabs
        document.querySelectorAll('.microtasks-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            document.querySelectorAll('.microtasks-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            if (tab.dataset.tab === 'tasks') {
              showAdminTasks();
            } else if (tab.dataset.tab === 'proofs') {
              showAdminProofs();
            } else if (tab.dataset.tab === 'analytics') {
              showAdminAnalytics();
            } else if (tab.dataset.tab === 'templates') {
              showAdminTemplates();
            }
          });
        });
        
        // Show tasks by default
        showAdminTasks();
        
        // Setup close button
        document.getElementById('closeAdminModal').addEventListener('click', () => {
          document.getElementById('admin-modal').style.display = 'none';
        });
      }, 500);
    }
    
    // Initialize admin dashboard chart
    function initAdminChart() {
      const ctx = document.getElementById('adminChart');
      if (!ctx) return;
      
      // Calculate task data for chart
      const taskData = [];
      const taskLabels = [];
      
      Object.keys(myMicrotasks).forEach(taskId => {
        const task = myMicrotasks[taskId];
        taskLabels.push(task.name);
        taskData.push(task.totalClicks || 0);
      });
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: taskLabels,
          datasets: [{
            label: 'Task Clicks',
            data: taskData,
            backgroundColor: 'rgba(118, 75, 162, 0.7)',
            borderColor: 'rgba(118, 75, 162, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)'
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }
    
    // Filter admin tasks
    function filterAdminTasks(filter) {
      const filteredTasks = {};
      
      Object.keys(myMicrotasks).forEach(taskId => {
        const task = myMicrotasks[taskId];
        
        if (filter === 'all') {
          filteredTasks[taskId] = task;
        } else if (filter === 'active' && task.status === 'active') {
          filteredTasks[taskId] = task;
        } else if (filter === 'paused' && task.status === 'paused') {
          filteredTasks[taskId] = task;
        } else if (filter === 'pending' && task.status === 'pending') {
          filteredTasks[taskId] = task;
        }
      });
      
      renderAdminTasks(filteredTasks);
    }
    
    function updateAdminStats() {
      // Count created tasks
      const createdTasks = Object.keys(myMicrotasks).length;
      document.getElementById('adminCreatedTasks').textContent = createdTasks;
      
      // Calculate total spent and available funds
      let totalSpent = 0;
      let availableFunds = 0;
      let totalClicks = 0;
      let totalEarnings = 0;
      
      Object.keys(myMicrotasks).forEach(taskId => {
        const task = myMicrotasks[taskId];
        totalSpent += task.totalFunds - task.remainingFunds;
        availableFunds += task.remainingFunds;
        totalClicks += task.totalClicks || 0;
        
        // Calculate earnings from completed tasks
        if (task.completedBy) {
          Object.keys(task.completedBy).forEach(userId => {
            totalEarnings += task.reward;
          });
        }
      });
      
      document.getElementById('adminTotalSpent').textContent = totalSpent;
      document.getElementById('adminAvailableFunds').textContent = availableFunds;
      document.getElementById('adminTotalClicks').textContent = totalClicks;
      document.getElementById('adminTotalEarnings').textContent = totalEarnings;
      
      // Calculate average completion rate
      let avgCompletion = 0;
      if (Object.keys(myMicrotasks).length > 0) {
        let totalCompletion = 0;
        Object.keys(myMicrotasks).forEach(taskId => {
          const task = myMicrotasks[taskId];
          if (task.totalFunds > 0) {
            const completionRate = ((task.totalFunds - task.remainingFunds) / task.totalFunds) * 100;
            totalCompletion += completionRate;
          }
        });
        avgCompletion = Math.round(totalCompletion / Object.keys(myMicrotasks).length);
      }
      document.getElementById('adminAvgCompletion').textContent = avgCompletion + '%';
      
      // Count active tasks
      const activeTasks = Object.keys(myMicrotasks).filter(taskId => 
        myMicrotasks[taskId].status === 'active'
      ).length;
      document.getElementById('adminActiveTasks').textContent = activeTasks;
      
      // Count pending proofs
      let pendingProofs = 0;
      Object.keys(taskProofs).forEach(taskId => {
        if (myMicrotasks[taskId]) {
          Object.keys(taskProofs[taskId]).forEach(userId => {
            if (taskProofs[taskId][userId].status === 'pending') {
              pendingProofs++;
            }
          });
        }
      });
      
      document.getElementById('adminPendingProofs').textContent = pendingProofs;
      adminNotifications = pendingProofs;
      updateAdminNotificationBadge();
    }
    
    function showAdminTasks() {
      const content = document.getElementById('adminContent');
      
      if (Object.keys(myMicrotasks).length === 0) {
        content.innerHTML = `
          <div class="microjobs-empty-state">
            <div class="microjobs-empty-state-icon"></div>
            <div class="microjobs-empty-state-title">No tasks created</div>
            <div class="microjobs-empty-state-text">Create your first task to start earning</div>
            <button class="microjobs-empty-state-btn" onclick="document.getElementById('admin-modal').style.display='none'; showAddMicrotaskModal();">Create Task</button>
          </div>
        `;
        return;
      }
      
      content.innerHTML = `
        <div class="admin-task-list">
          ${Object.keys(myMicrotasks).map(taskId => {
            const task = myMicrotasks[taskId];
            const completedCount = task.completedBy ? Object.keys(task.completedBy).length : 0;
            const progressPercentage = task.totalFunds > 0 ? ((task.totalFunds - task.remainingFunds) / task.totalFunds * 100) : 0;
            const clickRate = task.totalFunds > 0 ? (task.totalClicks / task.totalFunds * 100).toFixed(1) : 0;
            
            return `
              <div class="admin-task-card">
                <div class="admin-task-header">
                  <img src="${task.photo}" class="admin-task-image" alt="${task.name}">
                  <div class="admin-task-info">
                    <div class="admin-task-name">${task.name}</div>
                    <div class="admin-task-reward">Reward: ${task.reward} EXV</div>
                  </div>
                  <div class="task-status ${task.status}">${task.status}</div>
                </div>
                
                <div class="admin-task-funds">
                  <div>Total Funds: ${task.totalFunds} EXV</div>
                  <div>Remaining: ${task.remainingFunds} EXV</div>
                </div>
                
                <div class="admin-task-metrics">
                  <div>Clicks: ${task.totalClicks || 0}</div>
                  <div>Click Rate: ${clickRate}%</div>
                  <div>Completed: ${completedCount}</div>
                </div>
                
                <div class="prog" style="margin: 8px 0">
                  <div class="progbar"><div class="progfill" style="width:${progressPercentage}%"></div></div>
                  <div class="progtext">Progress: ${completedCount} completed</div>
                </div>
                
                <div class="admin-task-actions">
                  <button class="admin-task-btn primary" onclick="addFundsToTask('${taskId}')">Add Funds</button>
                  <button class="admin-task-btn secondary" onclick="editTask('${taskId}')">Edit</button>
                  <button class="admin-task-btn danger" onclick="pauseTask('${taskId}')">${task.status === 'active' ? 'Pause' : 'Resume'}</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    function showAdminProofs() {
      const content = document.getElementById('adminContent');
      
      // Get all pending proofs for tasks created by this user
      const pendingProofs = [];
      
      Object.keys(taskProofs).forEach(taskId => {
        if (myMicrotasks[taskId]) {
          Object.keys(taskProofs[taskId]).forEach(userId => {
            const proof = taskProofs[taskId][userId];
            if (proof.status === 'pending') {
              pendingProofs.push({ taskId, userId, proof });
            }
          });
        }
      });
      
      if (pendingProofs.length === 0) {
        content.innerHTML = `
          <div class="microjobs-empty-state">
            <div class="microjobs-empty-state-icon"></div>
            <div class="microjobs-empty-state-title">No pending proofs</div>
            <div class="microjobs-empty-state-text">All submitted proofs have been reviewed</div>
          </div>
        `;
        return;
      }
      
      content.innerHTML = `
        <div class="admin-bulk-actions">
          <button class="admin-bulk-btn approve" onclick="approveAllProofs()">Approve All</button>
          <button class="admin-bulk-btn reject" onclick="rejectAllProofs()">Reject All</button>
        </div>
        
        <div class="admin-proof-list">
          ${pendingProofs.map(({ taskId, userId, proof }) => {
            const task = myMicrotasks[taskId];
            
            return `
              <div class="admin-proof-card">
                <div class="checkbox-container">
                  <input type="checkbox" id="proof_${proof.id}" class="proof-checkbox" data-task-id="${taskId}" data-user-id="${userId}">
                  <label for="proof_${proof.id}">Select for bulk action</label>
                </div>
                
                <div class="admin-proof-header">
                  <img src="${proof.userAvatar}" class="admin-proof-avatar" alt="${proof.userName}">
                  <div class="admin-proof-info">
                    <div class="admin-proof-name">${proof.userName}</div>
                    <div class="admin-proof-date">${new Date(proof.submittedAt * 1000).toLocaleString()}</div>
                  </div>
                </div>
                
                <div class="admin-proof-content">
                  <div style="font-weight: 700; margin-bottom: 4px;">Task: ${task.name}</div>
                  <div>${proof.description}</div>
                </div>
                
                <img src="${proof.image}" class="admin-proof-image" alt="Proof">
                
                <div class="admin-proof-actions">
                  <button class="admin-proof-btn approve" onclick="approveTaskProof('${taskId}', '${userId}')">Approve</button>
                  <button class="admin-proof-btn reject" onclick="rejectTaskProof('${taskId}', '${userId}')">Reject</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    function showAdminAnalytics() {
      const content = document.getElementById('adminContent');
      
      // Calculate analytics data
      let totalTasks = Object.keys(myMicrotasks).length;
      let activeTasks = 0;
      let pausedTasks = 0;
      let pendingTasks = 0;
      let totalClicks = 0;
      let totalCompletions = 0;
      let totalSpent = 0;
      let totalEarnings = 0;
      
      Object.keys(myMicrotasks).forEach(taskId => {
        const task = myMicrotasks[taskId];
        
        if (task.status === 'active') activeTasks++;
        else if (task.status === 'paused') pausedTasks++;
        else if (task.status === 'pending') pendingTasks++;
        
        totalClicks += task.totalClicks || 0;
        totalSpent += task.totalFunds - task.remainingFunds;
        
        if (task.completedBy) {
          totalCompletions += Object.keys(task.completedBy).length;
          totalEarnings += Object.keys(task.completedBy).length * task.reward;
        }
      });
      
      const avgCompletionRate = totalTasks > 0 ? (totalCompletions / totalTasks * 100).toFixed(1) : 0;
      const clickToCompletionRate = totalClicks > 0 ? (totalCompletions / totalClicks * 100).toFixed(1) : 0;
      const roi = totalSpent > 0 ? ((totalEarnings - totalSpent) / totalSpent * 100).toFixed(1) : 0;
      
      content.innerHTML = `
        <div class="admin-analytics">
          <div class="admin-analytics-title">Task Performance Analytics</div>
          <div class="admin-analytics-grid">
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Total Tasks</div>
              <div class="admin-analytics-value">${totalTasks}</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Active Tasks</div>
              <div class="admin-analytics-value">${activeTasks}</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Paused Tasks</div>
              <div class="admin-analytics-value">${pausedTasks}</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Pending Tasks</div>
              <div class="admin-analytics-value">${pendingTasks}</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Total Clicks</div>
              <div class="admin-analytics-value">${totalClicks}</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Total Completions</div>
              <div class="admin-analytics-value">${totalCompletions}</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Avg Completion Rate</div>
              <div class="admin-analytics-value">${avgCompletionRate}%</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Click to Completion</div>
              <div class="admin-analytics-value">${clickToCompletionRate}%</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Total Spent (EXV)</div>
              <div class="admin-analytics-value">${totalSpent}</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">Total Earned (EXV)</div>
              <div class="admin-analytics-value">${totalEarnings}</div>
            </div>
            <div class="admin-analytics-card">
              <div class="admin-analytics-label">ROI</div>
              <div class="admin-analytics-value">${roi}%</div>
            </div>
          </div>
        </div>
        
        <div class="admin-analytics" style="margin-top: 16px;">
          <div class="admin-analytics-title">Task Performance Chart</div>
          <div style="height: 200px;">
            <canvas id="taskPerformanceChart"></canvas>
          </div>
        </div>
      `;
      
      // Initialize performance chart
      setTimeout(() => {
        const ctx = document.getElementById('taskPerformanceChart');
        if (!ctx) return;
        
        const taskNames = [];
        const taskClicks = [];
        const taskCompletions = [];
        
        Object.keys(myMicrotasks).forEach(taskId => {
          const task = myMicrotasks[taskId];
          taskNames.push(task.name);
          taskClicks.push(task.totalClicks || 0);
          taskCompletions.push(task.completedBy ? Object.keys(task.completedBy).length : 0);
        });
        
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: taskNames,
            datasets: [
              {
                label: 'Clicks',
                data: taskClicks,
                backgroundColor: 'rgba(79, 172, 254, 0.7)',
                borderColor: 'rgba(79, 172, 254, 1)',
                borderWidth: 1
              },
              {
                label: 'Completions',
                data: taskCompletions,
                backgroundColor: 'rgba(67, 233, 123, 0.7)',
                borderColor: 'rgba(67, 233, 123, 1)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                  color: 'rgba(255, 255, 255, 0.7)'
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: 'rgba(255, 255, 255, 0.7)'
                }
              }
            },
            plugins: {
              legend: {
                labels: {
                  color: 'rgba(255, 255, 255, 0.7)'
                }
              }
            }
          }
        });
      }, 100);
    }
    
    function showAdminTemplates() {
      const content = document.getElementById('adminContent');
      
      const taskTemplates = [
        {
          name: 'Social Media Follow',
          category: 'Social Media',
          description: 'Follow our social media account and stay updated',
          reward: 1000,
          link: 'https://example.com/social'
        },
        {
          name: 'Join Telegram Channel',
          category: 'Social Media',
          description: 'Join our Telegram channel for latest updates',
          reward: 1500,
          link: 'https://t.me/example'
        },
        {
          name: 'App Download',
          category: 'App Downloads',
          description: 'Download our app and try it out',
          reward: 2000,
          link: 'https://example.com/app'
        },
        {
          name: 'Video Watch',
          category: 'Videos',
          description: 'Watch our promotional video and like it',
          reward: 800,
          link: 'https://example.com/video'
        }
      ];
      
      content.innerHTML = `
        <div class="admin-templates">
          <div class="admin-templates-title">Task Templates</div>
          <div class="admin-template-grid">
            ${taskTemplates.map((template, index) => `
              <div class="admin-template-card" onclick="useTaskTemplate(${index})">
                <div class="admin-template-icon"></div>
                <div class="admin-template-name">${template.name}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      // Store templates globally for use in the useTaskTemplate function
      window.taskTemplates = taskTemplates;
    }
    
    window.useTaskTemplate = function(index) {
      const template = window.taskTemplates[index];
      if (!template) return;
      
      currentEditingTaskId = null;
      showAddMicrotaskModal();
      
      // Pre-fill the form with template data after a short delay
      setTimeout(() => {
        document.getElementById('task_name').value = template.name;
        document.getElementById('task_link').value = template.link;
        document.getElementById('task_reward').value = template.reward;
        document.getElementById('task_description').value = template.description;
        document.getElementById('task_category').value = template.category;
      }, 500);
    };
    
    window.showTaskTemplates = function() {
      // Switch to templates tab
      document.querySelectorAll('.microtasks-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === 'templates') {
          tab.classList.add('active');
        }
      });
      showAdminTemplates();
    };
    
    window.showTaskAnalytics = function() {
      // Switch to analytics tab
      document.querySelectorAll('.microtasks-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === 'analytics') {
          tab.classList.add('active');
        }
      });
      showAdminAnalytics();
    };
    
    window.exportTaskData = function() {
      // Create CSV data from tasks
      let csvContent = "Task Name,Category,Reward,Status,Total Funds,Remaining Funds,Clicks,Completions\\n";
      
      Object.keys(myMicrotasks).forEach(taskId => {
        const task = myMicrotasks[taskId];
        const completedCount = task.completedBy ? Object.keys(task.completedBy).length : 0;
        
        csvContent += `${task.name},${task.category},${task.reward},${task.status},${task.totalFunds},${task.remainingFunds},${task.totalClicks || 0},${completedCount}\\n`;
      });
      
      // Create a blob and download
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `task_data_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      notify('Task data exported successfully');
    };
    
    // Approve Task Proof
    window.approveTaskProof = function(taskId, userId, isAutoApproved = false) {
      if (!taskProofs[taskId] || !taskProofs[taskId][userId]) {
        notify('Proof not found');
        return;
      }
      
      const proof = taskProofs[taskId][userId];
      const task = myMicrotasks[taskId];
      
      // Update proof status
      proof.status = 'approved';
      proof.reviewedAt = now();
      proof.autoApproved = isAutoApproved;
      
      // Save to database
      database.ref('taskProofs/' + taskId + '/' + userId).update(proof);
      
      // Update user's submitted tasks
      if (userData.submittedTasks && userData.submittedTasks[taskId]) {
        userData.submittedTasks[taskId].status = 'approved';
        save({ submittedTasks: userData.submittedTasks });
      }
      
      // Add reward to user's balance
      database.ref('users/' + userId).once('value').then(userSnap => {
        if (userSnap.exists()) {
          const userData = userSnap.val();
          const newBalance = (userData.exvBalance || 0) + task.reward;
          
          database.ref('users/' + userId).update({
            exvBalance: newBalance
          });
          
          // Send notification to user
          const message = isAutoApproved ? 
            ` <b>Proof Auto-Approved</b>\\nYour proof for "${task.name}" has been automatically approved after 48 hours.\\nReward: ${task.reward} EXV` :
            ` <b>Proof Approved</b>\\nYour proof for "${task.name}" has been approved.\\nReward: ${task.reward} EXV`;
          
          sendBot(message, userId);
        }
      });
      
      // Update task stats
      if (!task.completedBy) {
        task.completedBy = {};
      }
      task.completedBy[userId] = {
        approvedAt: now(),
        userId: userId,
        userName: proof.userName
      };
      
      // Deduct reward from task funds
      task.remainingFunds = task.remainingFunds - task.reward;
      task.totalClicks = (task.totalClicks || 0) + 1;
      
      // Update task in database
      database.ref('microtasks/' + taskId).update({
        completedBy: task.completedBy,
        remainingFunds: task.remainingFunds,
        totalClicks: task.totalClicks
      });
      
      // Update local task
      myMicrotasks[taskId] = task;
      microtasks[taskId] = task;
      
      // Update admin notification count
      adminNotifications--;
      updateAdminNotificationBadge();
      
      // Send notification to admin
      const adminMessage = isAutoApproved ?
        ` <b>Proof Auto-Approved</b>\\nProof for "${task.name}" by ${proof.userName} was automatically approved after 48 hours.` :
        ` <b>Proof Approved</b>\\nYou approved proof for "${task.name}" by ${proof.userName}.\\nReward: ${task.reward} EXV`;
      
      sendBot(adminMessage);
      
      notify(`Proof approved! ${proof.userName} earned ${task.reward} EXV`);
      
      // Refresh admin view
      if (document.getElementById('admin-modal').style.display === 'flex') {
        const activeTab = document.querySelector('.microtasks-tab.active').dataset.tab;
        if (activeTab === 'proofs') {
          showAdminProofs();
        } else if (activeTab === 'tasks') {
          showAdminTasks();
        }
        updateAdminStats();
      }
    };
    
    // Reject Task Proof
    window.rejectTaskProof = function(taskId, userId) {
      if (!taskProofs[taskId] || !taskProofs[taskId][userId]) {
        notify('Proof not found');
        return;
      }
      
      const proof = taskProofs[taskId][userId];
      const task = myMicrotasks[taskId];
      
      // Update proof status
      proof.status = 'rejected';
      proof.reviewedAt = now();
      
      // Save to database
      database.ref('taskProofs/' + taskId + '/' + userId).update(proof);
      
      // Update user's submitted tasks
      if (userData.submittedTasks && userData.submittedTasks[taskId]) {
        userData.submittedTasks[taskId].status = 'rejected';
        save({ submittedTasks: userData.submittedTasks });
      }
      
      // Allow user to resubmit
      if (submittedTasks && submittedTasks[taskId]) {
        delete submittedTasks[taskId];
        save({ submittedTasks: submittedTasks });
      }
      
      // Send notification to user
      sendBot(` <b>Proof Rejected</b>\\nYour proof for "${task.name}" has been rejected.\\nYou can submit a new proof.`, userId);
      
      // Update admin notification count
      adminNotifications--;
      updateAdminNotificationBadge();
      
      // Send notification to admin
      sendBot(` <b>Proof Rejected</b>\\nYou rejected proof for "${task.name}" by ${proof.userName}.`);
      
      notify(`Proof rejected! ${proof.userName} can submit a new proof.`);
      
      // Refresh admin view
      if (document.getElementById('admin-modal').style.display === 'flex') {
        const activeTab = document.querySelector('.microtasks-tab.active').dataset.tab;
        if (activeTab === 'proofs') {
          showAdminProofs();
        }
        updateAdminStats();
      }
    };
    
    // Approve All Proofs
    window.approveAllProofs = function() {
      const checkboxes = document.querySelectorAll('.proof-checkbox:checked');
      
      if (checkboxes.length === 0) {
        notify('Please select at least one proof');
        return;
      }
      
      checkboxes.forEach(checkbox => {
        const taskId = checkbox.dataset.taskId;
        const userId = checkbox.dataset.userId;
        approveTaskProof(taskId, userId);
      });
      
      notify(`Approved ${checkboxes.length} proofs`);
    };
    
    // Reject All Proofs
    window.rejectAllProofs = function() {
      const checkboxes = document.querySelectorAll('.proof-checkbox:checked');
      
      if (checkboxes.length === 0) {
        notify('Please select at least one proof');
        return;
      }
      
      checkboxes.forEach(checkbox => {
        const taskId = checkbox.dataset.taskId;
        const userId = checkbox.dataset.userId;
        rejectTaskProof(taskId, userId);
      });
      
      notify(`Rejected ${checkboxes.length} proofs`);
    };
    
    // Add Funds to Task
    window.addFundsToTask = function(taskId) {
      if (!myMicrotasks[taskId]) {
        notify('Task not found');
        return;
      }
      
      const task = myMicrotasks[taskId];
      const amount = prompt(`Enter amount of EXV to add to "${task.name}":`);
      
      if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
        notify('Invalid amount');
        return;
      }
      
      const exvAmount = parseFloat(amount);
      
      if (exvAmount > exvBalance) {
        notify('Insufficient EXV balance');
        return;
      }
      
      // Deduct from user balance
      save({ exvBalance: exvBalance - exvAmount });
      
      // Add to task funds
      task.remainingFunds += exvAmount;
      task.totalFunds += exvAmount;
      
      // Update in database
      database.ref('microtasks/' + taskId).update({
        remainingFunds: task.remainingFunds,
        totalFunds: task.totalFunds
      });
      
      // Update local task
      myMicrotasks[taskId] = task;
      microtasks[taskId] = task;
      
      notify(`Added ${exvAmount} EXV to task funds`);
      
      // Refresh admin view
      if (document.getElementById('admin-modal').style.display === 'flex') {
        showAdminTasks();
        updateAdminStats();
      }
    };
    
    // Edit Task
    window.editTask = function(taskId) {
      if (!myMicrotasks[taskId]) {
        notify('Task not found');
        return;
      }
      
      currentEditingTaskId = taskId;
      showEditMicrotaskModal();
    };
    
    // Pause/Resume Task
    window.pauseTask = function(taskId) {
      if (!myMicrotasks[taskId]) {
        notify('Task not found');
        return;
      }
      
      const task = myMicrotasks[taskId];
      const newStatus = task.status === 'active' ? 'paused' : 'active';
      
      // Update status
      task.status = newStatus;
      
      // Update in database
      database.ref('microtasks/' + taskId).update({
        status: newStatus
      });
      
      // Update local task
      myMicrotasks[taskId] = task;
      microtasks[taskId] = task;
      
      notify(`Task ${newStatus === 'active' ? 'resumed' : 'paused'}`);
      
      // Refresh admin view
      if (document.getElementById('admin-modal').style.display === 'flex') {
        showAdminTasks();
        updateAdminStats();
      }
    };

    // Show Add Micro Task Modal - Enhanced with fund management
    function showAddMicrotaskModal() {
      // Check if user has reached the maximum task limit
      if (userTaskCount >= 50) {
        notify('You have reached the maximum limit of 50 tasks');
        return;
      }
      
      // Check if user has EXV balance
      if (exvBalance < 1000) {
        notify('You need at least 1000 EXV tokens to create a task');
        return;
      }
      
      const modal = document.getElementById('add-microtask-modal');
      const content = document.getElementById('add-microtask-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="microtask-form">
            <div class="microtask-form-title">Create New Task</div>
            
            <div class="form-group">
              <label>Task Name</label>
              <input id="task_name" class="input" placeholder="Enter task name">
            </div>
            
            <div class="form-group">
              <label>Task Link</label>
              <input id="task_link" class="input" placeholder="Enter task URL">
            </div>
            
            <div class="form-group">
              <label>Reward (EXV tokens)</label>
              <input id="task_reward" type="number" min="1000" class="input" placeholder="Minimum 1000 EXV">
            </div>
            
            <div class="form-group">
              <label>Task Description</label>
              <textarea id="task_description" class="input" placeholder="Describe what users need to do"></textarea>
            </div>
            
            <div class="form-group">
              <label>Category</label>
              <select id="task_category" class="input">
                ${microtaskCategories.filter(cat => cat !== 'All').map(cat => 
                  `<option value="${cat}">${cat}</option>`
                ).join('')}
              </select>
            </div>
            
            <div class="form-group">
              <label>Task Photo</label>
              <div class="image-upload">
                <div class="image-preview" id="task_image_preview">
                  <div class="image-preview-placeholder"></div>
                </div>
                <input type="file" id="task_image_input" accept="image/*" style="display: none;">
                <button class="image-upload-btn" onclick="document.getElementById('task_image_input').click()">Choose Image</button>
              </div>
            </div>
            
            <div class="fund-info">
              <div class="fund-info-title">Initial Funds</div>
              <div class="fund-info-row">
                <div class="fund-info-label">Your Balance:</div>
                <div class="fund-info-value">${exvBalance} EXV</div>
              </div>
              <div class="fund-info-row">
                <div class="fund-info-label">Initial Amount:</div>
                <input type="number" id="task_initial_funds" min="1000" class="input" style="width: 100px; padding: 4px;">
              </div>
              <div class="fund-info-row">
                <div class="fund-info-label">Estimated Clicks:</div>
                <div class="fund-info-value" id="estimated_clicks">0</div>
              </div>
            </div>
            
            <button class="btn-primary" style="margin-top: 16px" id="create_task_btn">Create Task</button>
          </div>
        `;
        
        // Setup image upload
        document.getElementById('task_image_input').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
              document.getElementById('task_image_preview').innerHTML = `<img src="${event.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
          }
        });
        
        // Update estimated clicks when reward or initial funds change
        document.getElementById('task_reward').addEventListener('input', updateEstimatedClicks);
        document.getElementById('task_initial_funds').addEventListener('input', updateEstimatedClicks);
        
        function updateEstimatedClicks() {
          const reward = parseInt(document.getElementById('task_reward').value) || 1000;
          const funds = parseInt(document.getElementById('task_initial_funds').value) || 0;
          const clicks = Math.floor(funds / reward);
          document.getElementById('estimated_clicks').textContent = clicks;
        }
        
        // Create task button
        document.getElementById('create_task_btn').addEventListener('click', function() {
          const name = document.getElementById('task_name').value.trim();
          const link = document.getElementById('task_link').value.trim();
          const reward = parseInt(document.getElementById('task_reward').value) || 0;
          const description = document.getElementById('task_description').value.trim();
          const category = document.getElementById('task_category').value;
          const initialFunds = parseInt(document.getElementById('task_initial_funds').value) || 0;
          const imagePreview = document.getElementById('task_image_preview').querySelector('img');
          
          // Validation
          if (!name) {
            notify('Please enter task name');
            return;
          }
          
          if (!link) {
            notify('Please enter task link');
            return;
          }
          
          if (reward < 1000) {
            notify('Minimum reward is 1000 EXV');
            return;
          }
          
          if (initialFunds < reward) {
            notify('Initial funds must be at least equal to the reward');
            return;
          }
          
          if (initialFunds > exvBalance) {
            notify('Insufficient balance');
            return;
          }
          
          if (!imagePreview) {
            notify('Please upload a task image');
            return;
          }
          
          // Generate task ID
          const taskId = 'task_' + Date.now();
          
          // Create task object
          const task = {
            id: taskId,
            name: name,
            link: link,
            reward: reward,
            description: description,
            category: category,
            photo: imagePreview.src,
            creatorId: userId,
            creatorName: userName,
            status: 'pending', // Set to pending initially
            totalClicks: 0,
            remainingFunds: initialFunds,
            totalFunds: initialFunds,
            completedBy: {},
            createdAt: now()
          };
          
          // Deduct initial funds from user's balance in real-time
          const newBalance = exvBalance - initialFunds;
          save({ exvBalance: newBalance });
          
          // Update user task count
          const newUserTaskCount = userTaskCount + 1;
          save({ userTaskCount: newUserTaskCount });
          
          // Save to user's microtasks
          database.ref('userMicrotasks/' + userId + '/' + taskId).set(task);
          
          // Save to global microtasks
          database.ref('microtasks/' + taskId).set(task);
          
          // Save to admin panel for approval
          database.ref('admin/microtasks/' + taskId).set(task);
          
          // Update local tasks
          myMicrotasks[taskId] = task;
          microtasks[taskId] = task;
          
          // Send notification to admin with task details
          const taskMessage = ` <b>New Task Submitted for Approval</b>\\n\\n<b>Task Details:</b>\\nName: ${name}\\nCategory: ${category}\\nReward: ${reward} EXV\\nInitial Funds: ${initialFunds} EXV\\nDescription: ${description}\\nLink: ${link}\\n\\n<b>Creator:</b>\\nName: ${userName}\\nID: ${userId}\\n\\n<b>Status:</b> Pending Approval\\n\\n<b>Task ID:</b> ${taskId}`;
          sendBot(taskMessage);
          
          notify('Task created and submitted for approval');
          
          // Close modal and refresh
          document.getElementById('add-microtask-modal').style.display = 'none';
          showMicrotasksModal();
        });
      }, 500);
    }

    // Show Edit Micro Task Modal
    function showEditMicrotaskModal() {
      if (!currentEditingTaskId || !myMicrotasks[currentEditingTaskId]) {
        notify('Task not found');
        return;
      }
      
      const task = myMicrotasks[currentEditingTaskId];
      const modal = document.getElementById('edit-microtask-modal');
      const content = document.getElementById('edit-microtask-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        content.innerHTML = `
          <div class="edit-task-form">
            <div class="edit-task-title">Edit Task</div>
            
            <div class="form-group">
              <label>Task Name</label>
              <input id="edit_task_name" class="input" value="${task.name}">
            </div>
            
            <div class="form-group">
              <label>Task Link</label>
              <input id="edit_task_link" class="input" value="${task.link}">
            </div>
            
            <div class="form-group">
              <label>Reward (EXV tokens)</label>
              <input id="edit_task_reward" type="number" min="1000" class="input" value="${task.reward}">
            </div>
            
            <div class="form-group">
              <label>Task Description</label>
              <textarea id="edit_task_description" class="input">${task.description}</textarea>
            </div>
            
            <div class="form-group">
              <label>Category</label>
              <select id="edit_task_category" class="input">
                ${microtaskCategories.filter(cat => cat !== 'All').map(cat => 
                  `<option value="${cat}" ${cat === task.category ? 'selected' : ''}>${cat}</option>`
                ).join('')}
              </select>
            </div>
            
            <div class="form-group">
              <label>Task Photo</label>
              <div class="image-upload">
                <div class="image-preview" id="edit_task_image_preview">
                  <img src="${task.photo}" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <input type="file" id="edit_task_image_input" accept="image/*" style="display: none;">
                <button class="image-upload-btn" onclick="document.getElementById('edit_task_image_input').click()">Change Image</button>
              </div>
            </div>
            
            <div class="fund-info">
              <div class="fund-info-title">Task Funds</div>
              <div class="fund-info-row">
                <div class="fund-info-label">Total Funds:</div>
                <div class="fund-info-value">${task.totalFunds} EXV</div>
              </div>
              <div class="fund-info-row">
                <div class="fund-info-label">Remaining Funds:</div>
                <div class="fund-info-value">${task.remainingFunds} EXV</div>
              </div>
              <div class="fund-info-row">
                <div class="fund-info-label">Add More Funds:</div>
                <input type="number" id="edit_task_add_funds" min="100" class="input" style="width: 100px; padding: 4px;">
              </div>
            </div>
            
            <button class="btn-primary" style="margin-top: 16px" id="update_task_btn">Update Task</button>
          </div>
        `;
        
        // Setup image upload
        document.getElementById('edit_task_image_input').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
              document.getElementById('edit_task_image_preview').innerHTML = `<img src="${event.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
          }
        });
        
        // Update task button
        document.getElementById('update_task_btn').addEventListener('click', function() {
          const name = document.getElementById('edit_task_name').value.trim();
          const link = document.getElementById('edit_task_link').value.trim();
          const reward = parseInt(document.getElementById('edit_task_reward').value) || 0;
          const description = document.getElementById('edit_task_description').value.trim();
          const category = document.getElementById('edit_task_category').value;
          const addFunds = parseInt(document.getElementById('edit_task_add_funds').value) || 0;
          const imagePreview = document.getElementById('edit_task_image_preview').querySelector('img');
          
          // Validation
          if (!name) {
            notify('Please enter task name');
            return;
          }
          
          if (!link) {
            notify('Please enter task link');
            return;
          }
          
          if (reward < 1000) {
            notify('Minimum reward is 1000 EXV');
            return;
          }
          
          if (addFunds > 0 && addFunds > exvBalance) {
            notify('Insufficient balance');
            return;
          }
          
          // Update task object
          task.name = name;
          task.link = link;
          task.reward = reward;
          task.description = description;
          task.category = category;
          task.photo = imagePreview.src;
          
          if (addFunds > 0) {
            // Deduct from user balance
            save({ exvBalance: exvBalance - addFunds });
            
            // Add to task funds
            task.remainingFunds += addFunds;
            task.totalFunds += addFunds;
          }
          
          // Update in database
          database.ref('microtasks/' + currentEditingTaskId).update(task);
          database.ref('userMicrotasks/' + userId + '/' + currentEditingTaskId).update(task);
          
          // Update local task
          myMicrotasks[currentEditingTaskId] = task;
          microtasks[currentEditingTaskId] = task;
          
          notify('Task updated successfully');
          
          // Close modal and refresh
          document.getElementById('edit-microtask-modal').style.display = 'none';
          showAdminModal();
        });
      }, 500);
    }

    // Daily Check In - Enhanced Professional Design
    function showCheckInFullscreenModal() {
      const modal = document.getElementById('checkin-fullscreen-modal');
      const content = document.getElementById('checkin-fullscreen-content');
      
      // Show loading animation
      content.innerHTML = '<div class="circle-loader"><div></div><div></div><div></div></div>';
      modal.style.display = 'flex';
      
      // Load content after a short delay to show loading animation
      setTimeout(() => {
        const checkInDays = document.createElement('div');
        checkInDays.id = 'checkinDays';
        checkInDays.className = 'checkin-days';
        
        const currentStreakEl = document.createElement('div');
        currentStreakEl.id = 'currentStreak';
        currentStreakEl.className = 'checkin-streak-value';
        
        const calendarEl = document.createElement('div');
        calendarEl.id = 'checkinCalendar';
        calendarEl.className = 'checkin-calendar-grid';
        
        // Update streak display
        currentStreakEl.textContent = `${checkInData.currentStreak} days`;
        
        // Generate check-in days with hidden rewards
        let daysHtml = '';
        for (let i = 1; i <= 7; i++) {
          const reward = i * 0.10; // Day 1: $0.10, Day 2: $0.20, etc.
          const isClaimed = checkInData.claimedDays.includes(i);
          const isToday = canCheckInToday() && !isClaimed && i === (checkInData.currentStreak % 7) + 1;
          
          daysHtml += `
            <div class="checkin-day ${isClaimed ? 'claimed' : ''} ${isToday ? 'available' : ''}" data-day="${i}" data-reward="${reward}">
              <div class="checkin-day-number">Day ${i}</div>
              <div class="checkin-day-reward">$${reward.toFixed(2)}</div>
              <img src="${getImageUrl('USDT-Ton-Wallet', 'https://github.com/s42144/exotix-/blob/905718398cb21a62c6fdf857cdd51b8cb4c0774c/USDT-Ton-Wallet.png?raw=true')}" class="checkin-day-icon" alt="USDT">
              ${isClaimed ? '<div class="checkin-day-status claimed">Claimed</div>' : ''}
              ${isToday ? '<div class="checkin-day-status available">Available</div>' : ''}
            </div>
          `;
        }
        
        checkInDays.innerHTML = daysHtml;
        
        // Generate calendar for current month
        const nowDate = new Date();
        const year = nowDate.getFullYear();
        const month = nowDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        let calendarHtml = '';
        
        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
          calendarHtml += '<div class="calendar-day"></div>';
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const isCheckedIn = checkInData.monthlyCheckIns && checkInData.monthlyCheckIns[dateStr];
          const isToday = day === nowDate.getDate();
          
          calendarHtml += `<div class="calendar-day ${isCheckedIn ? 'checked-in' : ''} ${isToday ? 'today' : ''}">${day}</div>`;
        }
        
        calendarEl.innerHTML = calendarHtml;
        
        content.innerHTML = `
          <div class="checkin-content">
            <div class="checkin-header">
              <div class="checkin-title">Daily Check In</div>
            </div>
            
            <div class="checkin-streak">
              <div class="checkin-streak-title">Current Streak</div>
              <div class="checkin-streak-value" id="currentStreak">${checkInData.currentStreak} days</div>
            </div>
            
            <div class="checkin-days" id="checkinDays">
              ${daysHtml}
            </div>
            
            <div class="checkin-calendar">
              <div class="checkin-calendar-title">This Month</div>
              <div class="checkin-calendar-grid" id="checkinCalendar">
                ${calendarHtml}
              </div>
            </div>
          </div>
        `;
        
        // Add click event to available day with animation
        document.querySelectorAll('.checkin-day.available').forEach(day => {
          day.addEventListener('click', function() {
            const dayNumber = parseInt(this.dataset.day);
            const reward = parseFloat(this.dataset.reward);
            
            // Add animation effect
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
              this.style.transform = '';
              claimCheckIn(dayNumber, reward);
            }, 200);
          });
        });
      }, 500);
    }
    
    function canCheckInToday() {
      const today = new Date().toDateString();
      const lastCheckInDate = new Date(checkInData.lastCheckIn * 1000).toDateString();
      return today !== lastCheckInDate;
    }
    
    function claimCheckIn(dayNumber, reward) {
      if (!canCheckInToday()) {
        notify('You have already checked in today');
        return;
      }
      
      // Update check-in data
      const newClaimedDays = [...checkInData.claimedDays, dayNumber];
      const newStreak = checkInData.currentStreak + 1;
      
      // Reset streak if completed 7 days
      const resetStreak = newStreak % 7 === 0 ? 0 : newStreak;
      const resetClaimedDays = newStreak % 7 === 0 ? [] : newClaimedDays;
      
      // Add today to monthly check-ins
      const today = new Date();
      const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      const newMonthlyCheckIns = { ...(checkInData.monthlyCheckIns || {}), [dateStr]: true };
      
      const newCheckInData = {
        lastCheckIn: now(),
        currentStreak: resetStreak,
        claimedDays: resetClaimedDays,
        monthlyCheckIns: newMonthlyCheckIns
      };
      
      // Update in Firebase
      database.ref('users/' + userId + '/checkInData').set(newCheckInData);
      
      // Update local data
      checkInData = newCheckInData;
      
      // Add reward to balance
      const newBalance = usdtBalance + reward;
      const newExvBalance = exvBalance + (dayNumber * 10); // 10 EXV tokens per day
      database.ref('users/' + userId).update({
        usdtBalance: newBalance,
        exvBalance: newExvBalance,
        checkInData: newCheckInData
      });
      
      // Award referral commission for check-in earnings
      awardReferralCommission(reward);
      
      // Log the transaction
      const transaction = {
        type: 'checkin',
        amount: reward,
        exvAmount: dayNumber * 10,
        day: dayNumber,
        timestamp: now()
      };
      
      // Add to trade history
      const newTradeHistory = [...tradeHistory, transaction];
      database.ref('users/' + userId + '/tradeHistory').set(newTradeHistory);
      
      // Update local variables
      usdtBalance = newBalance;
      exvBalance = newExvBalance;
      tradeHistory = newTradeHistory;
      
      // Update UI
      document.getElementById('usdtBalance').textContent = fmt(usdtBalance);
      document.getElementById('exvBalance').textContent = exvBalance;
      notify(`Checked in Day ${dayNumber}! Earned $${reward.toFixed(2)} USDT and ${dayNumber * 10} EXV tokens`);
      
      // Refresh modal with animation
      setTimeout(() => {
        showCheckInFullscreenModal();
      }, 500);
    }

    // Earn
    function renderEarn(){
      const a = userData.adStats||{today:0,yesterday:0,thisWeek:0,thisMonth:0,lifetime:0};
      const html = `
        <div class="section-header">
          <div class="section-title">Earn USDT & EXV</div>
          <div class="section-subtitle">Watch ads and complete tasks</div>
        </div>

        <div class="card">
          <div class="section-subtitle" style="text-align:center;margin-bottom:8px">Ad Statistics</div>
          <canvas id="adChart" height="160"></canvas>
        </div>

        <div class="stats-row">
          <div class="stat-box"><div class="stat-box-label">Today</div><div class="stat-box-value">${a.today||0}</div></div>
          <div class="stat-box"><div class="stat-box-label">Yesterday</div><div class="stat-box-value">${a.yesterday||0}</div></div>
          <div class="stat-box"><div class="stat-box-label">This Week</div><div class="stat-box-value">${a.thisWeek||0}</div></div>
          <div class="stat-box"><div class="stat-box-label">This Month</div><div class="stat-box-value">${a.thisMonth||0}</div></div>
        </div>

        <div class="ad-card">
          <div class="ad-title">Watch Advertisement</div>
          <div class="ad-reward">Earn 0.000106 USDT + 50 EXV tokens per ad</div>
          <button class="btn-primary" id="watchAd">${adLoading?'Loading...':'Watch Ad'}</button>
        </div>

        <div class="milestone-card">
          <div class="milestone-header">
            <div class="milestone-icon">
              <img src="${getImageUrl('goals', 'https://github.com/s42144/exotix-/blob/496a65565dee1e8f41c9b1cf90a82966bca0ce27/goals.gif?raw=true')}" alt="Milestone" />
            </div>
            <div class="milestone-info">
              <div class="milestone-title">Milestone Rewards</div>
              <div class="milestone-reward">Complete ads to unlock rewards</div>
            </div>
          </div>
          ${[
            {id:'m100', need:100, amt:0.00213, label:'100 Ads', icon:'goals'},
            {id:'m200', need:200, amt:0.016,   label:'200 Ads', icon:'goals'},
            {id:'m500', need:500, amt:0.0213,  label:'500 Ads', icon:'goals'}
          ].map(m=>{
            const can = (a.lifetime||0)>=m.need && !userData.milestones?.[`milestone${m.need}Claimed`];
            const txt = userData.milestones?.[`milestone${m.need}Claimed`] ? 'Claimed' : (can?'Claim Now!':'Locked');
            const prog = Math.min((a.lifetime||0)/m.need*100, 100);
            return `
              <div class="milestone-progress">
                <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                  <div style="font-weight:700">${m.label}</div>
                  <div style="color:var(--accent-green);font-weight:700">${m.amt} USDT</div>
                </div>
                <div class="milestone-bar"><div class="milestone-fill" style="width:${prog}%"></div></div>
                <div class="milestone-text">${a.lifetime||0}/${m.need} ads completed</div>
                <button class="btn-primary" style="margin-top:8px" id="${m.id}" ${can?'':'disabled'}>${txt}</button>
              </div>
            `;
          }).join('')}
        </div>

        <div id="tasksList"></div>
      `;
      document.getElementById('main-content').innerHTML = html;

      // Chart
      setTimeout(()=>{
        const ctx=document.getElementById('adChart').getContext('2d');
        new Chart(ctx,{type:'bar',data:{labels:['Today','Yesterday','This Week','This Month'],
          datasets:[{label:'Ads',data:[a.today||0,a.yesterday||0,a.thisWeek||0,a.thisMonth||0],backgroundColor:['rgba(118, 75, 162, 0.8)','rgba(240, 147, 251, 0.8)','rgba(67, 233, 123, 0.8)','rgba(254, 225, 64, 0.8)'],borderWidth:0,borderRadius:8}]},
          options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'rgba(255, 255, 255, 0.7)'}},y:{beginAtZero:true,grid:{color:'rgba(255, 255, 255, 0.1)'},ticks:{color:'rgba(255, 255, 255, 0.7)'}}}}});
      },50);

      // Watch ad
      document.getElementById('watchAd').onclick = ()=>{
        if (adLoading) return;
        adLoading = true; document.getElementById('watchAd').textContent='Loading...';
        if (typeof window.show_10116329==='function'){
          window.show_10116329().then(()=>{
            adLoading=false; document.getElementById('watchAd').textContent='Watch Ad';
            const usdtReward=0.000106;
            const exvReward=50;
            const today=todayISO(), ws=weekStartISO(), ms=monthStartISO();
            if (userData.adStats.lastAdDate!==today){ userData.adStats.yesterday=userData.adStats.today; userData.adStats.today=0; userData.adStats.lastAdDate=today; }
            if (userData.adStats.lastWeekReset!==ws){ userData.adStats.thisWeek=0; userData.adStats.lastWeekReset=ws; }
            if (userData.adStats.lastMonthReset!==ms){ userData.adStats.thisMonth=0; userData.adStats.lastMonthReset=ms; }
            userData.adStats.today++; userData.adStats.thisWeek++; userData.adStats.thisMonth++; userData.adStats.lifetime++;
            
            // Award referral commission for ad earnings
            awardReferralCommission(usdtReward);
            
            save({ 
              usdtBalance: usdtBalance+usdtReward, 
              exvBalance: exvBalance+exvReward,
              adStats: userData.adStats 
            });
            notify(`Earned ${usdtReward} USDT and ${exvReward} EXV tokens`);
            renderEarn();
          }).catch(()=>{
            adLoading=false; document.getElementById('watchAd').textContent='Watch Ad';
            notify('Ad failed. Try again');
          });
        }else{
          adLoading=false; document.getElementById('watchAd').textContent='Watch Ad';
          notify('Ad service unavailable');
        }
      };

      // Milestones
      const setMilestone=(need,amt)=>{
        const key=`milestone${need}Claimed`;
        if ((userData.adStats?.lifetime||0)>=need && !userData.milestones?.[key]){
          const ms={...(userData.milestones||{}), [key]:true };
          save({ usdtBalance: usdtBalance+amt, milestones: ms });
          notify(`Claimed ${amt} USDT`);
          renderEarn();
        }
      };
      const b100=document.getElementById('m100'); if(b100) b100.onclick=()=>setMilestone(100,0.00213);
      const b200=document.getElementById('m200'); if(b200) b200.onclick=()=>setMilestone(200,0.016);
      const b500=document.getElementById('m500'); if(b500) b500.onclick=()=>setMilestone(500,0.0213);

      loadTasks();
    }

    function loadTasks(){
      database.ref('tasks').once('value').then(s=>{
        const tasks=s.exists()?s.val():{};
        const categories = ['Project', 'Partner', 'Advertise'];
        let html='';
        
        categories.forEach(category=>{
          const categoryTasks = Object.keys(tasks).filter(id => tasks[id].category === category);
          if(categoryTasks.length > 0){
            html += `
              <div class="task-category">
                <div class="category-header">
                  <div class="category-icon">
                    <img src="${getImageUrl(category === 'Project' ? 'model' : category === 'Partner' ? 'friendship' : 'marketing-automation', 
                      `https://github.com/s42144/exotix-/blob/${category === 'Project' ? '29dc0282b344b026c4f18acde308b3779badd1a1/model.gif' : category === 'Partner' ? 'b56afa622aaee6a9f632b2939acf4035a86c6105/friendship.gif' : 'fc296e03613068e2158e4841cf691c2f369470eb/marketing-automation.gif'}?raw=true`)}" alt="${category}" />
                  </div>
                  <div class="category-title">${category}</div>
                </div>
                ${categoryTasks.map(id=>{
                  const t=tasks[id]; const done = !!(userData.completedTasks&&userData.completedTasks[id]);
                  return `
                    <div class="task-card">
                      <img src="${t.photo}" class="task-image" alt="${t.name}">
                      <div class="task-info">
                        <div class="task-name">${t.name}</div>
                        <div class="task-reward">+${t.amount} USDT</div>
                      </div>
                      <button class="task-btn ${done?'completed':''}" data-id="${id}">${done?'Done':'Start'}</button>
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          }
        });
        
        const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="section-subtitle" style="text-align:center;margin-bottom:8px;font-weight:800">Tasks</div>${html||'<div class="section-subtitle" style="text-align:center">No tasks available</div>'}`;
        document.getElementById('main-content').appendChild(c);

        document.querySelectorAll('.task-btn').forEach(btn=>{
          btn.onclick=()=>{
            const id=btn.dataset.id; const t=tasks[id]; if(!t) return;
            if (userData.completedTasks && userData.completedTasks[id]){ window.open(t.link,'_blank'); return; }
            if (pendingTaskRewards[id]){ notify('Processing...'); return; }
            pendingTaskRewards[id]=true; btn.disabled=true; btn.textContent='Processing...';
            window.open(t.link,'_blank');
            setTimeout(()=>{
              if (!userData.completedTasks) userData.completedTasks={};
              userData.completedTasks[id]=true;
              const add=parseFloat(t.amount)||0;
              
              // Award referral commission for task earnings
              awardReferralCommission(add);
              
              save({ usdtBalance: usdtBalance+add, completedTasks: userData.completedTasks });
              pendingTaskRewards[id]=false; btn.textContent='Done'; notify(`+${add} USDT`);
            },15000);
          };
        });
      });
    }

    // Profile
    function renderProfile(){
      const html=`
        <div class="section-header">
          <div class="section-title">Profile</div>
          <div class="section-subtitle">Account settings and referrals</div>
        </div>

        <div class="card" style="text-align:center">
          <img src="${userData.avatar}" alt="avatar" style="width:110px;height:110px;border-radius:50%;border:4px solid var(--accent-purple);object-fit:cover;box-shadow:0 8px 24px rgba(0,0,0,.3);margin-bottom:8px">
          <div style="font-weight:800">${userData.name}</div>
          <div style="margin-top:6px"><span class="section-subtitle">ID:</span> <span style="color:var(--accent-purple);font-weight:800">${userId}</span> <button class="copy" id="copyUid"><img src="${getImageUrl('copy', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/copy%20(1).gif?raw=true')}" alt="Copy"></button></div>
        </div>

        <div class="card">
          <div class="section-subtitle" style="text-align:center;margin-bottom:8px;font-weight:800">TON Wallet</div>
          <input id="tonWallet" class="input" placeholder="Enter your TON wallet" value="${userData.ton||''}">
          <button class="btn-primary" style="margin-top:10px" id="saveTon">Save</button>
        </div>

        <div class="card">
          <div class="section-subtitle" style="text-align:center;margin-bottom:8px;font-weight:800">Referral</div>
          <div class="row"><div>Link</div><div style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="refLink">https://t.me/exotix_trade_bot/app?startapp=${userId}</div></div>
          <button class="btn-primary" style="margin-top:10px" id="copyRef">Copy Link</button>
        </div>

        <div class="referral-card">
          <div class="referral-header">
            <div class="referral-icon">
              <img src="${getImageUrl('referral', 'https://github.com/s42144/exotix-/blob/13c543e32ffe13e350713106bd03d3986ecc9c37/referral.gif?raw=true')}" alt="Referrals" />
            </div>
            <div class="referral-title">My Referrals</div>
          </div>
          <div class="referral-stats">
            <div class="referral-stat">
              <div class="referral-stat-label">Refer Count</div>
              <div class="referral-stat-value">${referralCount||0}</div>
            </div>
            <div class="referral-stat">
              <div class="referral-stat-label">Total Earnings</div>
              <div class="referral-stat-value">${fmt((referralCount||0) * 0.20 + totalReferralCommission)} USDT</div>
            </div>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;text-align:center">
            Earn $0.20 for each referral + 20% of their total earnings
          </div>
          <button class="btn-primary" id="viewReferralsBtn">View My Referrals</button>
        </div>

        <div class="card">
          <div class="section-subtitle" style="text-align:center;margin-bottom:8px;font-weight:800">Redeem Code</div>
          <input id="redeem" maxlength="8" class="input" placeholder="Enter 8-digit code">
          <button class="btn-primary" style="margin-top:10px" id="redeemGo">Redeem</button>
        </div>
      `;
      document.getElementById('main-content').innerHTML = html;
      document.getElementById('copyUid').onclick=()=>copy(userId);
      document.getElementById('saveTon').onclick=()=>{
        const w=document.getElementById('tonWallet').value.trim();
        if(w.length<10){ notify('Invalid TON wallet'); return; }
        save({ ton:w });
        database.ref('admin/tonSubmissions').push({ userId, userName, walletAddress:w, timestamp:now(), balance:usdtBalance });
        notify('Wallet saved');
      };
      document.getElementById('copyRef').onclick=()=>copy(document.getElementById('refLink').textContent);
      document.getElementById('redeemGo').onclick=()=>{
        const code=document.getElementById('redeem').value.trim(); if(code.length!==8){ notify('Enter valid 8-digit code'); return; }
        database.ref('redeemCodes/'+code).once('value').then(s=>{
          if(!s.exists()){ notify('Invalid or used'); return; }
          const codeData = s.val();
          
          // Check if code has reached max users
          if (codeData.used >= codeData.maxUsers) {
            notify('This code has reached its maximum usage limit');
            return;
          }
          
          // Calculate random reward between 0.01 and 0.20
          const reward = Math.random() * (0.20 - 0.01) + 0.01;
          
          // Update code usage
          database.ref('redeemCodes/' + code).update({
            used: codeData.used + 1
          });
          
          save({ usdtBalance: usdtBalance + reward });
          notify(`Redeemed ${fmt(reward)} USDT`);
          document.getElementById('redeem').value='';
        });
      };

      // View Referrals Button
      document.getElementById('viewReferralsBtn').onclick = showReferralList;
    }

    function showReferralList() {
      const modal = document.getElementById('referralModal');
      const content = document.getElementById('referralListContent');
      
      database.ref('users')
        .orderByChild('referredBy')
        .equalTo(userId)
        .once('value')
        .then(snapshot => {
          if (snapshot.numChildren() === 0) {
            content.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--text-secondary);font-size:14px">You haven\\'t referred anyone yet. Share your referral link to start earning!</div>';
          } else {
            let html = '';
            snapshot.forEach(child => {
              const referredUser = child.val();
              const referredUserId = child.key;
              
              const commissionFromUser = userData.referralCommissions && userData.referralCommissions[referredUserId] 
                ? userData.referralCommissions[referredUserId] 
                : 0;
              
              html += `
                <div class="referral-item">
                  <img src="${referredUser.avatar || userAvatar}" class="referral-avatar" alt="${referredUser.name}" />
                  <div class="referral-info">
                    <div class="referral-name">${referredUser.name || 'Unknown'}</div>
                    <div class="referral-id">ID: ${referredUserId}</div>
                    <div class="referral-balance">${fmt(referredUser.usdtBalance || 0)} USDT</div>
                    <div class="referral-commission">Commission: ${fmt(commissionFromUser)} USDT</div>
                  </div>
                </div>
              `;
            });
            content.innerHTML = html;
          }
          
          modal.style.display = 'flex';
        });
    }

    // Ranking
    function renderRanking(){
      const html=`
        <div class="section-header">
          <div class="section-title">Leaderboard</div>
          <div class="section-subtitle">Top 50 by USDT balance</div>
        </div>
        <div class="ranking-position">
          <div class="section-subtitle">Your Position</div>
          <div id="myPosition" style="font-size:22px;font-weight:800;margin-top:4px">Loading...</div>
        </div>
        <div id="rankingList"></div>
      `;
      document.getElementById('main-content').innerHTML = html;

      if (rankingListener) database.ref('users').off('value', rankingListener);
      
      // Use limitToLast for better performance and real-time updates
      rankingListener = database.ref('users').orderByChild('usdtBalance').limitToLast(100);
      rankingListener.on('value',(snap)=>{
        const arr=[];
        snap.forEach(ch=>{
          const u=ch.val();
          arr.push({ id:ch.key, name:u.name||'Unknown', avatar:u.avatar||userAvatar, balance:u.usdtBalance||0 });
        });
        arr.sort((a,b)=>b.balance-a.balance);
        const top=arr.slice(0,50);
        const myPos = arr.findIndex(x=>x.id===userId)+1;
        document.getElementById('myPosition').textContent = myPos>0?('#'+myPos):'Unranked';
        document.getElementById('rankingList').innerHTML = top.map((u,i)=>`
          <div class="ranking-row">
            <div class="ranking-position-num ${i<3?'top3':''}">${i+1}</div>
            <img src="${u.avatar}" class="ranking-avatar">
            <div class="ranking-user-info">
              <div class="ranking-user-name">${u.name}</div>
              <div class="ranking-user-id">ID: ${u.id}</div>
            </div>
            <div class="ranking-balance">${fmt(u.balance)} USDT</div>
          </div>
        `).join('');
      });
    }

    // Modal Close
    document.getElementById('closeReferralModal').addEventListener('click', () => {
      document.getElementById('referralModal').style.display = 'none';
    });
    
    document.getElementById('referralModal').addEventListener('click', (e) => {
      if (e.target.id === 'referralModal') {
        document.getElementById('referralModal').style.display = 'none';
      }
    });
    
    document.getElementById('closeCheckin').addEventListener('click', () => {
      document.getElementById('checkin-modal').style.display = 'none';
    });
    
    document.getElementById('checkin-modal').addEventListener('click', (e) => {
      if (e.target.id === 'checkin-modal') {
        document.getElementById('checkin-modal').style.display = 'none';
      }
    });
    
    document.getElementById('closeExvWithdraw').addEventListener('click', () => {
      document.getElementById('exv-withdraw-modal').style.display = 'none';
    });
    
    document.getElementById('exv-withdraw-modal').addEventListener('click', (e) => {
      if (e.target.id === 'exv-withdraw-modal') {
        document.getElementById('exv-withdraw-modal').style.display = 'none';
      }
    });
    
    // Full Screen Modal Close Events
    document.getElementById('closeDepositModal').addEventListener('click', () => {
      document.getElementById('deposit-modal').style.display = 'none';
    });
    
    document.getElementById('closeWithdrawModal').addEventListener('click', () => {
      document.getElementById('withdraw-modal').style.display = 'none';
    });
    
    document.getElementById('closeCheckinFullscreenModal').addEventListener('click', () => {
      document.getElementById('checkin-fullscreen-modal').style.display = 'none';
    });
    
    document.getElementById('closeDepositHistoryModal').addEventListener('click', () => {
      document.getElementById('deposit-history-modal').style.display = 'none';
    });
    
    document.getElementById('closeWithdrawHistoryModal').addEventListener('click', () => {
      document.getElementById('withdraw-history-modal').style.display = 'none';
    });
    
    document.getElementById('closeTokenWithdrawHistoryModal').addEventListener('click', () => {
      document.getElementById('token-withdraw-history-modal').style.display = 'none';
    });
    
    document.getElementById('closeActivitiesModal').addEventListener('click', () => {
      document.getElementById('activities-modal').style.display = 'none';
    });
    
    document.getElementById('closeTradesModal').addEventListener('click', () => {
      document.getElementById('trades-modal').style.display = 'none';
    });
    
    // Micro Tasks Modal Close Events
    document.getElementById('closeMicrotasksModal').addEventListener('click', () => {
      document.getElementById('microtasks-modal').style.display = 'none';
    });
    
    document.getElementById('closeAddMicrotaskModal').addEventListener('click', () => {
      document.getElementById('add-microtask-modal').style.display = 'none';
    });
    
    document.getElementById('closeEditMicrotaskModal').addEventListener('click', () => {
      document.getElementById('edit-microtask-modal').style.display = 'none';
    });
    
    // Proof Modal Close Events
    document.getElementById('closeProofModal').addEventListener('click', () => {
      document.getElementById('proof-modal').style.display = 'none';
    });
    
    // Admin Modal Close Events
    document.getElementById('closeAdminModal').addEventListener('click', () => {
      document.getElementById('admin-modal').style.display = 'none';
    });
    
    // EXV Deposit Modal Close Events
    document.getElementById('closeExvDepositModal').addEventListener('click', () => {
      document.getElementById('exv-deposit-modal').style.display = 'none';
    });
    
    // EXV Withdraw Modal Events
    document.getElementById('exvWithdrawAmount').addEventListener('input', updateExvWithdrawCalculation);
    document.getElementById('exvWithdrawBtn').addEventListener('click', processExvWithdraw);

    // Nav events
    document.querySelectorAll('.nav-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>showTab(btn.dataset.tab));
    });

    // Bootstrap app
    async function bootstrap(){
      getTelegramUserData();
      await loadCryptoPrices();
      loadImageResources(); // Load image resources from Firebase
      loadMicroTasks(); // Load microtasks
      try{
        userData = await loadUser();
        
        // Initialize check-in data
        if (userData.checkInData) {
          checkInData = userData.checkInData;
        }
        
        // Initialize EXV balance
        if (userData.exvBalance !== undefined) {
          exvBalance = userData.exvBalance;
        }
        
        // Initialize token withdrawal history
        if (userData.tokenWithdrawHistory) {
          tokenWithdrawHistory = userData.tokenWithdrawHistory;
        }
        
        // Initialize EXV deposit history
        if (userData.exvDepositHistory) {
          exvDepositHistory = userData.exvDepositHistory;
        }
        
        // Initialize microtask earnings
        if (userData.microtaskEarnings !== undefined) {
          microtaskEarnings = userData.microtaskEarnings;
        }
        
        // Initialize user task count
        if (userData.userTaskCount !== undefined) {
          userTaskCount = userData.userTaskCount;
        }
        
        // Initialize submitted tasks
        if (userData.submittedTasks) {
          submittedTasks = userData.submittedTasks;
        }
        
        // Initialize last commission notification time
        if (userData.lastCommissionNotification) {
          lastCommissionNotification = userData.lastCommissionNotification;
        }
        
        // Send welcome message with inline buttons for new users
        if (!userData.welcomed) {
          sendWelcomeMessage(userId);
          save({ welcomed: true });
        }
      }catch{
        // local fallback
        const loc = localStorage.getItem('exotix_user_'+userId);
        userData = loc ? JSON.parse(loc) : { 
          usdtBalance:0, 
          exvBalance:0,
          purchasedPlans:{}, activeTrades:{}, 
          depositHistory:[], withdrawHistory:[], tradeHistory:[], 
          avatar:userAvatar, name:userName, referrals:0, completedTasks:{}, 
          adStats:{today:0,yesterday:0,thisWeek:0,thisMonth:0,lifetime:0,lastAdDate:todayISO(),lastWeekReset:weekStartISO(),lastMonthReset:monthStartISO()}, 
          milestones:{ milestone100Claimed:false, milestone200Claimed:false, milestone500Claimed:false }, 
          referralCommissions:{}, totalReferralCommission:0, createdAt: now(), 
          referredBy: null, referralCode: null, welcomed: false, lastCommissionNotification: 0,
          checkInData: {
            lastCheckIn: 0,
            currentStreak: 0,
            claimedDays: [],
            monthlyCheckIns: {}
          },
          hasDeposit: false, // Track if user has made any deposit
          tokenWithdrawHistory: [], // Initialize token withdrawal history
          exvDepositHistory: [], // Initialize EXV deposit history
          microtaskEarnings: 0, // Initialize microtask earnings
          userTaskCount: 0, // Initialize user task count
          submittedTasks: {} // Initialize submitted tasks
        };
        
        // Initialize check-in data
        if (userData.checkInData) {
          checkInData = userData.checkInData;
        }
        
        // Initialize EXV balance
        if (userData.exvBalance !== undefined) {
          exvBalance = userData.exvBalance;
        }
        
        // Initialize token withdrawal history
        if (userData.tokenWithdrawHistory) {
          tokenWithdrawHistory = userData.tokenWithdrawHistory;
        }
        
        // Initialize EXV deposit history
        if (userData.exvDepositHistory) {
          exvDepositHistory = userData.exvDepositHistory;
        }
        
        // Initialize microtask earnings
        if (userData.microtaskEarnings !== undefined) {
          microtaskEarnings = userData.microtaskEarnings;
        }
        
        // Initialize user task count
        if (userData.userTaskCount !== undefined) {
          userTaskCount = userData.userTaskCount;
        }
        
        // Initialize submitted tasks
        if (userData.submittedTasks) {
          submittedTasks = userData.submittedTasks;
        }
        
        // Initialize last commission notification time
        if (userData.lastCommissionNotification) {
          lastCommissionNotification = userData.lastCommissionNotification;
        }
        
        // Send welcome message for new users in fallback mode
        if (!userData.welcomed) {
          sendWelcomeMessage(userId);
          userData.welcomed = true;
          localStorage.setItem('exotix_user_'+userId, JSON.stringify(userData));
        }
      }
      usdtBalance = userData.usdtBalance||0;
      exvBalance = userData.exvBalance||0;
      purchasedPlans = userData.purchasedPlans||{};
      activeTrades = userData.activeTrades||{};
      depositHistory = userData.depositHistory||[];
      withdrawHistory = userData.withdrawHistory||[];
      tradeHistory = userData.tradeHistory||[];
      tokenWithdrawHistory = userData.tokenWithdrawHistory||[];
      exvDepositHistory = userData.exvDepositHistory||[];
      microtaskEarnings = userData.microtaskEarnings||0;
      userTaskCount = userData.userTaskCount||0;
      submittedTasks = userData.submittedTasks||{};
      document.getElementById('usdtBalance').textContent = fmt(usdtBalance);
      document.getElementById('exvBalance').textContent = exvBalance;

      // Process referral if applicable
      processReferral().then(() => {
        updateLoadingProgress('Starting app...');
        
        setTimeout(() => {
          document.getElementById('loading-screen').style.display = 'none';
          document.getElementById('app').style.display = 'block';
        }, 1000);
        
        // Setup listeners
        setupReferralListener();
        setupStatusListeners();
        setupBalanceListener();
        setupUserDataListener();
        
        // Check if daily commission report should be sent
        database.ref('admin/lastCommissionReport').once('value').then(snap => {
          const lastReport = snap.val() || 0;
          const currentTime = now();
          const hoursSinceLastReport = (currentTime - lastReport) / 3600;
          
          if (hoursSinceLastReport >= 24) {
            sendDailyCommissionReport();
          }
        });
        
        showTab('home');
        setInterval(loadCryptoPrices, 30000);
      });
    }

    bootstrap();
  </script>
</body>
</html>
